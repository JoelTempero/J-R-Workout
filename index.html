<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>J&R Workout</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg-dark: #1a1a2e; --bg-card: #16213e; --bg-input: #0f0f23; --joel-primary: #7c3aed; --joel-secondary: #a78bfa; --rachel-primary: #06b6d4; --rachel-secondary: #67e8f9; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --text-primary: #f1f5f9; --text-secondary: #94a3b8; --text-muted: #64748b; --ring-bg: #2d2d4a; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        body { font-family: 'Nunito', sans-serif; background: var(--bg-dark); color: var(--text-primary); min-height: 100vh; min-height: 100dvh; overflow-x: hidden; }
        input, textarea, select { -webkit-user-select: auto; user-select: auto; }
        .hidden { display: none !important; }
        button { min-height: 44px; min-width: 44px; touch-action: manipulation; cursor: pointer; }
        .pin-screen { position: fixed; inset: 0; background: var(--bg-dark); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; padding: 2rem; }
        .pin-logo { font-family: 'Fredoka', sans-serif; font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; background: linear-gradient(135deg, var(--joel-primary), var(--rachel-primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .pin-subtitle { color: var(--text-secondary); margin-bottom: 2rem; }
        .pin-dots { display: flex; gap: 1rem; margin-bottom: 2rem; }
        .pin-dot { width: 18px; height: 18px; border-radius: 50%; background: var(--bg-input); border: 2px solid var(--text-muted); transition: all 0.2s; }
        .pin-dot.filled { background: var(--success); border-color: var(--success); }
        .pin-dot.error { background: var(--danger); border-color: var(--danger); animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .pin-keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        .pin-key { width: 75px; height: 75px; border-radius: 50%; border: none; background: var(--bg-card); color: var(--text-primary); font-size: 1.5rem; font-weight: 600; font-family: 'Nunito', sans-serif; }
        .pin-key:active { transform: scale(0.95); background: var(--bg-input); }
        .pin-key.empty { visibility: hidden; }
        .app { display: none; flex-direction: column; min-height: 100vh; min-height: 100dvh; padding-bottom: 90px; }
        .app.active { display: flex; }
        .header { padding: 1rem 1.5rem; display: flex; align-items: center; background: var(--bg-card); border-bottom: 1px solid rgba(255,255,255,0.05); position: sticky; top: 0; z-index: 50; }
        .header-left { display: flex; align-items: center; gap: 0.75rem; }
        .header-icon { font-size: 1.5rem; }
        .header-title { font-family: 'Fredoka', sans-serif; font-size: 1.25rem; font-weight: 600; }
        .header-date { color: var(--text-secondary); font-size: 0.875rem; }
        .page { display: none; flex: 1; padding: 1rem; overflow-y: auto; }
        .page.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: var(--bg-card); border-radius: 16px; padding: 1.25rem; margin-bottom: 1rem; }
        .card-title { font-family: 'Fredoka', sans-serif; font-size: 1.1rem; margin-bottom: 1rem; }
        .workout-log-item { background: var(--bg-input); border-radius: 12px; padding: 1rem; margin-bottom: 0.75rem; display: flex; align-items: flex-start; gap: 1rem; }
        .workout-log-item.joel { border-left: 4px solid var(--joel-primary); }
        .workout-log-item.rachel { border-left: 4px solid var(--rachel-primary); }
        .workout-log-icon { font-size: 1.75rem; width: 44px; text-align: center; }
        .workout-log-details { flex: 1; min-width: 0; }
        .workout-log-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.35rem; flex-wrap: wrap; }
        .workout-log-title { font-family: 'Fredoka', sans-serif; font-weight: 700; font-size: 1.25rem; }
        .workout-log-profile { font-size: 0.65rem; padding: 0.2rem 0.5rem; border-radius: 10px; font-weight: 700; }
        .workout-log-profile.joel { background: var(--joel-primary); color: white; }
        .workout-log-profile.rachel { background: var(--rachel-primary); color: white; }
        .workout-log-meta { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; }
        .workout-log-summary { font-size: 1rem; color: var(--text-secondary); line-height: 1.6; }
        .workout-log-summary strong { color: var(--text-primary); font-weight: 700; }
        .workout-log-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
        .workout-log-actions button { width: 44px; height: 44px; border-radius: 50%; border: none; background: var(--bg-card); color: var(--text-secondary); font-size: 1.1rem; display: flex; align-items: center; justify-content: center; }
        .workout-log-actions button:active { background: var(--bg-dark); }
        .empty-state { text-align: center; padding: 3rem 1rem; color: var(--text-muted); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }
        .fab { position: fixed; bottom: 105px; right: 1.5rem; width: 64px; height: 64px; border-radius: 50%; border: none; background: var(--success); color: white; font-size: 2.25rem; box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4); z-index: 90; display: flex; align-items: center; justify-content: center; }
        .fab:active { transform: scale(0.95); }
        .log-options-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: flex-end; z-index: 200; }
        .log-options-modal.active { display: flex; }
        .log-options-content { background: var(--bg-card); width: 100%; border-radius: 24px 24px 0 0; padding: 1.5rem; padding-bottom: max(1.5rem, env(safe-area-inset-bottom)); max-height: 80vh; overflow-y: auto; }
        .log-options-title { font-family: 'Fredoka', sans-serif; font-size: 1.25rem; text-align: center; margin-bottom: 1.5rem; }
        .log-option-btn { display: flex; align-items: center; gap: 1rem; width: 100%; padding: 1rem; background: var(--bg-input); border: none; border-radius: 12px; color: var(--text-primary); font-family: 'Nunito', sans-serif; font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem; }
        .log-option-btn:active { background: var(--bg-card); }
        .log-option-btn .icon { font-size: 1.5rem; width: 44px; text-align: center; }
        .log-option-close { width: 100%; padding: 1rem; margin-top: 0.5rem; background: transparent; border: 2px solid var(--text-muted); border-radius: 12px; color: var(--text-secondary); font-family: 'Fredoka', sans-serif; font-size: 1rem; }
        .log-page { position: fixed; inset: 0; background: var(--bg-dark); display: none; flex-direction: column; z-index: 300; overflow-y: auto; }
        .log-page.active { display: flex; }
        .log-page-header { padding: 1rem 1.5rem; display: flex; align-items: center; gap: 1rem; background: var(--bg-card); position: sticky; top: 0; z-index: 10; }
        .log-page-back { width: 44px; height: 44px; border-radius: 50%; border: none; background: var(--bg-input); color: var(--text-primary); font-size: 1.25rem; display: flex; align-items: center; justify-content: center; }
        .log-page-title { font-family: 'Fredoka', sans-serif; font-size: 1.25rem; flex: 1; }
        .log-page-content { flex: 1; padding: 1rem; padding-bottom: 100px; }
        .profile-toggle { display: flex; gap: 0.5rem; background: var(--bg-input); border-radius: 12px; padding: 0.5rem; }
        .profile-toggle-btn { flex: 1; padding: 0.75rem; border: 2px solid transparent; border-radius: 8px; background: transparent; color: var(--text-muted); font-family: 'Fredoka', sans-serif; font-size: 1rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .profile-toggle-btn.active.joel { border-color: var(--joel-primary); color: var(--joel-secondary); background: rgba(124, 58, 237, 0.1); }
        .profile-toggle-btn.active.rachel { border-color: var(--rachel-primary); color: var(--rachel-secondary); background: rgba(6, 182, 212, 0.1); }
        .datetime-row { display: flex; gap: 0.75rem; margin-bottom: 1rem; }
        .datetime-input { flex: 1; background: var(--bg-input); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 0.875rem 1rem; color: var(--text-primary); font-family: 'Nunito', sans-serif; font-size: 1rem; min-height: 50px; }
        .datetime-input:focus { outline: none; border-color: var(--success); }
        .exercise-item { background: var(--bg-input); border-radius: 12px; padding: 1rem; margin-bottom: 0.75rem; }
        .exercise-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; }
        .exercise-name { font-weight: 700; }
        .exercise-toggle { width: 54px; height: 30px; border-radius: 15px; background: var(--ring-bg); border: none; position: relative; transition: background 0.2s; }
        .exercise-toggle.active { background: var(--success); }
        .exercise-toggle::after { content: ''; position: absolute; width: 24px; height: 24px; border-radius: 50%; background: white; top: 3px; left: 3px; transition: transform 0.2s; }
        .exercise-toggle.active::after { transform: translateX(24px); }
        .exercise-inputs { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .exercise-inputs.disabled { opacity: 0.4; pointer-events: none; }
        .input-group { display: flex; flex-direction: column; gap: 0.25rem; }
        .input-group label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; }
        .input-group input { width: 70px; background: var(--bg-card); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 0.5rem; color: var(--text-primary); font-family: 'Nunito', sans-serif; font-size: 1rem; text-align: center; min-height: 44px; }
        .input-group input:focus { outline: none; border-color: var(--success); }
        .simple-input-row { display: flex; align-items: center; gap: 1rem; background: var(--bg-input); border-radius: 12px; padding: 1rem; }
        .simple-input-row .icon { font-size: 1.5rem; }
        .simple-input-row label { flex: 1; font-weight: 600; }
        .simple-input-row input { width: 100px; background: var(--bg-card); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 0.75rem; color: var(--text-primary); font-family: 'Nunito', sans-serif; font-size: 1.1rem; text-align: center; min-height: 50px; }
        .simple-input-row input:focus { outline: none; border-color: var(--success); }
        .simple-input-row .unit { color: var(--text-muted); width: 40px; }
        .submit-btn { position: fixed; bottom: 0; left: 0; right: 0; padding: 1rem; padding-bottom: max(1rem, env(safe-area-inset-bottom)); background: var(--bg-card); }
        .submit-btn button { width: 100%; padding: 1rem; border: none; border-radius: 12px; font-family: 'Fredoka', sans-serif; font-size: 1.1rem; font-weight: 600; min-height: 56px; }
        .submit-btn button.joel { background: linear-gradient(135deg, var(--joel-primary), #9333ea); color: white; }
        .submit-btn button.rachel { background: linear-gradient(135deg, var(--rachel-primary), #0891b2); color: white; }
        .submit-btn button:active { transform: scale(0.98); }
        .calendar-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
        .calendar-nav button { background: var(--bg-input); border: none; color: var(--text-primary); width: 44px; height: 44px; border-radius: 50%; font-size: 1.25rem; display: flex; align-items: center; justify-content: center; }
        .calendar-nav button:active { background: var(--bg-card); }
        .calendar-month { font-family: 'Fredoka', sans-serif; font-size: 1.25rem; }
        .calendar-filter { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .calendar-filter button { padding: 0.5rem 0.75rem; border: 2px solid var(--text-muted); border-radius: 20px; background: transparent; color: var(--text-secondary); font-family: 'Nunito', sans-serif; font-weight: 600; font-size: 0.75rem; }
        .calendar-filter button.active { border-color: var(--success); background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; margin-bottom: 0.5rem; }
        .calendar-weekdays span { color: var(--text-muted); font-size: 0.75rem; font-weight: 600; padding: 0.5rem 0; }
        .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem; }
        .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0.15rem; }
        .calendar-day .date { font-size: 0.75rem; font-weight: 600; margin-bottom: 0.1rem; }
        .calendar-day.empty .date { color: var(--text-muted); opacity: 0.3; }
        .calendar-day.today .date { color: var(--success); font-weight: 800; }
        .calendar-day .indicator-circle { width: 28px; height: 28px; position: relative; }
        .calendar-day .half-left, .calendar-day .half-right { position: absolute; width: 14px; height: 28px; top: 0; }
        .calendar-day .half-left { left: 0; border-radius: 28px 0 0 28px; }
        .calendar-day .half-right { right: 0; border-radius: 0 28px 28px 0; }
        .calendar-day .half-left.joel { background: var(--joel-primary); }
        .calendar-day .half-right.rachel { background: var(--rachel-primary); }
        .calendar-legend { display: flex; gap: 1rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.05); justify-content: center; }
        .legend-item { display: flex; align-items: center; gap: 0.35rem; font-size: 0.8rem; color: var(--text-secondary); }
        .legend-half { width: 14px; height: 14px; border-radius: 7px; }
        .time-filter { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .time-filter button { flex: 1; padding: 0.625rem; border: none; border-radius: 8px; background: var(--bg-input); color: var(--text-secondary); font-family: 'Nunito', sans-serif; font-weight: 600; font-size: 0.875rem; }
        .time-filter button.active { background: var(--success); color: white; }
        .chart-container { height: 220px; margin: 1rem 0; }
        .chart-canvas { width: 100%; height: 100%; }
        .exercise-selector select { width: 100%; padding: 0.75rem 1rem; background: var(--bg-input); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: var(--text-primary); font-family: 'Nunito', sans-serif; font-size: 1rem; min-height: 50px; margin-bottom: 1rem; }
        .exercise-selector select:focus { outline: none; border-color: var(--success); }
        .metric-toggles { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .metric-toggle { padding: 0.5rem 1rem; border: 2px solid var(--text-muted); border-radius: 20px; background: transparent; color: var(--text-secondary); font-family: 'Nunito', sans-serif; font-weight: 600; font-size: 0.8rem; }
        .metric-toggle.active { border-color: var(--success); background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-card); border-top: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-around; padding: 0.5rem 0; padding-bottom: max(0.5rem, env(safe-area-inset-bottom)); z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 0.2rem; padding: 0.5rem 0.5rem; border: none; background: none; color: var(--text-muted); font-family: 'Nunito', sans-serif; font-size: 0.65rem; font-weight: 600; min-width: 56px; }
        .nav-item .icon { font-size: 1.3rem; }
        .nav-item.active { color: var(--success); }
        .toast { position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--success); color: white; padding: 1rem 1.5rem; border-radius: 12px; font-weight: 600; opacity: 0; transition: all 0.3s; z-index: 400; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.error { background: var(--danger); }
        .sync-status { position: fixed; top: 0; left: 0; right: 0; height: 3px; z-index: 500; }
        .sync-status.syncing { background: linear-gradient(90deg, transparent, var(--success), transparent); animation: syncPulse 1.5s infinite; }
        @keyframes syncPulse { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 500; padding: 1rem; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-card); border-radius: 20px; padding: 1.5rem; width: 100%; max-width: 400px; max-height: 85vh; overflow-y: auto; }
        .modal-title { font-family: 'Fredoka', sans-serif; font-size: 1.25rem; margin-bottom: 1.5rem; text-align: center; }
        .modal-section { margin-bottom: 1.5rem; }
        .modal-section-title { font-weight: 700; font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.75rem; text-transform: uppercase; }
        .modal-input { width: 100%; background: var(--bg-input); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 0.875rem 1rem; color: var(--text-primary); font-family: 'Nunito', sans-serif; font-size: 1rem; margin-bottom: 0.75rem; min-height: 50px; }
        .modal-input:focus { outline: none; border-color: var(--success); }
        .modal-buttons { display: flex; gap: 0.75rem; }
        .modal-btn { flex: 1; padding: 0.875rem; border: none; border-radius: 12px; font-family: 'Fredoka', sans-serif; font-weight: 600; min-height: 50px; }
        .modal-btn.cancel { background: var(--bg-input); color: var(--text-secondary); }
        .modal-btn.save { background: var(--success); color: white; }
        .modal-btn.danger { background: var(--danger); color: white; }
        .modal-btn:active { transform: scale(0.98); }
        .confirm-text { text-align: center; margin-bottom: 1.5rem; color: var(--text-secondary); }
        .settings-tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .settings-tab { flex: 1; padding: 0.6rem; border: none; border-radius: 8px; background: var(--bg-input); color: var(--text-secondary); font-family: 'Nunito', sans-serif; font-weight: 600; font-size: 0.8rem; }
        .settings-tab.active { background: var(--success); color: white; }
        .settings-panel { display: none; }
        .settings-panel.active { display: block; }
        .settings-profile-toggle { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .settings-profile-btn { flex: 1; padding: 0.75rem; border: 2px solid var(--text-muted); border-radius: 8px; background: transparent; color: var(--text-muted); font-family: 'Fredoka', sans-serif; font-size: 0.9rem; }
        .settings-profile-btn.active.joel { border-color: var(--joel-primary); color: var(--joel-secondary); background: rgba(124, 58, 237, 0.1); }
        .settings-profile-btn.active.rachel { border-color: var(--rachel-primary); color: var(--rachel-secondary); background: rgba(6, 182, 212, 0.1); }
        .base-setting-row { display: flex; align-items: center; justify-content: space-between; padding: 0.6rem; background: var(--bg-input); border-radius: 8px; margin-bottom: 0.4rem; }
        .base-setting-row label { font-size: 0.8rem; flex: 1; }
        .base-setting-row input { width: 55px; background: var(--bg-card); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 0.4rem; color: var(--text-primary); font-family: 'Nunito', sans-serif; font-size: 0.8rem; text-align: center; }
        .base-settings-group { margin-bottom: 1rem; }
        .base-settings-group-title { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.4rem; }
    </style>
</head>
<body>
    <div class="sync-status" id="syncStatus"></div>
    <div class="pin-screen" id="pinScreen">
        <div class="pin-logo">J&R Workout</div>
        <div class="pin-subtitle">Enter PIN to continue</div>
        <div class="pin-dots" id="pinDots"><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div></div>
        <div class="pin-keypad">
            <button class="pin-key" data-num="1">1</button><button class="pin-key" data-num="2">2</button><button class="pin-key" data-num="3">3</button>
            <button class="pin-key" data-num="4">4</button><button class="pin-key" data-num="5">5</button><button class="pin-key" data-num="6">6</button>
            <button class="pin-key" data-num="7">7</button><button class="pin-key" data-num="8">8</button><button class="pin-key" data-num="9">9</button>
            <button class="pin-key empty"></button><button class="pin-key" data-num="0">0</button><button class="pin-key" data-action="back">‚å´</button>
        </div>
    </div>
    <div class="app" id="app">
        <header class="header"><div class="header-left"><span class="header-icon">üí™</span><div><div class="header-title">J&R Workout</div><div class="header-date" id="headerDate"></div></div></div></header>
        <div class="page active" id="pageWorkouts"><div class="card"><div class="card-title">üìã Workouts</div><div id="workoutsList"><div class="empty-state"><div class="empty-state-icon">üèãÔ∏è</div><p>No workouts logged yet</p></div></div></div></div>
        <div class="page" id="pageCalendar"><div class="card">
            <div class="calendar-nav"><button id="prevMonth">‚Äπ</button><span class="calendar-month" id="calendarMonth"></span><button id="nextMonth">‚Ä∫</button></div>
            <div class="calendar-filter" id="calendarFilter"><button data-filter="all" class="active">All</button><button data-filter="sidon">üêï</button><button data-filter="steps">üëü</button><button data-filter="upper">üí™</button><button data-filter="lower">ü¶µ</button><button data-filter="core">üéØ</button><button data-filter="weight">‚öñÔ∏è</button></div>
            <div class="calendar-weekdays"><span>S</span><span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span></div>
            <div class="calendar-days" id="calendarDays"></div>
            <div class="calendar-legend"><div class="legend-item"><div class="legend-half" style="background:var(--joel-primary)"></div><span>Joel</span></div><div class="legend-item"><div class="legend-half" style="background:var(--rachel-primary)"></div><span>Rachel</span></div></div>
        </div></div>
        <div class="page" id="pageStats"><div class="card">
            <div class="card-title">üìà Progress</div>
            <div class="time-filter" id="timeFilter"><button data-range="week" class="active">Week</button><button data-range="month">Month</button><button data-range="year">Year</button><button data-range="all">All</button></div>
            <div class="exercise-selector"><select id="exerciseSelect">
                <option value="bodyWeight">‚öñÔ∏è Body Weight</option><option value="steps">üëü Step Count</option><option value="sidon">üêï Sidon Walk</option>
                <optgroup label="üí™ Upper Body"><option value="pushups">Pushups</option><option value="tricepDips">Tricep Dips</option><option value="latPulldowns">Lat Pulldowns</option><option value="tricepPulldowns">Tricep Pulldowns</option><option value="bicepCurls">Bicep Curls</option><option value="lateralRaises">Lateral Raises</option></optgroup>
                <optgroup label="ü¶µ Lower Body"><option value="weightedSquats">Weighted Squats</option><option value="jumpingLunges">Jumping Lunges</option><option value="deadlifts">Deadlifts</option><option value="hipThrusts">Hip Thrusts</option><option value="weightedStepUps">Weighted Step Ups</option><option value="calfRaises">Calf Raises</option></optgroup>
                <optgroup label="üéØ Core"><option value="rotatingPlank">Rotating Plank</option><option value="vSitTwists">V-Sit Twists</option><option value="mountainClimbers">Mountain Climbers</option><option value="situps">Situps</option></optgroup>
            </select></div>
            <div class="metric-toggles" id="metricToggles"><button class="metric-toggle active" data-metric="weight">Weight</button><button class="metric-toggle" data-metric="reps">Reps</button><button class="metric-toggle" data-metric="sets">Sets</button></div>
            <div class="chart-container"><canvas class="chart-canvas" id="statsChart"></canvas></div>
            <div class="calendar-legend"><div class="legend-item"><div class="legend-half" style="background:var(--joel-primary)"></div><span>Joel</span></div><div class="legend-item"><div class="legend-half" style="background:var(--rachel-primary)"></div><span>Rachel</span></div></div>
        </div></div>
        <div class="page" id="pageRewards"><div class="card"><div class="card-title">üèÜ Rewards</div><p style="color:var(--text-muted);text-align:center;padding:2rem;">Coming soon!</p></div></div>
        <button class="fab" id="fabBtn">+</button>
        <nav class="bottom-nav">
            <button class="nav-item active" data-page="pageWorkouts"><span class="icon">üè†</span><span>Workouts</span></button>
            <button class="nav-item" data-page="pageCalendar"><span class="icon">üìÖ</span><span>Calendar</span></button>
            <button class="nav-item" data-page="pageStats"><span class="icon">üìä</span><span>Stats</span></button>
            <button class="nav-item" data-page="pageRewards"><span class="icon">üèÜ</span><span>Rewards</span></button>
            <button class="nav-item" id="settingsBtn"><span class="icon">‚öôÔ∏è</span><span>Settings</span></button>
        </nav>
    </div>
    <div class="log-options-modal" id="logOptionsModal"><div class="log-options-content">
        <div class="log-options-title">What are you logging?</div>
        <button class="log-option-btn" data-log="sidon"><span class="icon">üêï</span> Sidon Walk</button>
        <button class="log-option-btn" data-log="steps"><span class="icon">üëü</span> Step Count</button>
        <button class="log-option-btn" data-log="upper"><span class="icon">üí™</span> Upper Body</button>
        <button class="log-option-btn" data-log="lower"><span class="icon">ü¶µ</span> Lower Body</button>
        <button class="log-option-btn" data-log="core"><span class="icon">üéØ</span> Core</button>
        <button class="log-option-btn" data-log="custom"><span class="icon">‚ö°</span> Custom Workout</button>
        <button class="log-option-btn" data-log="weight"><span class="icon">‚öñÔ∏è</span> Log Weight</button>
        <button class="log-option-close" id="closeLogOptions">Cancel</button>
    </div></div>
    <div id="logPages"></div>
    <div class="toast" id="toast"></div>
    <div class="modal-overlay" id="settingsModal"><div class="modal">
        <div class="modal-title">‚öôÔ∏è Settings</div>
        <div class="settings-tabs"><button class="settings-tab active" data-tab="general">General</button><button class="settings-tab" data-tab="base">Base Settings</button></div>
        <div class="settings-panel active" id="panelGeneral"><div class="modal-section"><div class="modal-section-title">GitHub Token</div><input type="password" class="modal-input" id="patInput" placeholder="ghp_xxxx"><p style="font-size:0.7rem;color:var(--text-muted);">GitHub ‚Üí Settings ‚Üí Developer settings ‚Üí Fine-grained tokens</p></div></div>
        <div class="settings-panel" id="panelBase">
            <div class="settings-profile-toggle"><button class="settings-profile-btn joel active" data-profile="joel">üí™ Joel</button><button class="settings-profile-btn rachel" data-profile="rachel">‚ú® Rachel</button></div>
            <div id="baseSettingsContent"></div>
        </div>
        <div class="modal-buttons"><button class="modal-btn cancel" id="cancelSettings">Cancel</button><button class="modal-btn save" id="saveSettings">Save</button></div>
    </div></div>
    <div class="modal-overlay" id="deleteModal"><div class="modal">
        <div class="modal-title">üóëÔ∏è Delete Workout</div>
        <p class="confirm-text">Are you sure?</p>
        <div class="modal-buttons"><button class="modal-btn cancel" id="cancelDelete">Cancel</button><button class="modal-btn danger" id="confirmDelete">Delete</button></div>
    </div></div>
<script>
const CONFIG={PIN:'9743',REPO_OWNER:'',REPO_NAME:'J-R-Workout',DATA_FILE:'data/workouts.json'};
const DEFAULT_BASE={rachel:{sidonMins:10,steps:15000,upper:{pushups:{s:3,r:5,w:null,on:1},tricepDips:{s:3,r:5,w:null,on:1},latPulldowns:{s:3,r:10,w:30,on:1},tricepPulldowns:{s:3,r:10,w:10,on:1},bicepCurls:{s:3,r:10,w:7,on:1},lateralRaises:{s:3,r:10,w:3,on:1}},lower:{weightedSquats:{s:3,r:10,w:7,on:1},jumpingLunges:{s:3,r:10,w:null,on:1},deadlifts:{s:3,r:10,w:14,on:1},hipThrusts:{s:3,r:10,w:7,on:1},weightedStepUps:{s:3,r:10,w:7,on:1},calfRaises:{s:3,r:15,w:null,on:1}},core:{rotatingPlank:{s:3,m:2,on:1},vSitTwists:{s:3,r:10,w:null,on:1},mountainClimbers:{s:3,r:20,w:null,on:1},situps:{s:3,r:15,w:null,on:1}}},joel:{sidonMins:10,steps:9000,upper:{pushups:{s:3,r:5,w:null,on:1},tricepDips:{s:3,r:5,w:null,on:1},latPulldowns:{s:3,r:10,w:30,on:1},tricepPulldowns:{s:3,r:10,w:10,on:1},bicepCurls:{s:3,r:10,w:7,on:1},lateralRaises:{s:3,r:10,w:3,on:1}},lower:{weightedSquats:{s:3,r:10,w:7,on:1},jumpingLunges:{s:3,r:10,w:null,on:1},deadlifts:{s:3,r:10,w:14,on:1},hipThrusts:{s:3,r:10,w:7,on:1},weightedStepUps:{s:3,r:10,w:7,on:1},calfRaises:{s:3,r:15,w:null,on:1}},core:{rotatingPlank:{s:3,m:2,on:1},vSitTwists:{s:3,r:10,w:null,on:1},mountainClimbers:{s:3,r:20,w:null,on:1},situps:{s:3,r:15,w:null,on:1}}}};
const EX_NAMES={pushups:'Pushups',tricepDips:'Tricep Dips',latPulldowns:'Lat Pulldowns',tricepPulldowns:'Tricep Pulldowns',bicepCurls:'Bicep Curls',lateralRaises:'Lateral Raises',weightedSquats:'Weighted Squats',jumpingLunges:'Jumping Lunges',deadlifts:'Deadlifts',hipThrusts:'Hip Thrusts',weightedStepUps:'Weighted Step Ups',calfRaises:'Calf Raises',rotatingPlank:'Rotating Plank',vSitTwists:'V-Sit Twists',mountainClimbers:'Mountain Climbers',situps:'Situps'};
let state={pin:'',data:{workouts:[],base:JSON.parse(JSON.stringify(DEFAULT_BASE))},month:new Date(),calFilter:'all',chartRange:'week',chartExercise:'bodyWeight',chartMetrics:{weight:true,reps:false,sets:false},pat:localStorage.getItem('github_pat')||'',deleteId:null,logProfile:'joel',settingsProfile:'joel'};
const $=id=>document.getElementById(id),$$=sel=>document.querySelectorAll(sel),genId=()=>Date.now().toString(36)+Math.random().toString(36).substr(2);
const fmtDate=d=>new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric'});
const fmtTime=t=>{const[h,m]=t.split(':');const hr=parseInt(h);return`${hr%12||12}:${m} ${hr>=12?'PM':'AM'}`;};
const getIcon=t=>({sidon:'üêï',steps:'üëü',upper:'üí™',lower:'ü¶µ',core:'üéØ',custom:'‚ö°',weight:'‚öñÔ∏è'})[t]||'üèãÔ∏è';
const getTitle=t=>({sidon:'Sidon Walk',steps:'Step Count',upper:'Upper Body',lower:'Lower Body',core:'Core',custom:'Custom',weight:'Weight Log'})[t]||'Workout';

function updateDots(){$$('#pinDots .pin-dot').forEach((d,i)=>d.classList.toggle('filled',i<state.pin.length));}
function pinInput(n){if(state.pin.length<4){state.pin+=n;updateDots();if(state.pin.length===4){setTimeout(()=>{if(state.pin===CONFIG.PIN){$('pinScreen').classList.add('hidden');$('app').classList.add('active');localStorage.setItem('pin_verified','true');loadData();}else{$$('#pinDots .pin-dot').forEach(d=>d.classList.add('error'));setTimeout(()=>{state.pin='';$$('#pinDots .pin-dot').forEach(d=>d.classList.remove('error','filled'));},500);}},200);}}}
$$('.pin-key').forEach(k=>k.addEventListener('click',()=>{if(k.dataset.num!==undefined)pinInput(k.dataset.num);else if(k.dataset.action==='back'){state.pin=state.pin.slice(0,-1);updateDots();}}));
function setDate(){$('headerDate').textContent=new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});}
$$('.nav-item[data-page]').forEach(n=>n.addEventListener('click',()=>{const p=n.dataset.page;$$('.page').forEach(x=>x.classList.remove('active'));$(p).classList.add('active');$$('.nav-item').forEach(x=>x.classList.remove('active'));n.classList.add('active');if(p==='pageCalendar')renderCal();if(p==='pageStats')renderChart();if(p==='pageWorkouts')renderList();}));

async function loadData(){if(!state.pat)return;$('syncStatus').classList.add('syncing');try{const u=await fetch('https://api.github.com/user',{headers:{'Authorization':`Bearer ${state.pat}`}});if(u.ok)CONFIG.REPO_OWNER=(await u.json()).login;const r=await fetch(`https://api.github.com/repos/${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}/contents/${CONFIG.DATA_FILE}`,{headers:{'Authorization':`Bearer ${state.pat}`}});if(r.ok){const d=await r.json();state.data=JSON.parse(atob(d.content));}}catch(e){console.error(e);}$('syncStatus').classList.remove('syncing');renderList();}
async function saveData(){if(!state.pat||!CONFIG.REPO_OWNER){showToast('Configure GitHub token',true);return false;}$('syncStatus').classList.add('syncing');try{const g=await fetch(`https://api.github.com/repos/${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}/contents/${CONFIG.DATA_FILE}`,{headers:{'Authorization':`Bearer ${state.pat}`}});let sha=g.ok?(await g.json()).sha:null;const body={message:`Update ${new Date().toISOString()}`,content:btoa(unescape(encodeURIComponent(JSON.stringify(state.data,null,2))))};if(sha)body.sha=sha;const s=await fetch(`https://api.github.com/repos/${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}/contents/${CONFIG.DATA_FILE}`,{method:'PUT',headers:{'Authorization':`Bearer ${state.pat}`,'Content-Type':'application/json'},body:JSON.stringify(body)});$('syncStatus').classList.remove('syncing');return s.ok;}catch(e){console.error(e);$('syncStatus').classList.remove('syncing');return false;}}
function showToast(msg,err=false){const t=$('toast');t.textContent=msg;t.classList.toggle('error',err);t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}

function formatExerciseDetails(exercises){if(!exercises)return'';return Object.entries(exercises).filter(([k,v])=>v.on).map(([k,v])=>{let d=`<strong>${EX_NAMES[k]}</strong>: ${v.s} sets`;if(v.m!==undefined)d+=` √ó ${v.m} mins`;else if(v.r!==undefined)d+=` √ó ${v.r} reps`;if(v.w)d+=` @ ${v.w}kg`;return d;}).join('<br>');}

function renderList(){const list=$('workoutsList');const w=(state.data.workouts||[]).sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));if(!w.length){list.innerHTML=`<div class="empty-state"><div class="empty-state-icon">üèãÔ∏è</div><p>No workouts logged yet</p></div>`;return;}
list.innerHTML=w.map(x=>{let summary='';if(x.type==='sidon')summary=`<strong>${x.minutes} mins</strong> walk with Sidon`;else if(x.type==='steps')summary=`<strong>${(x.steps||0).toLocaleString()} steps</strong>`;else if(x.type==='weight')summary=`<strong>${x.bodyWeight} kg</strong>`;else summary=formatExerciseDetails(x.exercises);return`<div class="workout-log-item ${x.profile}"><div class="workout-log-icon">${getIcon(x.type)}</div><div class="workout-log-details"><div class="workout-log-header"><span class="workout-log-title">${getTitle(x.type)}</span><span class="workout-log-profile ${x.profile}">${x.profile==='joel'?'Joel':'Rachel'}</span></div><div class="workout-log-meta">${fmtDate(x.date)} at ${fmtTime(x.time)}</div><div class="workout-log-summary">${summary}</div></div><div class="workout-log-actions"><button onclick="editW('${x.id}')">‚úèÔ∏è</button><button onclick="deleteW('${x.id}')">üóëÔ∏è</button></div></div>`;}).join('');}

$('fabBtn').addEventListener('click',()=>$('logOptionsModal').classList.add('active'));
$('closeLogOptions').addEventListener('click',()=>$('logOptionsModal').classList.remove('active'));
$('logOptionsModal').addEventListener('click',e=>{if(e.target===$('logOptionsModal'))$('logOptionsModal').classList.remove('active');});
$$('.log-option-btn').forEach(b=>b.addEventListener('click',()=>{$('logOptionsModal').classList.remove('active');openLog(b.dataset.log);}));

function openLog(type,edit=null){const c=$('logPages');const now=new Date();const dateVal=edit?.date||now.toISOString().split('T')[0];const timeVal=edit?.time||now.toTimeString().slice(0,5);state.logProfile=edit?.profile||'joel';const base=state.data.base?.[state.logProfile]||DEFAULT_BASE[state.logProfile];
let content=`<div class="card"><div class="card-title">üë§ Who's logging?</div><div class="profile-toggle"><button class="profile-toggle-btn joel ${state.logProfile==='joel'?'active':''}" data-profile="joel">üí™ Joel</button><button class="profile-toggle-btn rachel ${state.logProfile==='rachel'?'active':''}" data-profile="rachel">‚ú® Rachel</button></div></div><div class="card"><div class="card-title">üìÖ Date & Time</div><div class="datetime-row"><input type="date" class="datetime-input" id="logDate" value="${dateVal}"><input type="time" class="datetime-input" id="logTime" value="${timeVal}"></div></div>`;
if(type==='sidon')content+=`<div class="card"><div class="card-title">üêï Walk Duration</div><div class="simple-input-row"><span class="icon">‚è±Ô∏è</span><label>Minutes</label><input type="number" id="sidonMins" value="${edit?.minutes||base.sidonMins||10}"><span class="unit">mins</span></div></div>`;
else if(type==='steps')content+=`<div class="card"><div class="card-title">üëü Steps</div><div class="simple-input-row"><span class="icon">üë£</span><label>Step count</label><input type="number" id="stepCount" value="${edit?.steps||base.steps||15000}"><span class="unit">steps</span></div></div>`;
else if(type==='weight')content+=`<div class="card"><div class="card-title">‚öñÔ∏è Body Weight</div><div class="simple-input-row"><span class="icon">üßç</span><label>Weight</label><input type="number" id="bodyWeight" step="0.1" value="${edit?.bodyWeight||''}" placeholder="0.0"><span class="unit">kg</span></div></div>`;
else if(['upper','lower','core'].includes(type)){const exs=base[type]||DEFAULT_BASE[state.logProfile][type];const editEx=edit?.exercises||{};content+=`<div class="card"><div class="card-title">${getIcon(type)} Exercises</div><div id="exerciseList">${renderExercises(exs,editEx,false)}</div></div>`;}
else if(type==='custom'){const allEx={...(base.upper||DEFAULT_BASE[state.logProfile].upper),...(base.lower||DEFAULT_BASE[state.logProfile].lower),...(base.core||DEFAULT_BASE[state.logProfile].core)};const editEx=edit?.exercises||{};content+=`<div class="card"><div class="card-title">‚ö° Custom</div><div id="exerciseList">${renderExercises(allEx,editEx,true)}</div></div>`;}
c.innerHTML=`<div class="log-page active" id="logPage_${type}"><div class="log-page-header"><button class="log-page-back" onclick="closeLog('${type}')">‚Üê</button><div class="log-page-title">${edit?'Edit':'Log'} ${getTitle(type)}</div></div><div class="log-page-content">${content}</div><div class="submit-btn"><button class="${state.logProfile}" id="submitLogBtn" onclick="submitLog('${type}',${edit?`'${edit.id}'`:'null'})">${edit?'Update':'Log'} ${getTitle(type)} üéâ</button></div></div>`;
c.querySelectorAll('.profile-toggle-btn').forEach(btn=>{btn.addEventListener('click',()=>{c.querySelectorAll('.profile-toggle-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');state.logProfile=btn.dataset.profile;$('submitLogBtn').className=state.logProfile;if(['upper','lower','core','custom'].includes(type)){const newBase=state.data.base?.[state.logProfile]||DEFAULT_BASE[state.logProfile];let exs;if(type==='custom')exs={...(newBase.upper||DEFAULT_BASE[state.logProfile].upper),...(newBase.lower||DEFAULT_BASE[state.logProfile].lower),...(newBase.core||DEFAULT_BASE[state.logProfile].core)};else exs=newBase[type]||DEFAULT_BASE[state.logProfile][type];$('exerciseList').innerHTML=renderExercises(exs,{},type==='custom');attachToggleListeners();}});});
attachToggleListeners();}

function renderExercises(exs,editEx,startOff){return Object.entries(exs).map(([k,ex])=>{const ed=editEx[k]||{};const on=Object.keys(editEx).length>0?ed.on===1:(startOff?false:ex.on);return`<div class="exercise-item" data-ex="${k}"><div class="exercise-header"><span class="exercise-name">${EX_NAMES[k]}</span><button class="exercise-toggle ${on?'active':''}" data-k="${k}"></button></div><div class="exercise-inputs ${on?'':'disabled'}" data-k="${k}"><div class="input-group"><label>Sets</label><input type="number" data-f="s" value="${ed.s??ex.s}"></div>${ex.m!==undefined?`<div class="input-group"><label>Mins</label><input type="number" data-f="m" value="${ed.m??ex.m}"></div>`:`<div class="input-group"><label>Reps</label><input type="number" data-f="r" value="${ed.r??ex.r}"></div>`}${ex.w!=null?`<div class="input-group"><label>Kg</label><input type="number" data-f="w" step="0.5" value="${ed.w??ex.w}"></div>`:''}</div></div>`;}).join('');}
function attachToggleListeners(){const c=$('logPages');c.querySelectorAll('.exercise-toggle').forEach(t=>{t.onclick=()=>{t.classList.toggle('active');c.querySelector(`.exercise-inputs[data-k="${t.dataset.k}"]`).classList.toggle('disabled',!t.classList.contains('active'));};});}
window.closeLog=t=>{const p=$(`logPage_${t}`);if(p)p.remove();};
window.submitLog=async(type,editId)=>{const date=$('logDate').value,time=$('logTime').value;let w={id:editId||genId(),profile:state.logProfile,type,date,time,timestamp:new Date(`${date}T${time}`).toISOString()};if(type==='sidon')w.minutes=parseInt($('sidonMins').value)||0;else if(type==='steps')w.steps=parseInt($('stepCount').value)||0;else if(type==='weight')w.bodyWeight=parseFloat($('bodyWeight').value)||0;else{const exs={};document.querySelectorAll('.exercise-item').forEach(item=>{const k=item.dataset.ex,tog=item.querySelector('.exercise-toggle'),on=tog.classList.contains('active');if(!on)return;exs[k]={on:1};item.querySelectorAll('.exercise-inputs input').forEach(inp=>{const f=inp.dataset.f,v=f==='w'?parseFloat(inp.value):parseInt(inp.value);if(!isNaN(v))exs[k][f]=v;});});w.exercises=exs;}if(!state.data.workouts)state.data.workouts=[];if(editId){const i=state.data.workouts.findIndex(x=>x.id===editId);if(i!==-1)state.data.workouts[i]=w;}else state.data.workouts.push(w);const ok=await saveData();if(ok){showToast(editId?'Updated!':'Logged! üí™');closeLog(type);renderList();}else showToast('Failed to save',true);};
window.editW=id=>{const w=state.data.workouts.find(x=>x.id===id);if(w)openLog(w.type,w);};
window.deleteW=id=>{state.deleteId=id;$('deleteModal').classList.add('active');};
$('cancelDelete').addEventListener('click',()=>{$('deleteModal').classList.remove('active');state.deleteId=null;});
$('confirmDelete').addEventListener('click',async()=>{if(state.deleteId){state.data.workouts=state.data.workouts.filter(x=>x.id!==state.deleteId);if(await saveData()){showToast('Deleted');renderList();}else showToast('Failed',true);}$('deleteModal').classList.remove('active');state.deleteId=null;});

function renderCal(){const y=state.month.getFullYear(),m=state.month.getMonth();$('calendarMonth').textContent=state.month.toLocaleDateString('en-US',{month:'long',year:'numeric'});const first=new Date(y,m,1).getDay(),days=new Date(y,m+1,0).getDate(),today=new Date();let html='';for(let i=0;i<first;i++)html+='<div class="calendar-day empty"><span class="date"></span></div>';for(let d=1;d<=days;d++){const ds=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;const isToday=today.getFullYear()===y&&today.getMonth()===m&&today.getDate()===d;const dw=(state.data.workouts||[]).filter(w=>w.date===ds);let joelHas=false,rachelHas=false;if(state.calFilter==='all'){joelHas=dw.some(w=>w.profile==='joel');rachelHas=dw.some(w=>w.profile==='rachel');}else{const f=dw.filter(w=>w.type===state.calFilter);joelHas=f.some(w=>w.profile==='joel');rachelHas=f.some(w=>w.profile==='rachel');}let indicator='';if(joelHas||rachelHas)indicator=`<div class="indicator-circle">${joelHas?'<div class="half-left joel"></div>':'<div class="half-left"></div>'}${rachelHas?'<div class="half-right rachel"></div>':'<div class="half-right"></div>'}</div>`;html+=`<div class="calendar-day ${isToday?'today':''}"><span class="date">${d}</span>${indicator}</div>`;}$('calendarDays').innerHTML=html;}
$('prevMonth').addEventListener('click',()=>{state.month.setMonth(state.month.getMonth()-1);renderCal();});
$('nextMonth').addEventListener('click',()=>{state.month.setMonth(state.month.getMonth()+1);renderCal();});
$$('#calendarFilter button').forEach(b=>b.addEventListener('click',()=>{$$('#calendarFilter button').forEach(x=>x.classList.remove('active'));b.classList.add('active');state.calFilter=b.dataset.filter;renderCal();}));

$('exerciseSelect').addEventListener('change',()=>{state.chartExercise=$('exerciseSelect').value;updateMetricTogglesVisibility();renderChart();});
$$('#timeFilter button').forEach(b=>b.addEventListener('click',()=>{$$('#timeFilter button').forEach(x=>x.classList.remove('active'));b.classList.add('active');state.chartRange=b.dataset.range;renderChart();}));
$$('.metric-toggle').forEach(b=>b.addEventListener('click',()=>{b.classList.toggle('active');state.chartMetrics[b.dataset.metric]=b.classList.contains('active');renderChart();}));
function updateMetricTogglesVisibility(){const isSimple=['bodyWeight','steps','sidon'].includes(state.chartExercise);$('metricToggles').style.display=isSimple?'none':'flex';}
function renderChart(){const canvas=$('statsChart'),ctx=canvas.getContext('2d');const rect=canvas.parentElement.getBoundingClientRect();canvas.width=rect.width*2;canvas.height=rect.height*2;ctx.scale(2,2);const W=rect.width,H=rect.height,pad={t:20,r:20,b:30,l:50};ctx.clearRect(0,0,W,H);const now=new Date();let start;switch(state.chartRange){case'week':start=new Date(now-7*24*60*60*1000);break;case'month':start=new Date(now-30*24*60*60*1000);break;case'year':start=new Date(now-365*24*60*60*1000);break;default:start=new Date(0);}const ex=state.chartExercise;const isSimple=['bodyWeight','steps','sidon'].includes(ex);function getData(profile,metric){let ws=(state.data.workouts||[]).filter(w=>w.profile===profile&&new Date(w.timestamp)>=start);if(ex==='bodyWeight')return ws.filter(w=>w.type==='weight'&&w.bodyWeight).map(w=>({x:new Date(w.timestamp),y:w.bodyWeight}));if(ex==='steps')return ws.filter(w=>w.type==='steps'&&w.steps).map(w=>({x:new Date(w.timestamp),y:w.steps}));if(ex==='sidon')return ws.filter(w=>w.type==='sidon'&&w.minutes).map(w=>({x:new Date(w.timestamp),y:w.minutes}));return ws.filter(w=>w.exercises&&w.exercises[ex]).map(w=>{const e=w.exercises[ex];let v=0;if(metric==='weight')v=e.w||0;else if(metric==='reps')v=e.r||e.m||0;else if(metric==='sets')v=e.s||0;return{x:new Date(w.timestamp),y:v};}).filter(d=>d.y>0);}const series=[];const colors={joel:{weight:'#f59e0b',reps:'#7c3aed',sets:'#10b981'},rachel:{weight:'#fbbf24',reps:'#06b6d4',sets:'#67e8f9'}};if(isSimple){series.push({data:getData('joel','weight').sort((a,b)=>a.x-b.x),color:'#7c3aed'});series.push({data:getData('rachel','weight').sort((a,b)=>a.x-b.x),color:'#06b6d4'});}else{['weight','reps','sets'].forEach(metric=>{if(state.chartMetrics[metric]){series.push({data:getData('joel',metric).sort((a,b)=>a.x-b.x),color:colors.joel[metric]});series.push({data:getData('rachel',metric).sort((a,b)=>a.x-b.x),color:colors.rachel[metric],dash:[5,5]});}});}const allData=series.flatMap(s=>s.data);if(!allData.length){ctx.fillStyle='#64748b';ctx.font='14px Nunito';ctx.textAlign='center';ctx.fillText('No data yet',W/2,H/2);return;}const minY=Math.min(...allData.map(d=>d.y))*0.9||0;const maxY=Math.max(...allData.map(d=>d.y))*1.1||1;const cW=W-pad.l-pad.r,cH=H-pad.t-pad.b;const sx=x=>pad.l+(x-start)/(now-start)*cW;const sy=y=>pad.t+cH-(y-minY)/(maxY-minY)*cH;ctx.strokeStyle='#2d2d4a';ctx.lineWidth=1;for(let i=0;i<=4;i++){const y=pad.t+(cH/4)*i;ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(W-pad.r,y);ctx.stroke();ctx.fillStyle='#64748b';ctx.font='11px Nunito';ctx.textAlign='right';ctx.fillText((maxY-(maxY-minY)*(i/4)).toFixed(1),pad.l-8,y+4);}series.forEach(s=>{if(!s.data.length)return;ctx.strokeStyle=s.color;ctx.lineWidth=2.5;ctx.lineCap='round';ctx.lineJoin='round';if(s.dash)ctx.setLineDash(s.dash);else ctx.setLineDash([]);ctx.beginPath();s.data.forEach((d,i)=>{if(i===0)ctx.moveTo(sx(d.x),sy(d.y));else ctx.lineTo(sx(d.x),sy(d.y));});ctx.stroke();ctx.setLineDash([]);s.data.forEach(d=>{ctx.beginPath();ctx.arc(sx(d.x),sy(d.y),4,0,Math.PI*2);ctx.fillStyle=s.color;ctx.fill();});});}
updateMetricTogglesVisibility();

$('settingsBtn').addEventListener('click',()=>{$('patInput').value=state.pat;state.settingsProfile='joel';renderBaseSettings();$$('.settings-profile-btn').forEach(b=>{b.classList.remove('active');if(b.dataset.profile==='joel')b.classList.add('active');});$('settingsModal').classList.add('active');});
$$('.settings-tab').forEach(t=>t.addEventListener('click',()=>{$$('.settings-tab').forEach(x=>x.classList.remove('active'));$$('.settings-panel').forEach(x=>x.classList.remove('active'));t.classList.add('active');$(`panel${t.dataset.tab.charAt(0).toUpperCase()+t.dataset.tab.slice(1)}`).classList.add('active');}));
$$('.settings-profile-btn').forEach(b=>b.addEventListener('click',()=>{$$('.settings-profile-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');state.settingsProfile=b.dataset.profile;renderBaseSettings();}));
function renderBaseSettings(){const p=state.settingsProfile;const base=state.data.base?.[p]||DEFAULT_BASE[p];let html=`<div class="base-settings-group"><div class="base-settings-group-title">General</div><div class="base-setting-row"><label>üêï Sidon (mins)</label><input type="number" data-key="sidonMins" value="${base.sidonMins||10}"></div><div class="base-setting-row"><label>üëü Steps</label><input type="number" data-key="steps" value="${base.steps||15000}"></div></div><div class="base-settings-group"><div class="base-settings-group-title">üí™ Upper Body</div>${renderBaseExercises(base.upper||DEFAULT_BASE[p].upper,'upper')}</div><div class="base-settings-group"><div class="base-settings-group-title">ü¶µ Lower Body</div>${renderBaseExercises(base.lower||DEFAULT_BASE[p].lower,'lower')}</div><div class="base-settings-group"><div class="base-settings-group-title">üéØ Core</div>${renderBaseExercises(base.core||DEFAULT_BASE[p].core,'core')}</div>`;$('baseSettingsContent').innerHTML=html;}
function renderBaseExercises(exs,group){return Object.entries(exs).map(([k,ex])=>{let inputs=`<input type="number" data-group="${group}" data-ex="${k}" data-f="s" value="${ex.s}" placeholder="S">`;if(ex.m!==undefined)inputs+=`<input type="number" data-group="${group}" data-ex="${k}" data-f="m" value="${ex.m}" placeholder="M">`;else inputs+=`<input type="number" data-group="${group}" data-ex="${k}" data-f="r" value="${ex.r}" placeholder="R">`;if(ex.w!==null&&ex.w!==undefined)inputs+=`<input type="number" data-group="${group}" data-ex="${k}" data-f="w" value="${ex.w}" placeholder="Kg">`;return`<div class="base-setting-row"><label style="font-size:0.75rem;">${EX_NAMES[k]}</label><div style="display:flex;gap:0.2rem;">${inputs}</div></div>`;}).join('');}
$('cancelSettings').addEventListener('click',()=>$('settingsModal').classList.remove('active'));
$('saveSettings').addEventListener('click',async()=>{state.pat=$('patInput').value.trim();localStorage.setItem('github_pat',state.pat);const p=state.settingsProfile;if(!state.data.base)state.data.base=JSON.parse(JSON.stringify(DEFAULT_BASE));if(!state.data.base[p])state.data.base[p]=JSON.parse(JSON.stringify(DEFAULT_BASE[p]));const sidonInput=$('baseSettingsContent').querySelector('[data-key="sidonMins"]');const stepsInput=$('baseSettingsContent').querySelector('[data-key="steps"]');if(sidonInput)state.data.base[p].sidonMins=parseInt(sidonInput.value)||10;if(stepsInput)state.data.base[p].steps=parseInt(stepsInput.value)||15000;['upper','lower','core'].forEach(group=>{if(!state.data.base[p][group])state.data.base[p][group]=JSON.parse(JSON.stringify(DEFAULT_BASE[p][group]));$('baseSettingsContent').querySelectorAll(`[data-group="${group}"]`).forEach(inp=>{const ex=inp.dataset.ex,f=inp.dataset.f;if(!state.data.base[p][group][ex])return;const val=f==='w'?parseFloat(inp.value):parseInt(inp.value);if(!isNaN(val))state.data.base[p][group][ex][f]=val;});});$('settingsModal').classList.remove('active');showToast('Settings saved!');if(state.pat&&!CONFIG.REPO_OWNER)await loadData();else if(state.pat)await saveData();});
$('settingsModal').addEventListener('click',e=>{if(e.target===$('settingsModal'))$('settingsModal').classList.remove('active');});
$('deleteModal').addEventListener('click',e=>{if(e.target===$('deleteModal')){$('deleteModal').classList.remove('active');state.deleteId=null;}});
function init(){setDate();if(localStorage.getItem('pin_verified')==='true'){$('pinScreen').classList.add('hidden');$('app').classList.add('active');loadData();}}
init();
</script>
</body>
</html>
