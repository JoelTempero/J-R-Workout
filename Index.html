<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>J&R Workout</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        :root{--bg-dark:#1a1a2e;--bg-card:#16213e;--bg-input:#0f0f23;--joel-primary:#7c3aed;--joel-secondary:#a78bfa;--rachel-primary:#06b6d4;--rachel-secondary:#67e8f9;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--text-muted:#64748b;--orange:#f97316}
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}
        body{font-family:system-ui,-apple-system,sans-serif;background:var(--bg-dark);color:var(--text-primary);min-height:100vh;min-height:100dvh}
        input,textarea,select{-webkit-user-select:auto;user-select:auto}
        .hidden{display:none!important}
        button{min-height:48px;min-width:48px;touch-action:manipulation;cursor:pointer;border:none;font-family:inherit}
        .pin-screen{position:fixed;inset:0;background:var(--bg-dark);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;padding:2rem}
        .pin-logo{font-size:2rem;font-weight:700;margin-bottom:0.5rem;background:linear-gradient(135deg,var(--joel-primary),var(--rachel-primary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .pin-subtitle{color:var(--text-secondary);margin-bottom:2rem}
        .pin-dots{display:flex;gap:1rem;margin-bottom:2rem}
        .pin-dot{width:18px;height:18px;border-radius:50%;background:var(--bg-input);border:2px solid var(--text-muted);transition:all 0.2s}
        .pin-dot.filled{background:var(--success);border-color:var(--success)}
        .pin-dot.error{background:var(--danger);border-color:var(--danger);animation:shake 0.5s}
        @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
        .pin-keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem}
        .pin-key{width:70px;height:70px;border-radius:50%;background:var(--bg-card);color:var(--text-primary);font-size:1.5rem;font-weight:600;touch-action:manipulation;-webkit-user-select:none;user-select:none}
        .pin-key:active{transform:scale(0.95);background:var(--bg-input)}
        .pin-key.empty{visibility:hidden}
        .app{display:none;flex-direction:column;min-height:100vh;min-height:100dvh;padding-bottom:100px}
        .app.active{display:flex}
        .header{padding:1rem 1.5rem;display:flex;align-items:center;background:var(--bg-card);position:sticky;top:0;z-index:50}
        .header-left{display:flex;align-items:center;gap:0.75rem}
        .header-icon{width:2.5rem;height:2.5rem;border-radius:8px}
        .header-title{font-size:1.25rem;font-weight:700}
        .header-date{color:var(--text-secondary);font-size:0.875rem}
        .page{display:none;flex:1;padding:1rem;overflow-y:auto;padding-bottom:20px}
        .page.active{display:block}
        .card{background:var(--bg-card);border-radius:16px;padding:1.25rem;margin-bottom:1rem}
        .card-title{font-size:1.1rem;font-weight:700;margin-bottom:1rem}
        
        .competition-banner-title{font-size:0.75rem;text-transform:uppercase;opacity:0.9;margin-bottom:0.5rem}
        .competition-banner-content{display:flex;align-items:center;justify-content:space-between}
        .competition-leader{font-size:1.1rem;font-weight:700}
        .competition-stats{font-size:0.85rem;opacity:0.9}
        .date-group{margin-bottom:1.5rem}
        .date-group-header{font-size:1rem;font-weight:700;color:var(--text-secondary);margin-bottom:0.75rem;padding-left:0.25rem}
        .workout-log-item{background:var(--bg-input);border-radius:12px;padding:1rem;margin-bottom:0.5rem;display:flex;align-items:center;gap:0.75rem}
        .workout-log-item.joel{border-left:4px solid var(--joel-primary)}
        .workout-log-item.rachel{border-left:4px solid var(--rachel-primary)}
        .workout-log-icon{font-size:1.5rem;width:36px;text-align:center;flex-shrink:0}
        .workout-log-details{flex:1;min-width:0}
        .workout-log-header{display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap}
        .workout-log-title{font-weight:700;font-size:1.1rem}
        .workout-log-profile{font-size:0.65rem;padding:0.15rem 0.5rem;border-radius:8px;font-weight:700}
        .workout-log-profile.joel{background:var(--joel-primary);color:white}
        .workout-log-profile.rachel{background:var(--rachel-primary);color:white}
        .workout-log-meta{font-size:0.8rem;color:var(--text-muted);margin-top:0.2rem}
        .workout-log-summary{font-size:0.9rem;color:var(--text-secondary);margin-top:0.25rem}
        .workout-log-summary strong{color:var(--text-primary)}
        .workout-log-actions{display:flex;gap:0.35rem;flex-shrink:0}
        .workout-log-actions button{width:40px;height:40px;border-radius:50%;background:var(--bg-card);color:var(--text-secondary);font-size:1rem;display:flex;align-items:center;justify-content:center;min-height:40px;min-width:40px}
        .workout-log-actions button:active{background:var(--bg-dark)}
        .details-btn{background:var(--bg-card)!important;color:var(--text-secondary)!important;font-size:0.7rem!important;padding:0.3rem 0.6rem!important;border-radius:6px!important;width:auto!important;min-width:auto!important;height:auto!important;min-height:28px!important;font-weight:600}
        .empty-state{text-align:center;padding:3rem 1rem;color:var(--text-muted)}
        .empty-state-icon{font-size:3rem;margin-bottom:1rem}
        .fab{position:fixed;bottom:115px;right:1.5rem;width:64px;height:64px;border-radius:50%;background:var(--success);color:white;font-size:2.25rem;box-shadow:0 4px 20px rgba(16,185,129,0.4);z-index:90;display:flex;align-items:center;justify-content:center}
        .fab:active{transform:scale(0.95)}
        .log-options-modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:flex-end;z-index:200}
        .log-options-modal.active{display:flex}
        .log-options-content{background:var(--bg-card);width:100%;border-radius:24px 24px 0 0;padding:1.5rem;padding-bottom:max(1.5rem,env(safe-area-inset-bottom));max-height:80vh;overflow-y:auto}
        .log-options-title{font-size:1.25rem;font-weight:700;text-align:center;margin-bottom:1.5rem}
        .log-option-btn{display:flex;align-items:center;gap:1rem;width:100%;padding:1rem;background:var(--bg-input);border-radius:12px;color:var(--text-primary);font-size:1rem;font-weight:600;margin-bottom:0.75rem}
        .log-option-btn:active{background:var(--bg-card)}
        .log-option-btn .icon{font-size:1.5rem;width:44px;text-align:center}
        .log-option-close{width:100%;padding:1rem;margin-top:0.5rem;background:transparent;border:2px solid var(--text-muted);border-radius:12px;color:var(--text-secondary);font-size:1rem}
        .log-page{position:fixed;inset:0;background:var(--bg-dark);display:none;flex-direction:column;z-index:300;overflow-y:auto}
        .log-page.active{display:flex}
        .log-page-header{padding:1rem 1.5rem;display:flex;align-items:center;gap:1rem;background:var(--bg-card);position:sticky;top:0;z-index:10}
        .log-page-back{width:44px;height:44px;border-radius:50%;background:var(--bg-input);color:var(--text-primary);font-size:1.25rem;display:flex;align-items:center;justify-content:center}
        .log-page-title{font-size:1.25rem;font-weight:700;flex:1}
        .log-page-content{flex:1;padding:1rem;padding-bottom:100px}
        .profile-toggle{display:flex;gap:0.5rem;background:var(--bg-input);border-radius:12px;padding:0.5rem}
        .profile-toggle-btn{flex:1;padding:0.75rem;border:2px solid transparent;border-radius:8px;background:transparent;color:var(--text-muted);font-size:1rem;font-weight:600;display:flex;align-items:center;justify-content:center;gap:0.5rem}
        .profile-toggle-btn.active.joel{border-color:var(--joel-primary);color:var(--joel-secondary);background:rgba(124,58,237,0.1)}
        .profile-toggle-btn.active.rachel{border-color:var(--rachel-primary);color:var(--rachel-secondary);background:rgba(6,182,212,0.1)}
        .datetime-row{display:flex;gap:0.75rem;margin-bottom:1rem}
        .datetime-input{flex:1;background:var(--bg-input);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:0.875rem 1rem;color:var(--text-primary);font-size:1rem;min-height:50px}
        .datetime-input:focus{outline:none;border-color:var(--success)}
        .exercise-item{background:var(--bg-input);border-radius:12px;padding:1rem;margin-bottom:0.75rem}
        .exercise-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:0.75rem}
        .exercise-name{font-weight:700}
        .exercise-toggle{width:54px;height:30px;border-radius:15px;background:var(--bg-dark);position:relative;transition:background 0.2s}
        .exercise-toggle.active{background:var(--success)}
        .exercise-toggle::after{content:\'\';position:absolute;width:24px;height:24px;border-radius:50%;background:white;top:3px;left:3px;transition:transform 0.2s}
        .exercise-toggle.active::after{transform:translateX(24px)}
        .exercise-inputs{display:flex;gap:0.5rem;flex-wrap:wrap}
        .exercise-inputs.disabled{opacity:0.4;pointer-events:none}
        .input-group{display:flex;flex-direction:column;gap:0.25rem}
        .input-group label{font-size:0.7rem;color:var(--text-muted);text-transform:uppercase}
        .input-group input{width:70px;background:var(--bg-card);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:0.5rem;color:var(--text-primary);font-size:1rem;text-align:center;min-height:44px}
        .input-group input:focus{outline:none;border-color:var(--success)}
        .simple-input-row{display:flex;align-items:center;gap:1rem;background:var(--bg-input);border-radius:12px;padding:1rem;margin-bottom:0.75rem}
        .simple-input-row .icon{font-size:1.5rem}
        .simple-input-row label{flex:1;font-weight:600}
        .simple-input-row input{width:100px;background:var(--bg-card);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:0.75rem;color:var(--text-primary);font-size:1.1rem;text-align:center;min-height:50px}
        .simple-input-row .unit{color:var(--text-muted);width:40px}
        .run-type-toggle{display:flex;gap:0.5rem;margin-bottom:1rem}
        .run-type-btn{flex:1;padding:0.75rem;border:2px solid var(--text-muted);border-radius:8px;background:transparent;color:var(--text-muted);font-weight:600;font-size:0.9rem}
        .run-type-btn.active{border-color:var(--success);color:var(--success);background:rgba(16,185,129,0.1)}
        .submit-btn{position:fixed;bottom:0;left:0;right:0;padding:1rem;padding-bottom:max(1rem,env(safe-area-inset-bottom));background:var(--bg-card)}
        .submit-btn button{width:100%;padding:1rem;border-radius:12px;font-size:1.1rem;font-weight:600;min-height:56px}
        .submit-btn button.joel{background:linear-gradient(135deg,var(--joel-primary),#9333ea);color:white}
        .submit-btn button.rachel{background:linear-gradient(135deg,var(--rachel-primary),#0891b2);color:white}
        .submit-btn button:active{transform:scale(0.98)}
        .calendar-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem}
        .calendar-nav button{background:var(--bg-input);color:var(--text-primary);width:44px;height:44px;border-radius:50%;font-size:1.25rem;display:flex;align-items:center;justify-content:center}
        .calendar-nav button:active{background:var(--bg-card)}
        .calendar-month{font-size:1.25rem;font-weight:700}
        .calendar-filter{display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap}
        .calendar-filter button{padding:0.5rem 0.75rem;border:2px solid var(--text-muted);border-radius:20px;background:transparent;color:var(--text-secondary);font-weight:600;font-size:0.75rem}
        .calendar-filter button.active{border-color:var(--success);background:rgba(16,185,129,0.1);color:var(--success)}
        .calendar-weekdays{display:grid;grid-template-columns:repeat(7,1fr);text-align:center;margin-bottom:0.5rem}
        .calendar-weekdays span{color:var(--text-muted);font-size:0.75rem;font-weight:600;padding:0.5rem 0}
        .calendar-days{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
        .calendar-day{height:52px;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding-top:4px}
        .calendar-day .date{font-size:0.75rem;font-weight:600;height:18px;line-height:18px}
        .calendar-day.empty .date{color:var(--text-muted);opacity:0.3}
        .calendar-day.today .date{color:var(--success);font-weight:800}
        .calendar-day .indicator-wrap{height:28px;display:flex;align-items:center;justify-content:center;margin-top:2px}
        .calendar-day .indicator-circle{width:28px;height:28px;position:relative}
        .calendar-day .half-left,.calendar-day .half-right{position:absolute;width:14px;height:28px;top:0}
        .calendar-day .half-left{left:0;border-radius:28px 0 0 28px}
        .calendar-day .half-right{right:0;border-radius:0 28px 28px 0}
        .calendar-day .half-left.joel{background:var(--joel-primary)}
        .calendar-day .half-right.rachel{background:var(--rachel-primary)}
        .calendar-legend{display:flex;gap:1rem;margin-top:1rem;padding-top:1rem;border-top:1px solid rgba(255,255,255,0.05);justify-content:center}
        .legend-item{display:flex;align-items:center;gap:0.35rem;font-size:0.8rem;color:var(--text-secondary)}
        .legend-half{width:14px;height:14px;border-radius:7px}
        .time-filter{display:flex;gap:0.5rem;margin-bottom:1rem}
        .time-filter button{flex:1;padding:0.5rem;border-radius:8px;background:var(--bg-input);color:var(--text-secondary);font-weight:600;font-size:0.75rem}
        .time-filter button.active{background:var(--success);color:white}
        .chart-container{height:220px;margin:1rem 0;position:relative}
        .chart-canvas{width:100%;height:100%}
        .exercise-selector select{width:100%;padding:0.75rem 1rem;background:var(--bg-input);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:var(--text-primary);font-size:1rem;min-height:50px;margin-bottom:0.75rem}
        .stats-profile-toggle{display:flex;gap:0.5rem;margin-bottom:0.75rem}
        .stats-profile-btn{flex:1;padding:0.5rem;border:2px solid var(--text-muted);border-radius:8px;background:transparent;color:var(--text-muted);font-size:0.8rem;font-weight:600}
        .stats-profile-btn.active.joel{border-color:var(--joel-primary);color:var(--joel-secondary);background:rgba(124,58,237,0.15)}
        .stats-profile-btn.active.rachel{border-color:var(--rachel-primary);color:var(--rachel-secondary);background:rgba(6,182,212,0.15)}
        .stats-profile-btn.active.both{border-color:var(--orange);color:var(--orange);background:rgba(249,115,22,0.15)}
        .metric-toggles{display:flex;gap:0.5rem;margin-bottom:0.75rem;flex-wrap:wrap}
        .metric-toggle{padding:0.4rem 0.8rem;border:2px solid var(--text-muted);border-radius:16px;background:transparent;color:var(--text-muted);font-weight:600;font-size:0.75rem}
        .metric-toggle.active{border-color:var(--success);color:var(--success);background:rgba(16,185,129,0.15)}
        .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--bg-card);border-top:1px solid rgba(255,255,255,0.05);display:grid;grid-template-columns:repeat(5,1fr);padding:0.25rem 0;padding-bottom:max(0.25rem,env(safe-area-inset-bottom));z-index:100}
        .nav-item{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0.15rem;padding:0.75rem 0.5rem;background:none;color:var(--text-muted);font-size:0.65rem;font-weight:600;min-height:60px;min-width:60px;border-radius:12px;transition:all 0.15s ease;-webkit-tap-highlight-color:transparent;touch-action:manipulation;cursor:pointer}
        .nav-item:active,.nav-item.tapped{background:rgba(255,255,255,0.15);transform:scale(0.92)}
        .nav-item .icon{font-size:1.4rem;transition:transform 0.15s}
        .nav-item:active .icon,.nav-item.tapped .icon{transform:scale(1.15)}
        .nav-item.active{color:var(--success)}
        
        .rewards-nav{display:flex;align-items:center;justify-content:center;gap:0.5rem}
        .rewards-nav button{width:36px;height:36px;border-radius:50%;background:var(--bg-input);color:var(--text-primary);font-size:1.25rem;display:flex;align-items:center;justify-content:center}
        .rewards-nav button:active{background:var(--bg-card)}
        .rewards-header{background:linear-gradient(135deg,var(--joel-primary),var(--rachel-primary));border-radius:16px;padding:1.25rem;margin-bottom:1rem;text-align:center}
        .rewards-month{font-size:0.75rem;text-transform:uppercase;opacity:0.9}
        
        
        
        
        
        .rewards-tabs{display:flex;gap:0.5rem;margin-bottom:1rem}
        .rewards-tab{flex:1;padding:0.6rem;border-radius:8px;background:var(--bg-input);color:var(--text-secondary);font-weight:600;font-size:0.8rem}
        .rewards-tab.active{background:var(--success);color:white}
        .rewards-panel{display:none}
        .rewards-panel.active{display:block}
        
        .awards-nav{display:flex;align-items:center;justify-content:center;gap:1rem;margin-bottom:1rem}
        .awards-nav button{width:36px;height:36px;border-radius:50%;background:var(--bg-card);border:2px solid var(--text-muted);color:var(--text-primary);font-size:1.25rem}
        .awards-nav button:active{background:var(--bg-input)}
        .awards-nav span{font-weight:600;min-width:140px;text-align:center;color:var(--text-secondary)}
        .award-card{background:var(--bg-input);border-radius:12px;padding:1rem;margin-bottom:0.75rem;cursor:pointer;transition:transform 0.15s}
        .award-card:active{transform:scale(0.98)}
        .award-card-header{display:flex;align-items:center;gap:0.75rem;margin-bottom:0.5rem}
        .award-card-icon{font-size:1.5rem}
        .award-card-title{font-weight:700;flex:1}
        .award-card-leader{font-size:0.75rem;padding:0.2rem 0.5rem;border-radius:8px;font-weight:700}
        .award-card-leader.joel{background:var(--joel-primary)}
        .award-card-leader.rachel{background:var(--rachel-primary)}
        .award-card-leader.tie{background:var(--warning)}
        .award-card-progress{display:flex;justify-content:space-between;font-size:0.85rem;color:var(--text-secondary)}
        .medal-summary{display:flex;justify-content:space-around;background:var(--bg-input);border-radius:12px;padding:1rem;margin-bottom:1rem}
        .medal-person{text-align:center}
        .medal-name{display:block;font-weight:700;margin-bottom:0.25rem}
        .medal-person.joel .medal-name{color:var(--joel-secondary)}
        .medal-person.rachel .medal-name{color:var(--rachel-secondary)}
        .medal-count{font-size:1.1rem}
        .badge-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:0.75rem}
        .badge-item{text-align:center;padding:0.75rem 0.25rem;background:var(--bg-input);border-radius:12px;cursor:pointer;position:relative}
        .badge-item.locked{opacity:0.4}
        .badge-item.earned{border:2px solid var(--success)}
        .badge-medals{display:flex;justify-content:center;gap:0.25rem;margin-top:0.25rem}
        .badge-medal{width:20px;height:20px;border-radius:50%;font-size:0.6rem;font-weight:700;display:flex;align-items:center;justify-content:center}
        .badge-medal.gold{background:linear-gradient(135deg,#ffd700,#ffb700);color:#000}
        .badge-medal.silver{background:linear-gradient(135deg,#c0c0c0,#a0a0a0);color:#000}
        .badge-icon{font-size:1.75rem;margin-bottom:0.25rem}
        .badge-name{font-size:0.6rem;color:var(--text-secondary);line-height:1.2}
        .badge-owner{font-size:0.55rem;margin-top:0.2rem;font-weight:700}
        .badge-owner.joel{color:var(--joel-secondary)}
        .badge-owner.rachel{color:var(--rachel-secondary)}
        .toast{position:fixed;bottom:120px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--success);color:white;padding:1rem 1.5rem;border-radius:12px;font-weight:600;opacity:0;transition:all 0.3s;z-index:400}
        .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
        .toast.error{background:var(--danger)}
        .sync-status{position:fixed;top:0;left:0;right:0;height:3px;z-index:500}
        .sync-status.syncing{background:linear-gradient(90deg,transparent,var(--success),transparent);animation:syncPulse 1.5s infinite}
        @keyframes syncPulse{0%,100%{opacity:0.3}50%{opacity:1}}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:500;padding:1rem}
        .modal-overlay.active{display:flex}
        .modal{background:var(--bg-card);border-radius:20px;padding:1.5rem;width:100%;max-width:400px;max-height:85vh;overflow-y:auto}
        .modal-title{font-size:1.25rem;font-weight:700;margin-bottom:1rem;text-align:center}
        .modal-section{margin-bottom:1.5rem}
        .modal-section-title{font-weight:700;font-size:0.875rem;color:var(--text-secondary);margin-bottom:0.75rem;text-transform:uppercase}
        .modal-input{width:100%;background:var(--bg-input);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:0.875rem 1rem;color:var(--text-primary);font-size:1rem;margin-bottom:0.75rem;min-height:50px}
        .modal-input:focus{outline:none;border-color:var(--success)}
        .modal-buttons{display:flex;gap:0.75rem}
        .modal-btn{flex:1;padding:0.875rem;border-radius:12px;font-weight:600;min-height:50px}
        .modal-btn.cancel{background:var(--bg-input);color:var(--text-secondary)}
        .modal-btn.save{background:var(--success);color:white}
        .modal-btn.danger{background:var(--danger);color:white}
        .confirm-text{text-align:center;margin-bottom:1.5rem;color:var(--text-secondary)}
        .settings-tabs{display:flex;gap:0.5rem;margin-bottom:1rem}
        .settings-tab{flex:1;padding:0.5rem;border-radius:8px;background:var(--bg-input);color:var(--text-secondary);font-weight:600;font-size:0.7rem}
        .settings-tab.active{background:var(--success);color:white}
        .settings-panel{display:none}
        .settings-panel.active{display:block}
        .settings-profile-toggle{display:flex;gap:0.5rem;margin-bottom:1rem}
        .settings-profile-btn{flex:1;padding:0.6rem;border:2px solid var(--text-muted);border-radius:8px;background:transparent;color:var(--text-muted);font-size:0.85rem;font-weight:600}
        .settings-profile-btn.active.joel{border-color:var(--joel-primary);color:var(--joel-secondary);background:rgba(124,58,237,0.1)}
        .settings-profile-btn.active.rachel{border-color:var(--rachel-primary);color:var(--rachel-secondary);background:rgba(6,182,212,0.1)}
        .base-setting-row{display:flex;align-items:center;justify-content:space-between;padding:0.5rem;background:var(--bg-input);border-radius:8px;margin-bottom:0.35rem}
        .base-setting-row label{font-size:0.75rem;flex:1}
        .base-setting-row input{width:50px;background:var(--bg-card);border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:0.35rem;color:var(--text-primary);font-size:0.75rem;text-align:center}
        .base-settings-group{margin-bottom:0.75rem}
        
        .base-ex-header{display:grid;grid-template-columns:1fr 50px 50px 50px;gap:0.25rem;font-size:0.65rem;color:var(--text-muted);font-weight:700;padding:0.25rem 0;border-bottom:1px solid var(--bg-input);margin-bottom:0.25rem}
        .base-ex-header span{text-align:center}
        .base-setting-row{display:grid;grid-template-columns:1fr 50px 50px 50px;gap:0.25rem;align-items:center;margin-bottom:0.35rem}
        .base-setting-row label{font-size:0.65rem;color:var(--text-secondary)}
        .base-setting-row input{width:100%;padding:0.35rem;border-radius:6px;background:var(--bg-input);border:1px solid var(--text-muted);color:var(--text-primary);font-size:0.75rem;text-align:center}
        .base-setting-row .na{text-align:center;color:var(--text-muted);font-size:0.75rem}
.base-settings-group-title{font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;margin-bottom:0.35rem}
        .race-goal-row{display:flex;align-items:center;gap:0.5rem;padding:0.5rem;background:var(--bg-input);border-radius:8px;margin-bottom:0.35rem}
        .race-goal-row input{flex:1;background:var(--bg-card);border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:0.4rem;color:var(--text-primary);font-size:0.8rem}
        .race-goal-row button{padding:0.4rem 0.6rem;min-width:32px;min-height:32px;font-size:0.8rem;border-radius:6px;background:var(--danger);color:white}
        .add-goal-btn{width:100%;padding:0.5rem;border:2px dashed var(--text-muted);border-radius:8px;background:transparent;color:var(--text-muted);font-size:0.8rem;margin-top:0.5rem}
        .details-exercise{padding:0.75rem;background:var(--bg-input);border-radius:8px;margin-bottom:0.5rem}
        .details-exercise-name{font-weight:700;font-size:0.95rem;margin-bottom:0.25rem}
        .details-exercise-info{font-size:0.85rem;color:var(--text-secondary)}
        .details-exercise-info span{margin-right:1rem}
    </style>
</head>
<body>
    <div class="sync-status" id="syncStatus"></div>
    <div class="pin-screen" id="pinScreen">
        <div class="pin-logo">J&R Workout</div>
        <div class="pin-subtitle">Enter PIN to continue</div>
        <div class="pin-dots" id="pinDots"><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div></div>
        <div class="pin-keypad">
            <button class="pin-key" data-num="1">1</button><button class="pin-key" data-num="2">2</button><button class="pin-key" data-num="3">3</button>
            <button class="pin-key" data-num="4">4</button><button class="pin-key" data-num="5">5</button><button class="pin-key" data-num="6">6</button>
            <button class="pin-key" data-num="7">7</button><button class="pin-key" data-num="8">8</button><button class="pin-key" data-num="9">9</button>
            <button class="pin-key empty"></button><button class="pin-key" data-num="0">0</button><button class="pin-key" data-action="back">&#x232B;</button>
        </div>
    </div>
    <div class="app" id="app">
        <header class="header"><div class="header-left"><img src="icon.svg" class="header-icon" alt="App icon"><div><div class="header-title">J&R Workout</div><div class="header-date" id="headerDate"></div></div></div></header>
        <div class="page active" id="pageWorkouts">
            
            <div id="workoutsList"><div class="empty-state"><div class="empty-state-icon">üèãÔ∏è</div><p>No workouts logged yet</p></div></div>
        </div>
        <div class="page" id="pageCalendar"><div class="card">
            <div class="calendar-nav"><button id="prevMonth">‚Äπ</button><span class="calendar-month" id="calendarMonth"></span><button id="nextMonth">‚Ä∫</button></div>
            <div class="calendar-filter" id="calendarFilter"><button data-filter="all" class="active">All</button><button data-filter="sidon">üêï Sidon</button><button data-filter="steps">üëü Steps</button><button data-filter="run">üèÉ Run</button><button data-filter="upper">üí™ Upper</button><button data-filter="lower">ü¶µ Lower</button><button data-filter="core">üéØ Core</button><button data-filter="weight">‚öñÔ∏è Weight</button></div>
            <div class="calendar-weekdays"><span>S</span><span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span></div>
            <div class="calendar-days" id="calendarDays"></div>
            <div class="calendar-legend"><div class="legend-item"><div class="legend-half" style="background:var(--joel-primary)"></div><span>Joel</span></div><div class="legend-item"><div class="legend-half" style="background:var(--rachel-primary)"></div><span>Rachel</span></div></div>
        </div></div>
        <div class="page" id="pageStats"><div class="card">
            <div class="card-title">üìà Progress</div>
            <div class="time-filter" id="timeFilter"><button data-range="week" class="active">Week</button><button data-range="month">Month</button><button data-range="year">Year</button><button data-range="all">All</button></div>
            <div class="stats-profile-toggle" id="statsProfileToggle"><button class="stats-profile-btn joel active" data-profile="joel">üíú Joel</button><button class="stats-profile-btn rachel" data-profile="rachel">ü©µ Rachel</button><button class="stats-profile-btn both" data-profile="both">üß° Both</button></div>
            <div class="exercise-selector"><select id="exerciseSelect"><option value="bodyWeight">‚öñÔ∏è Body Weight</option><option value="steps">üëü Step Count</option><option value="sidon">üêï Sidon Walk</option><option value="run">üèÉ Running</option><optgroup label="üí™ Upper Body"><option value="pushups">Pushups</option><option value="tricepDips">Tricep Dips</option><option value="latPulldowns">Lat Pulldowns</option><option value="tricepPulldowns">Tricep Pulldowns</option><option value="bicepCurls">Bicep Curls</option><option value="lateralRaises">Lateral Raises</option></optgroup><optgroup label="ü¶µ Lower Body"><option value="weightedSquats">Weighted Squats</option><option value="jumpingLunges">Jumping Lunges</option><option value="deadlifts">Deadlifts</option><option value="hipThrusts">Hip Thrusts</option><option value="weightedStepUps">Weighted Step Ups</option><option value="calfRaises">Calf Raises</option></optgroup><optgroup label="üéØ Core"><option value="rotatingPlank">Rotating Plank</option><option value="vSitTwists">V-Sit Twists</option><option value="mountainClimbers">Mountain Climbers</option><option value="situps">Situps</option></optgroup></select></div>
            <div class="metric-toggles" id="metricToggles"><button class="metric-toggle active" data-metric="weight">Weight</button><button class="metric-toggle" data-metric="reps">Reps</button><button class="metric-toggle" data-metric="sets">Sets</button></div>
            <div class="chart-container"><canvas class="chart-canvas" id="statsChart"></canvas></div>
        </div></div>
        <div class="page" id="pageRewards">
            <div class="rewards-header"><div class="rewards-nav"><button id="rewardsPrevMonth">‚Äπ</button><div class="rewards-month" id="rewardsMonth"></div><button id="rewardsNextMonth">‚Ä∫</button></div></div>
            <div class="rewards-tabs"><button class="rewards-tab active" data-tab="weekly">Weekly</button><button class="rewards-tab" data-tab="monthly">Monthly</button><button class="rewards-tab" data-tab="annual">Annual</button><button class="rewards-tab" data-tab="badges">Badges</button></div>
            <div class="rewards-panel active" id="panelWeekly">
                <div class="awards-nav"><button id="prevWeek">‚Äπ</button><span id="weekLabel"></span><button id="nextWeek">‚Ä∫</button></div>
                <div id="weeklyAwardsList"></div>
            </div>
            <div class="rewards-panel" id="panelMonthly">
                <div class="awards-nav"><button id="prevAwardMonth">‚Äπ</button><span id="monthLabel"></span><button id="nextAwardMonth">‚Ä∫</button></div>
                <div id="monthlyAwardsList"></div>
            </div>
            <div class="rewards-panel" id="panelAnnual">
                <div class="awards-nav"><button id="prevYear">‚Äπ</button><span id="yearLabel"></span><button id="nextYear">‚Ä∫</button></div>
                <div id="annualAwardsList"></div>
            </div>
            <div class="rewards-panel" id="panelBadges"></div>
        </div>
        <button class="fab" id="fabBtn">+</button>
        <nav class="bottom-nav">
            <button class="nav-item active" data-page="pageWorkouts"><span class="icon">üè†</span><span>Workouts</span></button>
            <button class="nav-item" data-page="pageCalendar"><span class="icon">üìÖ</span><span>Calendar</span></button>
            <button class="nav-item" data-page="pageStats"><span class="icon">üìä</span><span>Stats</span></button>
            <button class="nav-item" data-page="pageRewards"><span class="icon">üèÜ</span><span>Rewards</span></button>
            <button class="nav-item" id="settingsBtn"><span class="icon">‚öôÔ∏è</span><span>Settings</span></button>
        </nav>
    </div>
    <div class="log-options-modal" id="logModal"><div class="log-options-content">
        <div class="log-options-title">What are you logging?</div>
        <button class="log-option-btn" data-log="sidon"><span class="icon">üêï</span> Sidon Walk</button>
        <button class="log-option-btn" data-log="steps"><span class="icon">üëü</span> Step Count</button>
        <button class="log-option-btn" data-log="run"><span class="icon">üèÉ</span> Run</button>
        <button class="log-option-btn" data-log="upper"><span class="icon">üí™</span> Upper Body</button>
        <button class="log-option-btn" data-log="lower"><span class="icon">ü¶µ</span> Lower Body</button>
        <button class="log-option-btn" data-log="core"><span class="icon">üéØ</span> Core</button>
        <button class="log-option-btn" data-log="custom"><span class="icon">‚ö°</span> Custom Workout</button>
        <button class="log-option-btn" data-log="weight"><span class="icon">‚öñÔ∏è</span> Log Weight</button>
        <button class="log-option-close" id="closeLogModal">Cancel</button>
    </div></div>
    <div id="logPages"></div>
    <div class="toast" id="toast"></div>
    <div class="modal-overlay" id="settingsModal"><div class="modal">
        <div class="modal-title">‚öôÔ∏è Settings</div>
        <div class="settings-tabs"><button class="settings-tab active" data-tab="general">General</button><button class="settings-tab" data-tab="base">Base</button></div>
        <div class="settings-panel active" id="settingsPanelGeneral">
<div class="modal-section"><div class="modal-section-title">GitHub Token</div><input type="password" class="modal-input" id="patInput" placeholder="ghp_xxxx"></div>
<div class="modal-section"><div class="modal-section-title">Backups</div>
<p style="font-size:0.75rem;color:var(--text-muted);margin-bottom:0.5rem;">Auto-backup runs daily. Last 7 days kept.</p>
<div style="display:flex;gap:0.5rem;margin-bottom:0.5rem;"><input type="text" class="modal-input" id="milestoneNameInput" placeholder="Milestone name" style="flex:1;"><button class="modal-btn save" id="createMilestoneBtn" style="white-space:nowrap;">üíæ Save</button></div>
<div style="display:flex;gap:0.5rem;"><select class="modal-input" id="restoreSelect" style="flex:1;"><option value="">Select backup to restore...</option></select><button class="modal-btn cancel" id="restoreBtn">üîÑ Restore</button></div>
</div>
</div>
        <div class="settings-panel" id="settingsPanelBase"><div class="settings-profile-toggle"><button class="settings-profile-btn joel active" data-profile="joel">Joel</button><button class="settings-profile-btn rachel" data-profile="rachel">Rachel</button></div><div id="baseSettingsContent"></div></div>
        <div class="modal-buttons"><button class="modal-btn cancel" id="cancelSettings">Close</button><button class="modal-btn save" id="saveSettings">Save</button></div>
    </div></div>
    <div class="modal-overlay" id="deleteModal"><div class="modal"><div class="modal-title">üóëÔ∏è Delete Workout</div><p class="confirm-text">Are you sure?</p><div class="modal-buttons"><button class="modal-btn cancel" id="cancelDelete">Cancel</button><button class="modal-btn danger" id="confirmDelete">Delete</button></div></div></div>
    <div class="modal-overlay" id="detailsModal"><div class="modal"><div class="modal-title" id="detailsModalTitle">Details</div><div id="detailsModalContent"></div><div class="modal-buttons"><button class="modal-btn save" id="closeDetails">Close</button></div></div></div>
    <div class="modal-overlay" id="badgeModal"><div class="modal"><div class="modal-title" id="badgeModalTitle">Badge</div><div id="badgeModalContent" style="text-align:center;padding:1rem 0;"></div><div class="modal-buttons"><button class="modal-btn save" id="closeBadge">Close</button></div></div></div>
    <div class="modal-overlay" id="awardModal"><div class="modal">
        <div class="modal-title" id="awardModalTitle">Award Details</div>
        <div id="awardModalContent"></div>
        <div class="modal-buttons"><button class="modal-btn save" id="closeAward">Close</button></div>
    </div></div>
<script>
window.deleteW=id=>{state.deleteId=id;document.getElementById('deleteModal').classList.add('active');};
window.editW=id=>{const w=state.data.workouts.find(x=>x.id===id);if(w)openLog(w.type,w);};
window.showDetails=id=>{const w=state.data.workouts.find(x=>x.id===id);if(!w||!w.exercises)return;document.getElementById('detailsModalTitle').textContent=getIcon(w.type)+' '+getTitle(w.type);let html='';Object.entries(w.exercises).filter(([k,v])=>v.on===1||v.on===true).forEach(([k,v])=>{let info='<span>'+(v.s||0)+' sets</span>';if(v.m!==undefined)info+='<span>'+(v.m||0)+' mins</span>';else if(v.r!==undefined)info+='<span>'+(v.r||0)+' reps</span>';if(v.w)info+='<span>'+v.w+' kg</span>';html+='<div class="details-exercise"><div class="details-exercise-name">'+(EX_NAMES[k]||k)+'</div><div class="details-exercise-info">'+info+'</div></div>';});if(!html)html='<p style="color:var(--text-muted);">No exercises recorded</p>';document.getElementById('detailsModalContent').innerHTML=html;document.getElementById('detailsModal').classList.add('active');};
window.showBadge=id=>{const b=BADGES.find(x=>x.id===id);if(!b)return;const badge=state.data.badges?.[b.id];document.getElementById('badgeModalTitle').textContent=b.icon+' '+b.name;let html='<p style="margin-bottom:1rem;color:var(--text-secondary);">'+b.desc+'</p>';if(badge&&badge.first){html+='<div style="display:flex;flex-direction:column;gap:0.5rem;"><div style="display:flex;align-items:center;gap:0.5rem;"><span style="font-size:1.5rem;">ü•á</span><span style="font-weight:700;color:'+(badge.first==='joel'?'var(--joel-secondary)':'var(--rachel-secondary)')+'">'+(badge.first==='joel'?'Joel':'Rachel')+' (Gold)</span></div>';if(badge.second){html+='<div style="display:flex;align-items:center;gap:0.5rem;"><span style="font-size:1.5rem;">ü•à</span><span style="font-weight:700;color:'+(badge.second==='joel'?'var(--joel-secondary)':'var(--rachel-secondary)')+'">'+(badge.second==='joel'?'Joel':'Rachel')+' (Silver)</span></div>';}html+='</div>';}else{html+='<p style="color:var(--text-muted);">Not yet earned</p>';}document.getElementById('badgeModalContent').innerHTML=html;document.getElementById('badgeModal').classList.add('active');};
window.showAward=(name,icon,desc,joel,rachel,type)=>{let winner='tie',winnerName="It's a tie!";if(joel>rachel){winner='joel';winnerName='üëë Joel wins!';}else if(rachel>joel){winner='rachel';winnerName='üëë Rachel wins!';}document.getElementById('awardModalTitle').textContent=icon+' '+name;document.getElementById('awardModalContent').innerHTML='<p style="color:var(--text-secondary);margin-bottom:1rem;">'+desc+'</p><div style="display:flex;justify-content:space-around;margin-bottom:1rem;"><div style="text-align:center;"><div style="font-size:1.5rem;font-weight:700;color:var(--joel-primary);">'+joel+'</div><div style="font-size:0.85rem;color:var(--text-muted);">üíú Joel</div></div><div style="text-align:center;"><div style="font-size:1.5rem;font-weight:700;color:var(--rachel-primary);">'+rachel+'</div><div style="font-size:0.85rem;color:var(--text-muted);">ü©µ Rachel</div></div></div><div style="text-align:center;font-weight:700;font-size:1.1rem;color:'+(winner==='joel'?'var(--joel-primary)':winner==='rachel'?'var(--rachel-primary)':'var(--warning)')+';display:block;">'+winnerName+'</div>';document.getElementById('awardModal').classList.add('active');};

const CONFIG={PIN:'9743',REPO_OWNER:'',REPO_NAME:'J-R-Workout',DATA_FILE:'data/workouts.json'};
const DEFAULT_BASE={rachel:{sidonMins:10,steps:15000,upper:{pushups:{s:3,r:5,w:null,on:1},tricepDips:{s:3,r:5,w:null,on:1},latPulldowns:{s:3,r:10,w:30,on:1},tricepPulldowns:{s:3,r:10,w:10,on:1},bicepCurls:{s:3,r:10,w:7,on:1},lateralRaises:{s:3,r:10,w:3,on:1}},lower:{weightedSquats:{s:3,r:10,w:7,on:1},jumpingLunges:{s:3,r:10,w:null,on:1},deadlifts:{s:3,r:10,w:14,on:1},hipThrusts:{s:3,r:10,w:7,on:1},weightedStepUps:{s:3,r:10,w:7,on:1},calfRaises:{s:3,r:15,w:null,on:1}},core:{rotatingPlank:{s:3,m:2,on:1},vSitTwists:{s:3,r:10,w:null,on:1},mountainClimbers:{s:3,r:20,w:null,on:1},situps:{s:3,r:15,w:null,on:1}}},joel:{sidonMins:10,steps:9000,upper:{pushups:{s:3,r:5,w:null,on:1},tricepDips:{s:3,r:5,w:null,on:1},latPulldowns:{s:3,r:10,w:30,on:1},tricepPulldowns:{s:3,r:10,w:10,on:1},bicepCurls:{s:3,r:10,w:7,on:1},lateralRaises:{s:3,r:10,w:3,on:1}},lower:{weightedSquats:{s:3,r:10,w:7,on:1},jumpingLunges:{s:3,r:10,w:null,on:1},deadlifts:{s:3,r:10,w:14,on:1},hipThrusts:{s:3,r:10,w:7,on:1},weightedStepUps:{s:3,r:10,w:7,on:1},calfRaises:{s:3,r:15,w:null,on:1}},core:{rotatingPlank:{s:3,m:2,on:1},vSitTwists:{s:3,r:10,w:null,on:1},mountainClimbers:{s:3,r:20,w:null,on:1},situps:{s:3,r:15,w:null,on:1}}}};
const EX_NAMES={pushups:'Pushups',tricepDips:'Tricep Dips',latPulldowns:'Lat Pulldowns',tricepPulldowns:'Tricep Pulldowns',bicepCurls:'Bicep Curls',lateralRaises:'Lateral Raises',weightedSquats:'Weighted Squats',jumpingLunges:'Jumping Lunges',deadlifts:'Deadlifts',hipThrusts:'Hip Thrusts',weightedStepUps:'Weighted Step Ups',calfRaises:'Calf Raises',rotatingPlank:'Rotating Plank',vSitTwists:'V-Sit Twists',mountainClimbers:'Mountain Climbers',situps:'Situps'};
const BADGES=[
{id:1,icon:'üéØ',name:'First Blood',desc:'Log first workout',check:(d,p)=>d.workouts.some(w=>w.profile===p&&['upper','lower','core','custom','run'].includes(w.type))},
{id:2,icon:'üåÖ',name:'Early Bird',desc:'Log before 7am',check:(d,p)=>d.workouts.some(w=>w.profile===p&&w.time&&parseInt(w.time.split(':')[0])<7)},
{id:3,icon:'ü¶â',name:'Night Owl',desc:'Log after 9pm',check:(d,p)=>d.workouts.some(w=>w.profile===p&&w.time&&parseInt(w.time.split(':')[0])>=21)},
{id:4,icon:'üí™',name:'Upper Starter',desc:'First Upper Body',check:(d,p)=>d.workouts.some(w=>w.profile===p&&w.type==='upper')},
{id:5,icon:'ü¶µ',name:'Leg Day',desc:'First Lower Body',check:(d,p)=>d.workouts.some(w=>w.profile===p&&w.type==='lower')},
{id:6,icon:'üéØ',name:'Core Starter',desc:'First Core workout',check:(d,p)=>d.workouts.some(w=>w.profile===p&&w.type==='core')},
{id:7,icon:'üèÉ',name:'First Run',desc:'Log first run',check:(d,p)=>d.workouts.some(w=>w.profile===p&&w.type==='run')},
{id:8,icon:'‚öñÔ∏è',name:'Weigh In',desc:'Log weight first time',check:(d,p)=>d.workouts.some(w=>w.profile===p&&w.type==='weight')},
{id:9,icon:'üî•',name:'Double Up',desc:'2 workouts in one day',check:(d,p)=>{const dates=d.workouts.filter(w=>w.profile===p&&['upper','lower','core','custom','run'].includes(w.type)).map(w=>w.date);return dates.some(dt=>dates.filter(x=>x===dt).length>=2);}},
{id:10,icon:'‚ö°',name:'Hat Trick',desc:'3 workouts in one day',check:(d,p)=>{const dates=d.workouts.filter(w=>w.profile===p&&['upper','lower','core','custom','run'].includes(w.type)).map(w=>w.date);return dates.some(dt=>dates.filter(x=>x===dt).length>=3);}},
{id:11,icon:'üé®',name:'Mix It Up',desc:'Upper+Lower+Core in week',check:(d,p)=>{const start=getWeekStart(new Date());const ws=d.workouts.filter(w=>w.profile===p&&new Date(w.date)>=start);return ws.some(w=>w.type==='upper')&&ws.some(w=>w.type==='lower')&&ws.some(w=>w.type==='core');}},
{id:12,icon:'üè†',name:'Home Runner',desc:'Treadmill run',check:(d,p)=>d.workouts.some(w=>w.profile===p&&w.type==='run'&&w.runType==='treadmill')},
{id:13,icon:'üå≥',name:'Outdoor Runner',desc:'Outside run',check:(d,p)=>d.workouts.some(w=>w.profile===p&&w.type==='run'&&w.runType==='outside')},
{id:14,icon:'üìÖ',name:'Weekday Warrior',desc:'Workout Mon-Fri',check:(d,p)=>d.workouts.some(w=>w.profile===p&&['upper','lower','core','custom','run'].includes(w.type)&&[1,2,3,4,5].includes(new Date(w.date).getDay()))},
{id:15,icon:'üõãÔ∏è',name:'Weekend Worker',desc:'Workout on weekend',check:(d,p)=>d.workouts.some(w=>w.profile===p&&['upper','lower','core','custom','run'].includes(w.type)&&[0,6].includes(new Date(w.date).getDay()))},
{id:16,icon:'3Ô∏è‚É£',name:'Three-peat',desc:'3-day streak',check:(d,p)=>getMaxStreak(d,p)>=3},
{id:17,icon:'üèãÔ∏è',name:'Ten Down',desc:'10 strength workouts',check:(d,p)=>d.workouts.filter(w=>w.profile===p&&['upper','lower','core','custom'].includes(w.type)).length>=10},
{id:18,icon:'üèãÔ∏è‚Äç‚ôÄÔ∏è',name:'Quarter Century',desc:'25 strength workouts',check:(d,p)=>d.workouts.filter(w=>w.profile===p&&['upper','lower','core','custom'].includes(w.type)).length>=25},
{id:19,icon:'üí™',name:'Half Century',desc:'50 strength workouts',check:(d,p)=>d.workouts.filter(w=>w.profile===p&&['upper','lower','core','custom'].includes(w.type)).length>=50},
{id:20,icon:'ü¶æ',name:'Century Club',desc:'100 strength workouts',check:(d,p)=>d.workouts.filter(w=>w.profile===p&&['upper','lower','core','custom'].includes(w.type)).length>=100},
{id:21,icon:'üèÉ',name:'Casual Jogger',desc:'10 runs',check:(d,p)=>d.workouts.filter(w=>w.profile===p&&w.type==='run').length>=10},
{id:22,icon:'üèÉ‚Äç‚ôÄÔ∏è',name:'Regular Runner',desc:'25 runs',check:(d,p)=>d.workouts.filter(w=>w.profile===p&&w.type==='run').length>=25},
{id:23,icon:'üèÉ‚Äç‚ôÇÔ∏è',name:'Run Fanatic',desc:'50 runs',check:(d,p)=>d.workouts.filter(w=>w.profile===p&&w.type==='run').length>=50},
{id:24,icon:'üéØ',name:'Core Commitment',desc:'20 core workouts',check:(d,p)=>d.workouts.filter(w=>w.profile===p&&w.type==='core').length>=20},
{id:25,icon:'ü¶µ',name:'Leg Legend',desc:'20 lower workouts',check:(d,p)=>d.workouts.filter(w=>w.profile===p&&w.type==='lower').length>=20},
{id:26,icon:'üí™',name:'Upper Echelon',desc:'20 upper workouts',check:(d,p)=>d.workouts.filter(w=>w.profile===p&&w.type==='upper').length>=20},
{id:27,icon:'‚öñÔ∏è',name:'Weigh Regular',desc:'Log weight 20x',check:(d,p)=>d.workouts.filter(w=>w.profile===p&&w.type==='weight').length>=20},
{id:28,icon:'üëü',name:'5K Club',desc:'Run 5km',check:(d,p)=>d.workouts.some(w=>w.profile===p&&w.type==='run'&&w.distance>=5)},
{id:29,icon:'üèÖ',name:'10K Club',desc:'Run 10km',check:(d,p)=>d.workouts.some(w=>w.profile===p&&w.type==='run'&&w.distance>=10)},
{id:30,icon:'üèÜ',name:'Half Marathon',desc:'Run 21.1km',check:(d,p)=>d.workouts.some(w=>w.profile===p&&w.type==='run'&&w.distance>=21.1)},
{id:31,icon:'üëë',name:'Marathoner',desc:'Run 42.2km',check:(d,p)=>d.workouts.some(w=>w.profile===p&&w.type==='run'&&w.distance>=42.2)},
{id:32,icon:'üåç',name:'50K Total',desc:'50km total running',check:(d,p)=>d.workouts.filter(w=>w.profile===p&&w.type==='run').reduce((s,w)=>s+(w.distance||0),0)>=50},
{id:33,icon:'üó∫Ô∏è',name:'100K Total',desc:'100km total running',check:(d,p)=>d.workouts.filter(w=>w.profile===p&&w.type==='run').reduce((s,w)=>s+(w.distance||0),0)>=100},
{id:34,icon:'‚úàÔ∏è',name:'250K Total',desc:'250km total running',check:(d,p)=>d.workouts.filter(w=>w.profile===p&&w.type==='run').reduce((s,w)=>s+(w.distance||0),0)>=250},
{id:35,icon:'üöÄ',name:'500K Total',desc:'500km total running',check:(d,p)=>d.workouts.filter(w=>w.profile===p&&w.type==='run').reduce((s,w)=>s+(w.distance||0),0)>=500},
{id:36,icon:'üåç',name:'World Runner',desc:'1000km running',check:(d,p)=>d.workouts.filter(w=>w.profile===p&&w.type==='run').reduce((s,w)=>s+(w.distance||0),0)>=1000},
{id:37,icon:'‚è±Ô∏è',name:'Speed Demon',desc:'3km under 20min',check:(d,p)=>d.workouts.some(w=>w.profile===p&&w.type==='run'&&w.distance>=3&&w.runTime<=20)},
{id:38,icon:'ü™®',name:'Getting Heavy',desc:'Lift 20kg',check:(d,p)=>d.workouts.some(w=>w.profile===p&&w.exercises&&Object.values(w.exercises).some(e=>e.w>=20))},
{id:39,icon:'üèîÔ∏è',name:'Heavyweight',desc:'Lift 30kg',check:(d,p)=>d.workouts.some(w=>w.profile===p&&w.exercises&&Object.values(w.exercises).some(e=>e.w>=30))},
{id:40,icon:'üóª',name:'Monster Lift',desc:'Lift 40kg',check:(d,p)=>d.workouts.some(w=>w.profile===p&&w.exercises&&Object.values(w.exercises).some(e=>e.w>=40))},
{id:41,icon:'üíé',name:'Diamond Lifter',desc:'Lift 50kg',check:(d,p)=>d.workouts.some(w=>w.profile===p&&w.exercises&&Object.values(w.exercises).some(e=>e.w>=50))},
{id:42,icon:'üìä',name:'Volume Veteran',desc:'500 total sets',check:(d,p)=>d.workouts.filter(w=>w.profile===p&&w.exercises).reduce((s,w)=>s+Object.values(w.exercises).reduce((ss,e)=>ss+(e.s||0),0),0)>=500},
{id:43,icon:'üìà',name:'Set Sensation',desc:'1000 total sets',check:(d,p)=>d.workouts.filter(w=>w.profile===p&&w.exercises).reduce((s,w)=>s+Object.values(w.exercises).reduce((ss,e)=>ss+(e.s||0),0),0)>=1000},
{id:44,icon:'üî¢',name:'Rep Rookie',desc:'1000 total reps',check:(d,p)=>d.workouts.filter(w=>w.profile===p&&w.exercises).reduce((s,w)=>s+Object.values(w.exercises).reduce((ss,e)=>ss+((e.s||0)*(e.r||0)),0),0)>=1000},
{id:45,icon:'üî£',name:'Rep Master',desc:'5000 total reps',check:(d,p)=>d.workouts.filter(w=>w.profile===p&&w.exercises).reduce((s,w)=>s+Object.values(w.exercises).reduce((ss,e)=>ss+((e.s||0)*(e.r||0)),0),0)>=5000},
{id:46,icon:'üìà',name:'First Gain',desc:'Gain 0.5kg',check:(d,p)=>getWeightGain(d,p)>=0.5},
{id:47,icon:'‚¨ÜÔ∏è',name:'One Kilo Up',desc:'Gain 1kg',check:(d,p)=>getWeightGain(d,p)>=1},
{id:48,icon:'üéØ',name:'Two Up',desc:'Gain 2kg',check:(d,p)=>getWeightGain(d,p)>=2},
{id:49,icon:'üí™',name:'Five Alive',desc:'Gain 5kg',check:(d,p)=>getWeightGain(d,p)>=5},
{id:50,icon:'üèÜ',name:'Ten Total',desc:'Gain 10kg',check:(d,p)=>getWeightGain(d,p)>=10},
{id:51,icon:'ü•á',name:'First Win',desc:'Win weekly award',check:(d,p)=>(d.awardHistory||[]).some(a=>a.winner===p)},
{id:52,icon:'üëë',name:'Monthly Champ',desc:'Win Monthly MVP',check:(d,p)=>(d.awardHistory||[]).some(a=>a.type==='monthly'&&a.winner===p)},
{id:53,icon:'üèÖ',name:'Award Collector',desc:'Win 10 weekly awards',check:(d,p)=>(d.awardHistory||[]).filter(a=>a.type==='weekly'&&a.winner===p).length>=10},
{id:54,icon:'üíé',name:'Award Hoarder',desc:'Win 25 weekly awards',check:(d,p)=>(d.awardHistory||[]).filter(a=>a.type==='weekly'&&a.winner===p).length>=25},
{id:55,icon:'üèõÔ∏è',name:'500 Club',desc:'500 workouts',check:(d,p)=>d.workouts.filter(w=>w.profile===p&&['upper','lower','core','custom','run'].includes(w.type)).length>=500},
{id:56,icon:'üè∞',name:'Thousand Strong',desc:'1000 workouts',check:(d,p)=>d.workouts.filter(w=>w.profile===p&&['upper','lower','core','custom','run'].includes(w.type)).length>=1000}
];

let state={pin:'',data:{workouts:[],base:JSON.parse(JSON.stringify(DEFAULT_BASE)),badges:{},raceGoals:{joel:[],rachel:[]},awardHistory:[]},month:new Date(),rewardsMonth:new Date(),awardsWeek:new Date(),awardsMonth:new Date(),awardsYear:new Date().getFullYear(),calFilter:'all',chartRange:'week',chartExercise:'bodyWeight',chartMetrics:{weight:true,reps:false,sets:false},chartProfile:'joel',pat:localStorage.getItem('github_pat')||'',deleteId:null,logProfile:'joel',settingsProfile:'joel',runType:'outside'};
const $=id=>document.getElementById(id),$$=sel=>document.querySelectorAll(sel),genId=()=>Date.now().toString(36)+Math.random().toString(36).substr(2);
const fmtDateShort=d=>new Date(d).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
const fmtTime=t=>{if(!t)return'';const[h,m]=t.split(':');const hr=parseInt(h);return (hr%12||12)+':'+m+(hr>=12?' PM':' AM');};
const getIcon=t=>({sidon:'üêï',steps:'üëü',run:'üèÉ',upper:'üí™',lower:'ü¶µ',core:'üéØ',custom:'‚ö°',weight:'‚öñÔ∏è'})[t]||'üèãÔ∏è';
const getTitle=t=>({sidon:'Sidon Walk',steps:'Step Count',run:'Run',upper:'Upper Body',lower:'Lower Body',core:'Core',custom:'Custom',weight:'Weight Log'})[t]||'Workout';
function getWeekStart(d){const date=new Date(d);const day=date.getDay();const diff=date.getDate()-day+(day===0?-6:1);return new Date(date.setDate(diff));}
function getMonthStart(d){return new Date(d.getFullYear(),d.getMonth(),1);}
function getMaxStreak(data,profile){const validTypes=['upper','lower','core','custom','run'];const dates=[...new Set(data.workouts.filter(w=>w.profile===profile&&validTypes.includes(w.type)).map(w=>w.date))].sort();if(!dates.length)return 0;let max=1,curr=1;for(let i=1;i<dates.length;i++){const diff=(new Date(dates[i])-new Date(dates[i-1]))/(1000*60*60*24);if(diff===1)curr++;else curr=1;max=Math.max(max,curr);}return max;}

function getMonthStreak(data,profile,monthStart,monthEnd){const validTypes=['upper','lower','core','custom','run'];const dates=[...new Set(data.workouts.filter(w=>w.profile===profile&&validTypes.includes(w.type)&&new Date(w.date)>=monthStart&&new Date(w.date)<=monthEnd).map(w=>w.date))].sort();if(!dates.length)return 0;let max=1,curr=1;for(let i=1;i<dates.length;i++){const diff=(new Date(dates[i])-new Date(dates[i-1]))/(1000*60*60*24);if(diff===1)curr++;else curr=1;max=Math.max(max,curr);}return max;}
function getWeightGain(data,profile){const ws=data.workouts.filter(w=>w.profile===profile&&w.type==='weight'&&w.bodyWeight).sort((a,b)=>new Date(a.date)-new Date(b.date));if(ws.length<2)return 0;return ws[ws.length-1].bodyWeight-ws[0].bodyWeight;}

function updateDots(){$$('#pinDots .pin-dot').forEach((d,i)=>d.classList.toggle('filled',i<state.pin.length));}
function pinInput(n){if(state.pin.length<4){state.pin+=n;updateDots();if(state.pin.length===4){setTimeout(()=>{if(state.pin===CONFIG.PIN){$('pinScreen').classList.add('hidden');$('app').classList.add('active');localStorage.setItem('pin_verified','true');loadData();}else{$$('#pinDots .pin-dot').forEach(d=>d.classList.add('error'));setTimeout(()=>{state.pin='';$$('#pinDots .pin-dot').forEach(d=>d.classList.remove('error','filled'));},500);}},200);}}}
$$('.pin-key').forEach(k=>{const handler=()=>{if(k.dataset.num!==undefined)pinInput(k.dataset.num);else if(k.dataset.action==='back'){state.pin=state.pin.slice(0,-1);updateDots();}};k.addEventListener('click',handler);k.addEventListener('touchend',e=>{e.preventDefault();handler();},{passive:false});});
function setDate(){$('headerDate').textContent=new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});}
document.querySelectorAll('.nav-item[data-page]').forEach(n=>{
const doNav=()=>{const p=n.dataset.page;$$('.page').forEach(x=>x.classList.remove('active'));$(p).classList.add('active');$$('.nav-item').forEach(x=>x.classList.remove('active','tapped'));n.classList.add('active');if(p==='pageCalendar')renderCal();if(p==='pageStats')renderChart();if(p==='pageWorkouts'){renderList();}if(p==='pageRewards')renderRewards();};
n.addEventListener('touchstart',e=>{n.classList.add('tapped');},{passive:true});
n.addEventListener('touchend',e=>{e.preventDefault();n.classList.remove('tapped');doNav();},{passive:false});
n.addEventListener('touchcancel',()=>{n.classList.remove('tapped');});
n.addEventListener('click',e=>{if(!e.sourceCapabilities||!e.sourceCapabilities.firesTouchEvents)doNav();});
});
async function loadData(){
if(!state.pat)return;
$('syncStatus').classList.add('syncing');
try{
const u=await fetch('https://api.github.com/user',{headers:{'Authorization':'Bearer '+state.pat}});
if(u.ok){CONFIG.REPO_OWNER=(await u.json()).login;}
else{console.error('Token validation failed:',u.status);showToast('Invalid token - update in Settings',true);$('syncStatus').classList.remove('syncing');return;}
const r=await fetch('https://api.github.com/repos/'+CONFIG.REPO_OWNER+'/'+CONFIG.REPO_NAME+'/contents/'+CONFIG.DATA_FILE,{headers:{'Authorization':'Bearer '+state.pat}});
if(r.ok){const d=await r.json();state.data={...state.data,...JSON.parse(atob(d.content))};}
else if(r.status===404){console.log('No data file yet, will create on first save');}
else{console.error('Load failed:',r.status);}
}catch(e){console.error('Load error:',e);showToast('Network error loading data',true);}
$('syncStatus').classList.remove('syncing');checkBadges();renderList();}

async function rotateBackups(){
const backupDate=localStorage.getItem('last_backup_date');
const today=new Date().toISOString().split('T')[0];
if(backupDate===today)return;
try{
for(let i=6;i>=1;i--){
const oldFile='backups/daily-'+i+'.json';
const newFile='backups/daily-'+(i+1)+'.json';
const r=await fetch('https://api.github.com/repos/'+CONFIG.REPO_OWNER+'/'+CONFIG.REPO_NAME+'/contents/'+oldFile,{headers:{'Authorization':'Bearer '+state.pat}});
if(r.ok){
const d=await r.json();
const nr=await fetch('https://api.github.com/repos/'+CONFIG.REPO_OWNER+'/'+CONFIG.REPO_NAME+'/contents/'+newFile,{headers:{'Authorization':'Bearer '+state.pat}});
const nsha=nr.ok?(await nr.json()).sha:null;
const body={message:'Rotate backup '+i+' to '+(i+1),content:d.content};
if(nsha)body.sha=nsha;
await fetch('https://api.github.com/repos/'+CONFIG.REPO_OWNER+'/'+CONFIG.REPO_NAME+'/contents/'+newFile,{method:'PUT',headers:{'Authorization':'Bearer '+state.pat,'Content-Type':'application/json'},body:JSON.stringify(body)});
}}
const curr=await fetch('https://api.github.com/repos/'+CONFIG.REPO_OWNER+'/'+CONFIG.REPO_NAME+'/contents/'+CONFIG.DATA_FILE,{headers:{'Authorization':'Bearer '+state.pat}});
if(curr.ok){
const cd=await curr.json();
const d1=await fetch('https://api.github.com/repos/'+CONFIG.REPO_OWNER+'/'+CONFIG.REPO_NAME+'/contents/backups/daily-1.json',{headers:{'Authorization':'Bearer '+state.pat}});
const d1sha=d1.ok?(await d1.json()).sha:null;
const body={message:'Daily backup '+today,content:cd.content};
if(d1sha)body.sha=d1sha;
await fetch('https://api.github.com/repos/'+CONFIG.REPO_OWNER+'/'+CONFIG.REPO_NAME+'/contents/backups/daily-1.json',{method:'PUT',headers:{'Authorization':'Bearer '+state.pat,'Content-Type':'application/json'},body:JSON.stringify(body)});
}
localStorage.setItem('last_backup_date',today);
console.log('Daily backup completed');
}catch(e){console.error('Backup failed:',e);}}

async function createMilestoneBackup(name){
if(!name)return false;
const safeName=name.toLowerCase().replace(/[^a-z0-9]/g,'-');
try{
const curr=await fetch('https://api.github.com/repos/'+CONFIG.REPO_OWNER+'/'+CONFIG.REPO_NAME+'/contents/'+CONFIG.DATA_FILE,{headers:{'Authorization':'Bearer '+state.pat}});
if(!curr.ok)return false;
const cd=await curr.json();
const file='backups/milestone-'+safeName+'.json';
const existing=await fetch('https://api.github.com/repos/'+CONFIG.REPO_OWNER+'/'+CONFIG.REPO_NAME+'/contents/'+file,{headers:{'Authorization':'Bearer '+state.pat}});
const sha=existing.ok?(await existing.json()).sha:null;
const body={message:'Milestone backup: '+name,content:cd.content};
if(sha)body.sha=sha;
const s=await fetch('https://api.github.com/repos/'+CONFIG.REPO_OWNER+'/'+CONFIG.REPO_NAME+'/contents/'+file,{method:'PUT',headers:{'Authorization':'Bearer '+state.pat,'Content-Type':'application/json'},body:JSON.stringify(body)});
return s.ok;
}catch(e){console.error('Milestone backup failed:',e);return false;}}

async function listBackups(){
const backups=[];
try{
for(let i=1;i<=7;i++){
const r=await fetch('https://api.github.com/repos/'+CONFIG.REPO_OWNER+'/'+CONFIG.REPO_NAME+'/contents/backups/daily-'+i+'.json',{headers:{'Authorization':'Bearer '+state.pat}});
if(r.ok)backups.push({name:'Daily backup '+i,file:'backups/daily-'+i+'.json'});}
const dir=await fetch('https://api.github.com/repos/'+CONFIG.REPO_OWNER+'/'+CONFIG.REPO_NAME+'/contents/backups',{headers:{'Authorization':'Bearer '+state.pat}});
if(dir.ok){
const files=await dir.json();
files.filter(f=>f.name.startsWith('milestone-')).forEach(f=>{
backups.push({name:'Milestone: '+f.name.replace('milestone-','').replace('.json',''),file:'backups/'+f.name});});}
}catch(e){console.error('List backups failed:',e);}
return backups;}

async function restoreBackup(file){
try{
const r=await fetch('https://api.github.com/repos/'+CONFIG.REPO_OWNER+'/'+CONFIG.REPO_NAME+'/contents/'+file,{headers:{'Authorization':'Bearer '+state.pat}});
if(!r.ok)return false;
const d=await r.json();
const restored=JSON.parse(atob(d.content));
state.data=restored;
const saved=await saveData();
if(saved){checkBadges();renderList();}
return saved;
}catch(e){console.error('Restore failed:',e);return false;}}

async function saveData(){
if(!state.pat){showToast('No GitHub token - check Settings',true);return false;}
if(!CONFIG.REPO_OWNER){showToast('Token invalid - update in Settings',true);return false;}
$('syncStatus').classList.add('syncing');
await rotateBackups();
try{
const g=await fetch('https://api.github.com/repos/'+CONFIG.REPO_OWNER+'/'+CONFIG.REPO_NAME+'/contents/'+CONFIG.DATA_FILE,{headers:{'Authorization':'Bearer '+state.pat}});
let sha=null;
if(g.ok){sha=(await g.json()).sha;}
else if(g.status===401){$('syncStatus').classList.remove('syncing');showToast('Token expired - update in Settings',true);return false;}
const body={message:'Update '+new Date().toISOString(),content:btoa(unescape(encodeURIComponent(JSON.stringify(state.data,null,2))))};
if(sha)body.sha=sha;
const s=await fetch('https://api.github.com/repos/'+CONFIG.REPO_OWNER+'/'+CONFIG.REPO_NAME+'/contents/'+CONFIG.DATA_FILE,{method:'PUT',headers:{'Authorization':'Bearer '+state.pat,'Content-Type':'application/json'},body:JSON.stringify(body)});
$('syncStatus').classList.remove('syncing');
if(!s.ok){const err=await s.json().catch(()=>({}));console.error('Save failed:',s.status,err);showToast('Sync error: '+(err.message||s.status),true);return false;}
return true;
}catch(e){console.error('Save error:',e);$('syncStatus').classList.remove('syncing');showToast('Network error',true);return false;}}
function showToast(msg,err){const t=$('toast');t.textContent=msg;t.classList.toggle('error',err);t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}

function renderList(){
    const list=$('workoutsList');
    const w=(state.data.workouts||[]).sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));
    if(!w.length){list.innerHTML='<div class="empty-state"><div class="empty-state-icon">üèãÔ∏è</div><p>No workouts logged yet</p></div>';return;}
    const groups={};
    w.forEach(x=>{if(!groups[x.date])groups[x.date]=[];groups[x.date].push(x);});
    let html='';
    Object.keys(groups).sort((a,b)=>new Date(b)-new Date(a)).forEach(date=>{
        html+='<div class="date-group"><div class="date-group-header">'+fmtDateShort(date)+'</div>';
        groups[date].forEach(x=>{
            const isSimple=['sidon','steps','weight'].includes(x.type);
            let summary='';
            if(x.type==='sidon')summary='<strong>'+x.minutes+' mins</strong>';
            else if(x.type==='steps')summary='<strong>'+(x.steps||0).toLocaleString()+' steps</strong>';
            else if(x.type==='weight')summary='<strong>'+x.bodyWeight+' kg</strong>';
            else if(x.type==='run')summary='<strong>'+(x.distance||0)+'km</strong> in '+(x.runTime||0)+' mins';
            html+='<div class="workout-log-item '+x.profile+'"><div class="workout-log-icon">'+getIcon(x.type)+'</div><div class="workout-log-details"><div class="workout-log-header"><span class="workout-log-title">'+getTitle(x.type)+'</span><span class="workout-log-profile '+x.profile+'">'+(x.profile==='joel'?'Joel':'Rachel')+'</span></div><div class="workout-log-meta">'+fmtTime(x.time)+'</div>'+(isSimple||x.type==='run'?'<div class="workout-log-summary">'+summary+'</div>':'')+'</div><div class="workout-log-actions">'+(!isSimple&&x.type!=='run'?'<button class="details-btn" onclick="showDetails(\''+x.id+'\')">Details</button>':'')+'<button onclick="editW(\''+x.id+'\')">‚úèÔ∏è</button><button onclick="deleteW(\''+x.id+'\')">üóëÔ∏è</button></div></div>';
        });
        html+='</div>';
    });
    list.innerHTML=html;
}

$('closeDetails').addEventListener('click',()=>$('detailsModal').classList.remove('active'));
$('detailsModal').addEventListener('click',e=>{if(e.target.id==='detailsModal')$('detailsModal').classList.remove('active');});
$('detailsModal').addEventListener('touchend',e=>{if(e.target.id==='detailsModal'){e.preventDefault();$('detailsModal').classList.remove('active');}},{passive:false});
$('fabBtn').addEventListener('click',()=>$('logModal').classList.add('active'));
$('fabBtn').addEventListener('touchend',e=>{e.preventDefault();$('logModal').classList.add('active');});
$('closeLogModal').addEventListener('click',()=>$('logModal').classList.remove('active'));
$('logModal').addEventListener('click',e=>{if(e.target.id==='logModal')$('logModal').classList.remove('active');});
$('logModal').addEventListener('touchend',e=>{if(e.target.id==='logModal'){e.preventDefault();$('logModal').classList.remove('active');}},{passive:false});
$$('.log-option-btn').forEach(b=>b.addEventListener('click',()=>{$('logModal').classList.remove('active');openLog(b.dataset.log);}));
function openLog(type,edit=null){
    const c=$('logPages');const now=new Date();
    const dateVal=edit?.date||now.toISOString().split('T')[0];
    const timeVal=edit?.time||now.toTimeString().slice(0,5);
    state.logProfile=edit?.profile||'joel';
    const base=state.data.base?.[state.logProfile]||DEFAULT_BASE[state.logProfile];
    let content='<div class="card"><div class="card-title">üë§ Who\'s logging?</div><div class="profile-toggle"><button class="profile-toggle-btn joel '+(state.logProfile==='joel'?'active':'')+'" data-profile="joel">üíú Joel</button><button class="profile-toggle-btn rachel '+(state.logProfile==='rachel'?'active':'')+'" data-profile="rachel">ü©µ Rachel</button></div></div><div class="card"><div class="card-title">üìÖ Date & Time</div><div class="datetime-row"><input type="date" class="datetime-input" id="logDate" value="'+dateVal+'"><input type="time" class="datetime-input" id="logTime" value="'+timeVal+'"></div></div>';
    if(type==='sidon')content+='<div class="card"><div class="card-title">üêï Walk Duration</div><div class="simple-input-row"><span class="icon">‚è±Ô∏è</span><label>Minutes</label><input type="number" id="sidonMins" value="'+(edit?.minutes||base.sidonMins||10)+'"><span class="unit">mins</span></div></div>';
    else if(type==='steps')content+='<div class="card"><div class="card-title">üëü Steps</div><div class="simple-input-row"><span class="icon">üë£</span><label>Step count</label><input type="number" id="stepCount" value="'+(edit?.steps||base.steps||15000)+'"><span class="unit">steps</span></div></div>';
    else if(type==='weight')content+='<div class="card"><div class="card-title">‚öñÔ∏è Body Weight</div><div class="simple-input-row"><span class="icon">üßç</span><label>Weight</label><input type="number" id="bodyWeight" step="0.1" value="'+(edit?.bodyWeight||'')+'" placeholder="0.0"><span class="unit">kg</span></div></div>';
    else if(type==='run'){state.runType=edit?.runType||'outside';content+='<div class="card"><div class="card-title">üèÉ Run Type</div><div class="profile-toggle"><button class="run-type-btn '+(state.runType==='outside'?'active':'')+'" data-type="outside">üå≥ Outside</button><button class="run-type-btn '+(state.runType==='treadmill'?'active':'')+'" data-type="treadmill">üèÉ Treadmill</button></div></div><div class="card"><div class="card-title">üìè Distance & Time</div><div class="simple-input-row"><span class="icon">üìè</span><label>Distance</label><input type="number" id="runDistance" step="0.1" value="'+(edit?.distance||'')+'"><span class="unit">km</span></div><div class="simple-input-row" style="margin-top:0.75rem;"><span class="icon">‚è±Ô∏è</span><label>Time</label><input type="number" id="runTime" value="'+(edit?.runTime||'')+'"><span class="unit">mins</span></div></div>';}
    else if(['upper','lower','core'].includes(type)){const exs=base[type]||DEFAULT_BASE[state.logProfile][type];const editEx=edit?.exercises||{};content+='<div class="card"><div class="card-title">'+getIcon(type)+' Exercises</div><div id="exerciseList">'+renderExercises(exs,editEx,false)+'</div></div>';}
    else if(type==='custom'){const allEx={...(base.upper||DEFAULT_BASE[state.logProfile].upper),...(base.lower||DEFAULT_BASE[state.logProfile].lower),...(base.core||DEFAULT_BASE[state.logProfile].core)};const editEx=edit?.exercises||{};content+='<div class="card"><div class="card-title">‚ö° Custom</div><div id="exerciseList">'+renderExercises(allEx,editEx,true)+'</div></div>';}
    c.innerHTML='<div class="log-page active" id="logPage_'+type+'"><div class="log-page-header"><button class="log-page-back" onclick="closeLog(\''+type+'\')">‚Üê</button><div class="log-page-title">'+(edit?'Edit':'Log')+' '+getTitle(type)+'</div></div><div class="log-page-content">'+content+'</div><div class="submit-btn"><button class="'+state.logProfile+'" id="submitLogBtn" onclick="submitLog(\''+type+'\','+(edit?'\''+edit.id+'\'':'null')+')">'+(edit?'Update':'Log')+' '+getTitle(type)+' üéâ</button></div></div>';
    c.querySelectorAll('.profile-toggle-btn').forEach(btn=>{btn.addEventListener('click',()=>{c.querySelectorAll('.profile-toggle-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');state.logProfile=btn.dataset.profile;$('submitLogBtn').className=state.logProfile;});});
    c.querySelectorAll('.run-type-btn').forEach(btn=>{btn.addEventListener('click',()=>{c.querySelectorAll('.run-type-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');state.runType=btn.dataset.type;});});
    attachToggleListeners();
}
function renderExercises(exs,editEx,startOff){return Object.entries(exs).map(([k,ex])=>{const ed=editEx[k]||{};const on=Object.keys(editEx).length>0?ed.on===1:(startOff?false:ex.on);return'<div class="exercise-item" data-ex="'+k+'"><div class="exercise-header"><span class="exercise-name">'+EX_NAMES[k]+'</span><button class="exercise-toggle '+(on?'active':'')+'" data-k="'+k+'"></button></div><div class="exercise-inputs '+(on?'':'disabled')+'" data-k="'+k+'"><div class="input-group"><label>Sets</label><input type="number" data-f="s" value="'+(ed.s??ex.s)+'"></div>'+(ex.m!==undefined?'<div class="input-group"><label>Mins</label><input type="number" data-f="m" value="'+(ed.m??ex.m)+'"></div>':'<div class="input-group"><label>Reps</label><input type="number" data-f="r" value="'+(ed.r??ex.r)+'"></div>')+(ex.w!=null?'<div class="input-group"><label>Kg</label><input type="number" data-f="w" step="0.5" value="'+(ed.w??ex.w)+'"></div>':'')+'</div></div>';}).join('');}
function attachToggleListeners(){const c=$('logPages');c.querySelectorAll('.exercise-toggle').forEach(t=>{t.onclick=()=>{t.classList.toggle('active');c.querySelector('.exercise-inputs[data-k="'+t.dataset.k+'"]').classList.toggle('disabled',!t.classList.contains('active'));};});}
window.closeLog=t=>{const p=$('logPage_'+t);if(p)p.remove();};
window.submitLog=async(type,editId)=>{const date=$('logDate').value,time=$('logTime').value;let w={id:editId||genId(),profile:state.logProfile,type,date,time,timestamp:new Date(date+'T'+time).toISOString()};if(type==='sidon')w.minutes=parseInt($('sidonMins').value)||0;else if(type==='steps')w.steps=parseInt($('stepCount').value)||0;else if(type==='weight')w.bodyWeight=parseFloat($('bodyWeight').value)||0;else if(type==='run'){w.runType=state.runType;w.distance=parseFloat($('runDistance').value)||0;w.runTime=parseInt($('runTime').value)||0;}else{const exs={};document.querySelectorAll('.exercise-item').forEach(item=>{const k=item.dataset.ex,tog=item.querySelector('.exercise-toggle'),on=tog.classList.contains('active');if(!on)return;exs[k]={on:1};item.querySelectorAll('.exercise-inputs input').forEach(inp=>{const f=inp.dataset.f,v=f==='w'?parseFloat(inp.value):parseInt(inp.value);if(!isNaN(v))exs[k][f]=v;});});w.exercises=exs;}if(!state.data.workouts)state.data.workouts=[];if(editId){const i=state.data.workouts.findIndex(x=>x.id===editId);if(i!==-1)state.data.workouts[i]=w;}else state.data.workouts.push(w);checkBadges();const ok=await saveData();if(ok){showToast(editId?'Updated!':'Logged! üí™');closeLog(type);renderList();}else showToast('Failed to save',true);};


$('cancelDelete').addEventListener('click',()=>{$('deleteModal').classList.remove('active');state.deleteId=null;});
$('confirmDelete').addEventListener('click',async()=>{if(state.deleteId){state.data.workouts=state.data.workouts.filter(x=>x.id!==state.deleteId);checkBadges();if(await saveData()){showToast('Deleted');renderList();}else showToast('Failed',true);}$('deleteModal').classList.remove('active');state.deleteId=null;});

function checkBadges(){
const newBadges={};
BADGES.forEach(b=>{
const joelHas=b.check(state.data,'joel');
const rachelHas=b.check(state.data,'rachel');
if(joelHas||rachelHas){
const oldBadge=state.data.badges?.[b.id];
if(joelHas&&rachelHas){
if(oldBadge&&oldBadge.first){newBadges[b.id]={first:oldBadge.first,second:oldBadge.first==='joel'?'rachel':'joel'};}
else{newBadges[b.id]={first:'joel',second:'rachel'};}
}else if(joelHas){newBadges[b.id]={first:'joel'};}
else if(rachelHas){newBadges[b.id]={first:'rachel'};}
}});
state.data.badges=newBadges;
}
function renderCal(){const y=state.month.getFullYear(),m=state.month.getMonth();$('calendarMonth').textContent=state.month.toLocaleDateString('en-US',{month:'long',year:'numeric'});const first=new Date(y,m,1).getDay(),days=new Date(y,m+1,0).getDate(),today=new Date();let html='';for(let i=0;i<first;i++)html+='<div class="calendar-day empty"><span class="date"></span><div class="indicator-wrap"></div></div>';for(let d=1;d<=days;d++){const ds=y+'-'+String(m+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');const isToday=today.getFullYear()===y&&today.getMonth()===m&&today.getDate()===d;const dw=(state.data.workouts||[]).filter(w=>w.date===ds);let joelHas=false,rachelHas=false;if(state.calFilter==='all'){joelHas=dw.some(w=>w.profile==='joel');rachelHas=dw.some(w=>w.profile==='rachel');}else{const f=dw.filter(w=>w.type===state.calFilter);joelHas=f.some(w=>w.profile==='joel');rachelHas=f.some(w=>w.profile==='rachel');}let indicator='';if(joelHas||rachelHas)indicator='<div class="indicator-circle">'+(joelHas?'<div class="half-left joel"></div>':'<div class="half-left"></div>')+(rachelHas?'<div class="half-right rachel"></div>':'<div class="half-right"></div>')+'</div>';html+='<div class="calendar-day '+(isToday?'today':'')+'"><span class="date">'+d+'</span><div class="indicator-wrap">'+indicator+'</div></div>';}$('calendarDays').innerHTML=html;}
$('prevMonth').addEventListener('click',()=>{state.month.setMonth(state.month.getMonth()-1);renderCal();});
$('nextMonth').addEventListener('click',()=>{state.month.setMonth(state.month.getMonth()+1);renderCal();});
$$('#calendarFilter button').forEach(b=>b.addEventListener('click',()=>{$$('#calendarFilter button').forEach(x=>x.classList.remove('active'));b.classList.add('active');state.calFilter=b.dataset.filter;renderCal();}));
$('exerciseSelect').addEventListener('change',()=>{state.chartExercise=$('exerciseSelect').value;updateMetricTogglesVisibility();renderChart();});
$$('#timeFilter button').forEach(b=>b.addEventListener('click',()=>{$$('#timeFilter button').forEach(x=>x.classList.remove('active'));b.classList.add('active');state.chartRange=b.dataset.range;renderChart();}));
$$('.metric-toggle').forEach(b=>b.addEventListener('click',()=>{b.classList.toggle('active');state.chartMetrics[b.dataset.metric]=b.classList.contains('active');renderChart();}));
$$('.stats-profile-btn').forEach(b=>b.addEventListener('click',()=>{$$('.stats-profile-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');state.chartProfile=b.dataset.profile;renderChart();}));
function updateMetricTogglesVisibility(){const isSimple=['bodyWeight','steps','sidon','run'].includes(state.chartExercise);$('metricToggles').style.display=isSimple?'none':'flex';}
function renderChart(){const canvas=$('statsChart'),ctx=canvas.getContext('2d');const rect=canvas.parentElement.getBoundingClientRect();canvas.width=rect.width*2;canvas.height=rect.height*2;ctx.scale(2,2);const W=rect.width,H=rect.height,pad={t:20,r:15,b:35,l:45};ctx.clearRect(0,0,W,H);const now=new Date();let start,dateLabels=[];switch(state.chartRange){case'week':start=new Date(now-6*24*60*60*1000);for(let i=0;i<7;i++){const d=new Date(start.getTime()+i*24*60*60*1000);dateLabels.push({date:d,label:d.toLocaleDateString('en-US',{weekday:'short'})});}break;case'month':start=new Date(now-29*24*60*60*1000);[0,7,14,21,29].forEach(i=>{const d=new Date(start.getTime()+i*24*60*60*1000);dateLabels.push({date:d,label:d.toLocaleDateString('en-US',{month:'short',day:'numeric'})});});break;case'year':start=new Date(now-364*24*60*60*1000);for(let i=0;i<12;i++){const d=new Date(start.getTime()+i*30*24*60*60*1000);dateLabels.push({date:d,label:d.toLocaleDateString('en-US',{month:'short'})});}break;default:start=new Date(0);dateLabels=[{date:start,label:'Start'},{date:now,label:'Now'}];}const ex=state.chartExercise;const isSimple=['bodyWeight','steps','sidon','run'].includes(ex);const COLORS={rachel:{weight:'#ef4444',reps:'#3b82f6',sets:'#eab308'},joel:{weight:'#22c55e',reps:'#f97316',sets:'#a855f7'}};
function getData(profile,metric){let ws=(state.data.workouts||[]).filter(w=>w.profile===profile&&new Date(w.timestamp)>=start);if(ex==='bodyWeight')return ws.filter(w=>w.type==='weight'&&w.bodyWeight).map(w=>({x:new Date(w.timestamp),y:w.bodyWeight}));if(ex==='steps')return ws.filter(w=>w.type==='steps'&&w.steps).map(w=>({x:new Date(w.timestamp),y:w.steps}));if(ex==='sidon')return ws.filter(w=>w.type==='sidon'&&w.minutes).map(w=>({x:new Date(w.timestamp),y:w.minutes}));if(ex==='run')return ws.filter(w=>w.type==='run'&&w.distance).map(w=>({x:new Date(w.timestamp),y:w.distance}));return ws.filter(w=>w.exercises&&w.exercises[ex]).map(w=>{const e=w.exercises[ex];let v=0;if(metric==='weight')v=e.w||0;else if(metric==='reps')v=e.r||e.m||0;else if(metric==='sets')v=e.s||0;return{x:new Date(w.timestamp),y:v};}).filter(d=>d.y>0);}
const series=[];const showJoel=state.chartProfile==='joel'||state.chartProfile==='both';const showRachel=state.chartProfile==='rachel'||state.chartProfile==='both';
if(isSimple){if(showJoel)series.push({data:getData('joel','weight').sort((a,b)=>a.x-b.x),color:'#7c3aed',label:'Joel'});if(showRachel)series.push({data:getData('rachel','weight').sort((a,b)=>a.x-b.x),color:'#06b6d4',label:'Rachel',dash:state.chartProfile==='both'?[5,5]:null});}
else{['weight','reps','sets'].forEach(metric=>{if(state.chartMetrics[metric]){if(showJoel)series.push({data:getData('joel',metric).sort((a,b)=>a.x-b.x),color:COLORS.joel[metric],label:'Joel '+metric});if(showRachel)series.push({data:getData('rachel',metric).sort((a,b)=>a.x-b.x),color:COLORS.rachel[metric],label:'Rachel '+metric,dash:state.chartProfile==='both'?[5,5]:null});}});}
const allData=series.flatMap(s=>s.data);if(!allData.length){ctx.fillStyle='#64748b';ctx.font='14px system-ui';ctx.textAlign='center';ctx.fillText('No data yet',W/2,H/2);return;}
let minY=Math.min(...allData.map(d=>d.y)),maxY=Math.max(...allData.map(d=>d.y));const range=maxY-minY||1;minY=Math.floor((minY-range*0.1)*2)/2;maxY=Math.ceil((maxY+range*0.1)*2)/2;if(minY<0)minY=0;
const cW=W-pad.l-pad.r,cH=H-pad.t-pad.b;const sx=x=>pad.l+(x-start)/(now-start)*cW;const sy=y=>pad.t+cH-(y-minY)/(maxY-minY)*cH;
ctx.strokeStyle='#2d2d4a';ctx.lineWidth=1;const steps=5;for(let i=0;i<=steps;i++){const y=pad.t+(cH/steps)*i;const val=maxY-(maxY-minY)*(i/steps);ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(W-pad.r,y);ctx.stroke();ctx.fillStyle='#64748b';ctx.font='10px system-ui';ctx.textAlign='right';ctx.fillText(val%1===0?val.toString():val.toFixed(1),pad.l-5,y+3);}
ctx.fillStyle='#64748b';ctx.font='9px system-ui';ctx.textAlign='center';dateLabels.forEach(dl=>{const x=sx(dl.date);if(x>=pad.l&&x<=W-pad.r)ctx.fillText(dl.label,x,H-pad.b+15);});
series.forEach(s=>{if(!s.data.length)return;ctx.strokeStyle=s.color;ctx.lineWidth=2.5;ctx.lineCap='round';ctx.lineJoin='round';if(s.dash)ctx.setLineDash(s.dash);else ctx.setLineDash([]);ctx.beginPath();s.data.forEach((d,i)=>{const x=Math.max(pad.l,Math.min(W-pad.r,sx(d.x)));const y=Math.max(pad.t,Math.min(H-pad.b,sy(d.y)));if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);});ctx.stroke();ctx.setLineDash([]);s.data.forEach(d=>{const x=Math.max(pad.l,Math.min(W-pad.r,sx(d.x)));const y=Math.max(pad.t,Math.min(H-pad.b,sy(d.y)));ctx.beginPath();ctx.arc(x,y,4,0,Math.PI*2);ctx.fillStyle=s.color;ctx.fill();});});}
updateMetricTogglesVisibility();
function renderRewards(){const now=state.rewardsMonth;$('rewardsMonth').textContent=now.toLocaleDateString('en-US',{month:'long',year:'numeric'});renderWeeklyAwards();renderMonthlyAwards();renderAnnualAwards();renderBadges();}
function renderWeeklyAwards(){const weekStart=getWeekStart(state.awardsWeek);const weekEnd=new Date(weekStart);weekEnd.setDate(weekEnd.getDate()+6);$('weekLabel').textContent=weekStart.toLocaleDateString('en-US',{month:'short',day:'numeric'})+' - '+weekEnd.toLocaleDateString('en-US',{month:'short',day:'numeric'});const ws=p=>state.data.workouts.filter(x=>{const d=new Date(x.date);return d>=weekStart&&d<=weekEnd&&x.profile===p;});const morningWs=p=>ws(p).filter(x=>x.time&&parseInt(x.time.split(':')[0])<9).length;const eveningWs=p=>ws(p).filter(x=>x.time&&parseInt(x.time.split(':')[0])>=18).length;const sidonMins=p=>ws(p).filter(x=>x.type==='sidon').reduce((s,x)=>s+(x.minutes||0),0);const activeMins=p=>sidonMins(p)+ws(p).filter(x=>x.type==='run').reduce((s,x)=>s+(x.runTime||0),0);const baseAwards=[
{icon:'üí™',name:'Gym Rat',desc:'Most strength workouts',joel:ws('joel').filter(x=>['upper','lower','core','custom'].includes(x.type)).length,rachel:ws('rachel').filter(x=>['upper','lower','core','custom'].includes(x.type)).length},
{icon:'üèÉ',name:'Runner',desc:'Most runs',joel:ws('joel').filter(x=>x.type==='run').length,rachel:ws('rachel').filter(x=>x.type==='run').length},
{icon:'üìè',name:'Distance King',desc:'Most km run',joel:ws('joel').filter(x=>x.type==='run').reduce((s,x)=>s+(x.distance||0),0),rachel:ws('rachel').filter(x=>x.type==='run').reduce((s,x)=>s+(x.distance||0),0)},
{icon:'üî•',name:'Consistency Crown',desc:'4 workouts in the week',joel:ws('joel').filter(x=>['upper','lower','core','custom','run'].includes(x.type)).length>=4?1:0,rachel:ws('rachel').filter(x=>['upper','lower','core','custom','run'].includes(x.type)).length>=4?1:0},
{icon:'üéØ',name:'All-Rounder',desc:'Upper+Lower+Core done',joel:ws('joel').some(x=>x.type==='upper')&&ws('joel').some(x=>x.type==='lower')&&ws('joel').some(x=>x.type==='core')?1:0,rachel:ws('rachel').some(x=>x.type==='upper')&&ws('rachel').some(x=>x.type==='lower')&&ws('rachel').some(x=>x.type==='core')?1:0},
{icon:'üëü',name:'Step in Time',desc:'Most steps',joel:ws('joel').filter(x=>x.type==='steps').reduce((s,x)=>s+(x.steps||0),0),rachel:ws('rachel').filter(x=>x.type==='steps').reduce((s,x)=>s+(x.steps||0),0)},
{icon:'üèãÔ∏è',name:'Setup for Success',desc:'Most total sets',joel:ws('joel').filter(x=>x.exercises).reduce((s,x)=>s+Object.values(x.exercises).reduce((ss,e)=>ss+(e.s||0),0),0),rachel:ws('rachel').filter(x=>x.exercises).reduce((s,x)=>s+Object.values(x.exercises).reduce((ss,e)=>ss+(e.s||0),0),0)},
{icon:'‚è∞',name:'Early Riser',desc:'Most morning workouts',joel:morningWs('joel'),rachel:morningWs('rachel')},
{icon:'üåô',name:'Night Grinder',desc:'Most evening workouts',joel:eveningWs('joel'),rachel:eveningWs('rachel')},
{icon:'‚ö°',name:'Busiest Bee',desc:'Most workout days',joel:[...new Set(ws('joel').filter(x=>['upper','lower','core','custom','run'].includes(x.type)).map(x=>x.date))].length,rachel:[...new Set(ws('rachel').filter(x=>['upper','lower','core','custom','run'].includes(x.type)).map(x=>x.date))].length},
{icon:'üî•',name:'Calorie Crusher',desc:'Most active minutes',joel:activeMins('joel'),rachel:activeMins('rachel')},
{icon:'üêï',name:'Sneaky Sidon',desc:'Most Sidon minutes',joel:sidonMins('joel'),rachel:sidonMins('rachel')}
];
let joelWins=0,rachelWins=0;
baseAwards.forEach(a=>{if(a.joel>a.rachel)joelWins++;else if(a.rachel>a.joel)rachelWins++;});
const awards=[{icon:'üëë',name:'Weekly Winner',desc:'Most awards earned this week',joel:joelWins,rachel:rachelWins},...baseAwards];
$('weeklyAwardsList').innerHTML=awards.map(a=>{let leader='tie',lc='tie';if(a.joel>a.rachel){leader='Joel';lc='joel';}else if(a.rachel>a.joel){leader='Rachel';lc='rachel';}return'<div class="award-card" onclick="showAward(\''+a.name+'\',\''+a.icon+'\',\''+a.desc+'\','+a.joel+','+a.rachel+',\'weekly\')"><div class="award-card-header"><span class="award-card-icon">'+a.icon+'</span><span class="award-card-title">'+a.name+'</span><span class="award-card-leader '+lc+'">'+leader+'</span></div><div class="award-card-progress"><span>Joel: '+a.joel+'</span><span>Rachel: '+a.rachel+'</span></div></div>';}).join('');}
function renderMonthlyAwards(){const monthStart=getMonthStart(state.awardsMonth);const monthEnd=new Date(monthStart.getFullYear(),monthStart.getMonth()+1,0);$('monthLabel').textContent=monthStart.toLocaleDateString('en-US',{month:'long',year:'numeric'});const ws=p=>state.data.workouts.filter(x=>{const d=new Date(x.date);return d>=monthStart&&d<=monthEnd&&x.profile===p;});const totalSets=p=>ws(p).filter(x=>x.exercises).reduce((s,x)=>s+Object.values(x.exercises).reduce((ss,e)=>ss+(e.s||0),0),0);const workoutTypes=p=>[...new Set(ws(p).map(x=>x.type))].length;const bestType=p=>{const counts={};ws(p).forEach(x=>{counts[x.type]=(counts[x.type]||0)+1;});return Math.max(0,...Object.values(counts));};const sidonMins=p=>ws(p).filter(x=>x.type==='sidon').reduce((s,x)=>s+(x.minutes||0),0);const baseAwards=[
{icon:'‚úÖ',name:'Perfect Attendance',desc:'Longest streak this month',joel:getMonthStreak(state.data,'joel',monthStart,monthEnd),rachel:getMonthStreak(state.data,'rachel',monthStart,monthEnd)},
{icon:'üî•',name:'Iron Will',desc:'Days with workouts',joel:[...new Set(ws('joel').filter(x=>['upper','lower','core','custom','run'].includes(x.type)).map(x=>x.date))].length,rachel:[...new Set(ws('rachel').filter(x=>['upper','lower','core','custom','run'].includes(x.type)).map(x=>x.date))].length},
{icon:'üèãÔ∏è',name:'Volume Monarch',desc:'Total sets completed',joel:totalSets('joel'),rachel:totalSets('rachel')},
{icon:'üëü',name:'Step Master',desc:'Most total steps',joel:ws('joel').filter(x=>x.type==='steps').reduce((s,x)=>s+(x.steps||0),0),rachel:ws('rachel').filter(x=>x.type==='steps').reduce((s,x)=>s+(x.steps||0),0)},
{icon:'üèÉ',name:'Marathon Month',desc:'Most km run',joel:ws('joel').filter(x=>x.type==='run').reduce((s,x)=>s+(x.distance||0),0),rachel:ws('rachel').filter(x=>x.type==='run').reduce((s,x)=>s+(x.distance||0),0)},
{icon:'üåü',name:'Variety Star',desc:'Most workout types',joel:workoutTypes('joel'),rachel:workoutTypes('rachel')},
{icon:'üí™',name:'Strength Supreme',desc:'Most strength workouts',joel:ws('joel').filter(x=>['upper','lower','core','custom'].includes(x.type)).length,rachel:ws('rachel').filter(x=>['upper','lower','core','custom'].includes(x.type)).length},
{icon:'üéØ',name:'Focused Fighter',desc:'Best single-type commitment',joel:bestType('joel'),rachel:bestType('rachel')},
{icon:'üèÜ',name:'Weekly Dominator',desc:'Most weekly awards won',joel:0,rachel:0},
{icon:'üìà',name:'Gains Train',desc:'Biggest weight increase',joel:0,rachel:0},
{icon:'üìà',name:'Rep-co',desc:'Biggest rep increase',joel:0,rachel:0},
{icon:'üêï',name:'Swift Sidon',desc:'Most Sidon minutes',joel:sidonMins('joel'),rachel:sidonMins('rachel')}
];
let joelWins=0,rachelWins=0;
baseAwards.forEach(a=>{if(a.joel>a.rachel)joelWins++;else if(a.rachel>a.joel)rachelWins++;});
const awards=[{icon:'üëë',name:'Monthly MVP',desc:'Most awards earned this month',joel:joelWins,rachel:rachelWins},...baseAwards];
$('monthlyAwardsList').innerHTML=awards.map(a=>{let leader='tie',lc='tie';if(a.joel>a.rachel){leader='Joel';lc='joel';}else if(a.rachel>a.joel){leader='Rachel';lc='rachel';}return'<div class="award-card" onclick="showAward(\''+a.name+'\',\''+a.icon+'\',\''+a.desc+'\','+a.joel+','+a.rachel+',\'monthly\')"><div class="award-card-header"><span class="award-card-icon">'+a.icon+'</span><span class="award-card-title">'+a.name+'</span><span class="award-card-leader '+lc+'">'+leader+'</span></div><div class="award-card-progress"><span>Joel: '+a.joel+'</span><span>Rachel: '+a.rachel+'</span></div></div>';}).join('');}

function renderAnnualAwards(){const year=state.awardsYear;const yearStart=new Date(year,0,1);const yearEnd=new Date(year,11,31);$('yearLabel').textContent=year.toString();const ws=p=>state.data.workouts.filter(x=>{const d=new Date(x.date);return d>=yearStart&&d<=yearEnd&&x.profile===p;});const totalSets=p=>ws(p).filter(x=>x.exercises).reduce((s,x)=>s+Object.values(x.exercises).reduce((ss,e)=>ss+(e.s||0),0),0);const morningWs=p=>ws(p).filter(x=>x.time&&parseInt(x.time.split(':')[0])<9).length;const eveningWs=p=>ws(p).filter(x=>x.time&&parseInt(x.time.split(':')[0])>=18).length;const sidonMins=p=>ws(p).filter(x=>x.type==='sidon').reduce((s,x)=>s+(x.minutes||0),0);const activeMins=p=>sidonMins(p)+ws(p).filter(x=>x.type==='run').reduce((s,x)=>s+(x.runTime||0),0);const bestType=p=>{const counts={};ws(p).forEach(x=>{counts[x.type]=(counts[x.type]||0)+1;});return Math.max(0,...Object.values(counts));};const baseAwards=[
{icon:'‚≠ê',name:'Weekly Wonder',desc:'Most Weekly Winner wins',joel:0,rachel:0},
{icon:'üåü',name:'Monthly Mountaineer',desc:'Most Monthly MVP wins',joel:0,rachel:0},
{icon:'üí™',name:'Gym Monster',desc:'Most strength workouts',joel:ws('joel').filter(x=>['upper','lower','core','custom'].includes(x.type)).length,rachel:ws('rachel').filter(x=>['upper','lower','core','custom'].includes(x.type)).length},
{icon:'üèÉ',name:'Sprinter',desc:'Most runs',joel:ws('joel').filter(x=>x.type==='run').length,rachel:ws('rachel').filter(x=>x.type==='run').length},
{icon:'üìè',name:'Distance Dominator',desc:'Most km run',joel:ws('joel').filter(x=>x.type==='run').reduce((s,x)=>s+(x.distance||0),0),rachel:ws('rachel').filter(x=>x.type==='run').reduce((s,x)=>s+(x.distance||0),0)},
{icon:'üî•',name:'Consistently Crushing',desc:'Longest streak this year',joel:getMaxStreak(state.data,'joel'),rachel:getMaxStreak(state.data,'rachel')},
{icon:'üéØ',name:'All-Star',desc:'Most All-Rounder wins',joel:0,rachel:0},
{icon:'üëü',name:'Step Champion',desc:'Most steps',joel:ws('joel').filter(x=>x.type==='steps').reduce((s,x)=>s+(x.steps||0),0),rachel:ws('rachel').filter(x=>x.type==='steps').reduce((s,x)=>s+(x.steps||0),0)},
{icon:'üèãÔ∏è',name:'Volume Emperor',desc:'Most total sets',joel:totalSets('joel'),rachel:totalSets('rachel')},
{icon:'üåÖ',name:'Early Hawk',desc:'Most morning workouts',joel:morningWs('joel'),rachel:morningWs('rachel')},
{icon:'ü¶â',name:'Night Owl',desc:'Most evening workouts',joel:eveningWs('joel'),rachel:eveningWs('rachel')},
{icon:'üëë',name:'Queen Bee',desc:'Most workout days',joel:[...new Set(ws('joel').filter(x=>['upper','lower','core','custom','run'].includes(x.type)).map(x=>x.date))].length,rachel:[...new Set(ws('rachel').filter(x=>['upper','lower','core','custom','run'].includes(x.type)).map(x=>x.date))].length},
{icon:'üî•',name:'Calorie Crusher',desc:'Most active minutes',joel:activeMins('joel'),rachel:activeMins('rachel')},
{icon:'üéØ',name:'Fixated Fighter',desc:'Best single-type commitment',joel:bestType('joel'),rachel:bestType('rachel')},
{icon:'üìà',name:'Gains Galore',desc:'Biggest weight increase',joel:0,rachel:0},
{icon:'üíπ',name:'Rep-el Alliance',desc:'Biggest rep increase',joel:0,rachel:0},
{icon:'üêï',name:'Super Sidon',desc:'Most Sidon minutes',joel:sidonMins('joel'),rachel:sidonMins('rachel')}
];
let joelWins=0,rachelWins=0;
baseAwards.forEach(a=>{if(a.joel>a.rachel)joelWins++;else if(a.rachel>a.joel)rachelWins++;});
const awards=[{icon:'üèÜ',name:'Annual Achiever',desc:'Most awards won this year',joel:joelWins,rachel:rachelWins},...baseAwards];
$('annualAwardsList').innerHTML=awards.map(a=>{let leader='tie',lc='tie';if(a.joel>a.rachel){leader='Joel';lc='joel';}else if(a.rachel>a.joel){leader='Rachel';lc='rachel';}return'<div class="award-card" onclick="showAward(\''+a.name+'\',\''+a.icon+'\',\''+a.desc+'\','+a.joel+','+a.rachel+',\'annual\')"><div class="award-card-header"><span class="award-card-icon">'+a.icon+'</span><span class="award-card-title">'+a.name+'</span><span class="award-card-leader '+lc+'">'+leader+'</span></div><div class="award-card-progress"><span>Joel: '+a.joel+'</span><span>Rachel: '+a.rachel+'</span></div></div>';}).join('');}
function renderBadges(){if(!state.data.badges)state.data.badges={};let joelGold=0,joelSilver=0,rachelGold=0,rachelSilver=0;BADGES.forEach(b=>{const badge=state.data.badges[b.id];if(badge){if(badge.first==='joel'){joelGold++;if(badge.second==='rachel')rachelSilver++;}else if(badge.first==='rachel'){rachelGold++;if(badge.second==='joel')joelSilver++;}}});const medalSummary='<div class="medal-summary"><div class="medal-person joel"><span class="medal-name">üíú Joel</span><span class="medal-count">ü•á'+joelGold+' ü•à'+joelSilver+'</span></div><div class="medal-person rachel"><span class="medal-name">ü©µ Rachel</span><span class="medal-count">ü•á'+rachelGold+' ü•à'+rachelSilver+'</span></div></div>';$('panelBadges').innerHTML=medalSummary+'<div class="badge-grid">'+BADGES.map(b=>{const badge=state.data.badges[b.id];const first=badge?.first;const second=badge?.second;let medals='';if(first)medals+='<span class="badge-medal gold">'+(first==='joel'?'J':'R')+'</span>';if(second)medals+='<span class="badge-medal silver">'+(second==='joel'?'J':'R')+'</span>';return'<div class="badge-item '+(first?'earned':'locked')+'" onclick="showBadge('+b.id+')"><div class="badge-icon">'+b.icon+'</div><div class="badge-name">'+b.name+'</div>'+(medals?'<div class="badge-medals">'+medals+'</div>':'')+'</div>';}).join('')+'</div>';}


window.showAward=(name,icon,desc,joel,rachel,type)=>{
    let winner='tie',winnerName="It's a tie!";
    if(joel>rachel){winner='joel';winnerName='üëë Joel wins!';}
    else if(rachel>joel){winner='rachel';winnerName='üëë Rachel wins!';}
    $('awardModalTitle').textContent=icon+' '+name;
    $('awardModalContent').innerHTML='<p style="color:var(--text-secondary);margin-bottom:1rem;">'+desc+'</p><div style="display:flex;justify-content:space-around;margin-bottom:1rem;"><div style="text-align:center;"><div style="font-size:1.5rem;font-weight:700;color:var(--joel-primary);">'+joel+'</div><div style="font-size:0.85rem;color:var(--text-muted);">üíú Joel</div></div><div style="text-align:center;"><div style="font-size:1.5rem;font-weight:700;color:var(--rachel-primary);">'+rachel+'</div><div style="font-size:0.85rem;color:var(--text-muted);">ü©µ Rachel</div></div></div><div style="text-align:center;font-weight:700;font-size:1.1rem;color:'+(winner==='joel'?'var(--joel-primary)':winner==='rachel'?'var(--rachel-primary)':'var(--warning)')+';">'+winnerName+'</div>';
    $('awardModal').classList.add('active');
};
$('closeAward').addEventListener('click',()=>$('awardModal').classList.remove('active'));
$('awardModal').addEventListener('click',e=>{if(e.target.id==='awardModal')$('awardModal').classList.remove('active');});
$('awardModal').addEventListener('touchend',e=>{if(e.target.id==='awardModal'){e.preventDefault();$('awardModal').classList.remove('active');}},{passive:false});
$('closeBadge').addEventListener('click',()=>$('badgeModal').classList.remove('active'));
$('badgeModal').addEventListener('click',e=>{if(e.target.id==='badgeModal')$('badgeModal').classList.remove('active');});
$('badgeModal').addEventListener('touchend',e=>{if(e.target.id==='badgeModal'){e.preventDefault();$('badgeModal').classList.remove('active');}},{passive:false});

$('rewardsPrevMonth').addEventListener('click',()=>{state.rewardsMonth.setMonth(state.rewardsMonth.getMonth()-1);renderRewards();});
$('rewardsNextMonth').addEventListener('click',()=>{state.rewardsMonth.setMonth(state.rewardsMonth.getMonth()+1);renderRewards();});
$('prevWeek').addEventListener('click',()=>{state.awardsWeek.setDate(state.awardsWeek.getDate()-7);renderWeeklyAwards();});
$('nextWeek').addEventListener('click',()=>{state.awardsWeek.setDate(state.awardsWeek.getDate()+7);renderWeeklyAwards();});
$('prevAwardMonth').addEventListener('click',()=>{state.awardsMonth.setMonth(state.awardsMonth.getMonth()-1);renderMonthlyAwards();});

$('prevYear').addEventListener('click',()=>{state.awardsYear--;renderAnnualAwards();});
$('nextYear').addEventListener('click',()=>{state.awardsYear++;renderAnnualAwards();});
$('nextAwardMonth').addEventListener('click',()=>{state.awardsMonth.setMonth(state.awardsMonth.getMonth()+1);renderMonthlyAwards();});

$$('.rewards-tab').forEach(t=>t.addEventListener('click',()=>{



$$('.rewards-tab').forEach(x=>x.classList.remove('active'));$$('.rewards-panel').forEach(x=>x.classList.remove('active'));t.classList.add('active');$('panel'+t.dataset.tab.charAt(0).toUpperCase()+t.dataset.tab.slice(1)).classList.add('active');}));
$('settingsBtn').addEventListener('click',()=>{$('patInput').value=state.pat;state.settingsProfile='joel';renderBaseSettings();$$('#settingsPanelBase .settings-profile-btn').forEach(b=>{b.classList.remove('active');if(b.dataset.profile==='joel')b.classList.add('active');});$('settingsModal').classList.add('active');loadBackupList();});
$$('.settings-tab').forEach(t=>t.addEventListener('click',()=>{$$('.settings-tab').forEach(x=>x.classList.remove('active'));$$('.settings-panel').forEach(x=>x.classList.remove('active'));t.classList.add('active');$('settingsPanel'+t.dataset.tab.charAt(0).toUpperCase()+t.dataset.tab.slice(1)).classList.add('active');}));
$$('#settingsPanelBase .settings-profile-btn').forEach(b=>b.addEventListener('click',()=>{$$('#settingsPanelBase .settings-profile-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');state.settingsProfile=b.dataset.profile;renderBaseSettings();}));
function renderBaseSettings(){const p=state.settingsProfile;const base=state.data.base?.[p]||DEFAULT_BASE[p];let html='<div class="base-settings-group"><div class="base-settings-group-title">General</div><div class="base-setting-row"><label>üêï Sidon (mins)</label><input type="number" data-key="sidonMins" value="'+(base.sidonMins||10)+'"></div><div class="base-setting-row"><label>üëü Steps</label><input type="number" data-key="steps" value="'+(base.steps||15000)+'"></div></div><div class="base-settings-group"><div class="base-settings-group-title">üí™ Upper</div>'+renderBaseExercises(base.upper||DEFAULT_BASE[p].upper,'upper')+'</div><div class="base-settings-group"><div class="base-settings-group-title">ü¶µ Lower</div>'+renderBaseExercises(base.lower||DEFAULT_BASE[p].lower,'lower')+'</div><div class="base-settings-group"><div class="base-settings-group-title">üéØ Core</div>'+renderBaseExercises(base.core||DEFAULT_BASE[p].core,'core')+'</div>';$('baseSettingsContent').innerHTML=html;}
function renderBaseExercises(exs,group){let html='<div class="base-ex-header"><span></span><span>Sets</span><span>Reps</span><span>Kg/Min</span></div>';Object.entries(exs).forEach(([k,ex])=>{let col3='';if(ex.m!==undefined)col3='<input type="number" data-group="'+group+'" data-ex="'+k+'" data-f="m" value="'+ex.m+'" placeholder="Min">';else if(ex.w!==null&&ex.w!==undefined)col3='<input type="number" data-group="'+group+'" data-ex="'+k+'" data-f="w" value="'+ex.w+'" placeholder="Kg">';else col3='<span class="na">-</span>';html+='<div class="base-setting-row"><label>'+EX_NAMES[k]+'</label><input type="number" data-group="'+group+'" data-ex="'+k+'" data-f="s" value="'+ex.s+'" placeholder="Sets">'+(ex.m!==undefined?'<span class="na">-</span>':'<input type="number" data-group="'+group+'" data-ex="'+k+'" data-f="r" value="'+ex.r+'" placeholder="Reps">')+col3+'</div>';});return html;}

$('cancelSettings').addEventListener('click',()=>$('settingsModal').classList.remove('active'));
$('saveSettings').addEventListener('click',async()=>{state.pat=$('patInput').value.trim();localStorage.setItem('github_pat',state.pat);const p=state.settingsProfile;if(!state.data.base)state.data.base=JSON.parse(JSON.stringify(DEFAULT_BASE));if(!state.data.base[p])state.data.base[p]=JSON.parse(JSON.stringify(DEFAULT_BASE[p]));const sidonInput=$('baseSettingsContent').querySelector('[data-key="sidonMins"]');const stepsInput=$('baseSettingsContent').querySelector('[data-key="steps"]');if(sidonInput)state.data.base[p].sidonMins=parseInt(sidonInput.value)||10;if(stepsInput)state.data.base[p].steps=parseInt(stepsInput.value)||15000;['upper','lower','core'].forEach(group=>{if(!state.data.base[p][group])state.data.base[p][group]=JSON.parse(JSON.stringify(DEFAULT_BASE[p][group]));$('baseSettingsContent').querySelectorAll('[data-group="'+group+'"]').forEach(inp=>{const ex=inp.dataset.ex,f=inp.dataset.f;if(!state.data.base[p][group][ex])return;const val=f==='w'?parseFloat(inp.value):parseInt(inp.value);if(!isNaN(val))state.data.base[p][group][ex][f]=val;});});$('settingsModal').classList.remove('active');showToast('Settings saved!');if(state.pat&&!CONFIG.REPO_OWNER)await loadData();else if(state.pat)await saveData();});
$('settingsModal').addEventListener('click',e=>{if(e.target.id==='settingsModal')$('settingsModal').classList.remove('active');});
$('settingsModal').addEventListener('touchend',e=>{if(e.target.id==='settingsModal'){e.preventDefault();$('settingsModal').classList.remove('active');}},{passive:false});
$('deleteModal').addEventListener('click',e=>{if(e.target.id==='deleteModal'){$('deleteModal').classList.remove('active');state.deleteId=null;}});
$('deleteModal').addEventListener('touchend',e=>{if(e.target.id==='deleteModal'){e.preventDefault();$('deleteModal').classList.remove('active');state.deleteId=null;}},{passive:false});

$('createMilestoneBtn').addEventListener('click',async()=>{
const name=$('milestoneNameInput').value.trim();
if(!name){showToast('Enter a name',true);return;}
$('createMilestoneBtn').textContent='Saving...';
const ok=await createMilestoneBackup(name);
$('createMilestoneBtn').textContent='üíæ Save';
if(ok){showToast('Milestone saved!');$('milestoneNameInput').value='';loadBackupList();}
else showToast('Backup failed',true);
});
$('restoreBtn').addEventListener('click',async()=>{
const file=$('restoreSelect').value;
if(!file){showToast('Select a backup',true);return;}
if(!confirm('Restore this backup? Current data will be overwritten.'))return;
$('restoreBtn').textContent='Restoring...';
const ok=await restoreBackup(file);
$('restoreBtn').textContent='üîÑ Restore';
if(ok){showToast('Restored!');$('settingsModal').classList.remove('active');}
else showToast('Restore failed',true);
});
async function loadBackupList(){
const sel=$('restoreSelect');
sel.innerHTML='<option value="">Loading...</option>';
const backups=await listBackups();
sel.innerHTML='<option value="">Select backup to restore...</option>';
backups.forEach(b=>{const opt=document.createElement('option');opt.value=b.file;opt.textContent=b.name;sel.appendChild(opt);});
}

function init(){setDate();if(localStorage.getItem('pin_verified')==='true'){$('pinScreen').classList.add('hidden');$('app').classList.add('active');loadData();}}
init();
</script>
</body>
</html>