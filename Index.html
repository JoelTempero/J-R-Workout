<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0d0d0d">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Tech Crew</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0d0d0d;
            --bg-card: #1a1a1a;
            --bg-input: #141414;
            --bg-elevated: #222222;
            --primary: #c41e3a;
            --primary-light: #e63950;
            --primary-dark: #8b1528;
            --gold: #d4a848;
            --gold-light: #f0c75e;
            --gold-dark: #a07830;
            --white: #ffffff;
            --text-primary: #f5f5f5;
            --text-secondary: #a0a0a0;
            --text-muted: #666666;
            --danger: #c41e3a;
            --success: #d4a848;
            --warning: #e6a23c;
            --border: rgba(255,255,255,0.08);
            --shadow: 0 4px 24px rgba(0,0,0,0.5);
            --app-max-width: 430px;
        }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        html { background:#000; }
        body { font-family:'Inter',system-ui,sans-serif; background:var(--bg-dark); color:var(--text-primary); min-height:100vh; min-height:100dvh; max-width:var(--app-max-width); margin:0 auto; position:relative; }
        @media (min-width: 431px) {
            body { border-left:1px solid var(--border); border-right:1px solid var(--border); box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        }
        input,textarea,select { -webkit-user-select:auto; user-select:auto; font-family:inherit; }
        .hidden { display:none!important; }
        button { min-height:48px; touch-action:manipulation; cursor:pointer; border:none; font-family:inherit; background:none; color:inherit; }
        
        /* Login Screen */
        .login-screen { position:fixed; inset:0; background:var(--bg-dark); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:1000; padding:2rem; }
        .login-logo { font-family:'Bebas Neue',sans-serif; font-size:3.5rem; letter-spacing:0.15em; margin-bottom:0.25rem; background:linear-gradient(135deg,var(--primary),var(--gold)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; word-spacing:0.2em; }
        .login-subtitle { color:var(--text-muted); margin-bottom:2rem; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.2em; }
        .login-step { display:none; flex-direction:column; align-items:center; width:100%; max-width:320px; }
        .login-step.active { display:flex; }
        .login-label { color:var(--text-secondary); margin-bottom:1.5rem; font-size:1rem; }
        .login-input { width:100%; background:var(--bg-card); border:2px solid var(--border); border-radius:12px; padding:1rem; color:var(--text-primary); font-size:1.1rem; text-align:center; margin-bottom:1rem; }
        .login-input:focus { outline:none; border-color:var(--primary); }
        .login-input::placeholder { color:var(--text-muted); }
        .pin-dots { display:flex; gap:1rem; margin-bottom:2rem; }
        .pin-dot { width:16px; height:16px; border-radius:50%; background:var(--bg-card); border:2px solid var(--text-muted); transition:all 0.2s; }
        .pin-dot.filled { background:var(--gold); border-color:var(--gold); }
        .pin-dot.error { background:var(--danger); border-color:var(--danger); animation:shake 0.5s; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }
        .pin-keypad { display:grid; grid-template-columns:repeat(3,1fr); gap:0.75rem; }
        .pin-key { width:68px; height:68px; border-radius:50%; background:var(--bg-card); color:var(--text-primary); font-size:1.5rem; font-weight:600; border:2px solid var(--border); transition:all 0.15s; }
        .pin-key:active { transform:scale(0.95); background:var(--bg-elevated); border-color:var(--gold); }
        .pin-key.empty { visibility:hidden; }
        .pin-key.backspace { font-size:1.25rem; }
        .login-back { margin-top:1.5rem; color:var(--text-muted); font-size:0.9rem; background:none; min-height:auto; padding:0.5rem 1rem; }
        .login-back:hover { color:var(--text-secondary); }
        .user-welcome { font-size:1.1rem; color:var(--gold); margin-bottom:0.5rem; font-weight:600; }
        
        /* App Container */
        .app { display:none; flex-direction:column; min-height:100vh; min-height:100dvh; padding-bottom:90px; }
        .app.active { display:flex; }
        
        /* Header */
        .header { padding:1rem 1.25rem; background:var(--bg-card); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:50; }
        .header-top { display:flex; align-items:center; justify-content:space-between; margin-bottom:0.5rem; }
        .header-logo { font-family:'Bebas Neue',sans-serif; font-size:1.5rem; letter-spacing:0.1em; color:var(--gold); }
        .header-user { display:flex; align-items:center; gap:0.5rem; }
        .header-user-name { font-size:0.85rem; color:var(--text-secondary); }
        .header-user-badge { font-size:0.65rem; padding:0.2rem 0.5rem; border-radius:4px; font-weight:600; text-transform:uppercase; }
        .header-user-badge.admin { background:var(--primary); color:var(--white); }
        .header-user-badge.master { background:linear-gradient(135deg,var(--gold),var(--gold-dark)); color:var(--bg-dark); }
        .header-user-badge.student { background:var(--gold-dark); color:var(--white); }
        .header-info { display:flex; gap:1rem; font-size:0.8rem; color:var(--text-muted); flex-wrap:wrap; }
        .header-info span { display:flex; align-items:center; gap:0.35rem; }
        .header-logout { background:var(--bg-input); border-radius:8px; padding:0.4rem 0.75rem; font-size:0.75rem; color:var(--text-secondary); min-height:32px; }
        
        /* Pages */
        .page { display:none; flex:1; padding:1rem; overflow-y:auto; padding-bottom:20px; }
        .page.active { display:block; }
        .page-title { font-family:'Bebas Neue',sans-serif; font-size:1.75rem; letter-spacing:0.05em; margin-bottom:1rem; color:var(--text-primary); }
        
        /* Cards */
        .card { background:var(--bg-card); border-radius:16px; padding:1.25rem; margin-bottom:1rem; border:1px solid var(--border); }
        .card-title { font-size:1rem; font-weight:700; margin-bottom:1rem; display:flex; align-items:center; gap:0.5rem; }
        
        /* Job Items */
        .job-item { background:var(--bg-input); border-radius:12px; padding:1rem; margin-bottom:0.75rem; border-left:4px solid var(--text-muted); cursor:pointer; transition:all 0.15s; }
        .job-item:active { transform:scale(0.98); }
        .job-item.setup { border-left-color:#f97316; }
        .job-item.event { border-left-color:var(--gold); }
        .job-item.assembly { border-left-color:#22c55e; }
        .job-item.training { border-left-color:var(--primary); }
        .job-item.meeting { border-left-color:#a855f7; }
        .job-item.maintenance { border-left-color:#3b82f6; }
        .job-item.other { border-left-color:#ec4899; }
        .job-header { display:flex; align-items:flex-start; justify-content:space-between; gap:0.5rem; margin-bottom:0.5rem; }
        .job-title { font-weight:700; font-size:1rem; flex:1; }
        .job-category { font-size:0.65rem; padding:0.2rem 0.5rem; border-radius:6px; font-weight:600; text-transform:uppercase; background:var(--bg-elevated); color:var(--text-secondary); }
        .job-meta { font-size:0.8rem; color:var(--text-muted); margin-bottom:0.5rem; }
        .job-crew { display:flex; flex-wrap:wrap; gap:0.35rem; }
        .job-crew-member { font-size:0.7rem; padding:0.2rem 0.5rem; border-radius:4px; background:var(--bg-elevated); color:var(--text-secondary); }
        .job-crew-empty { font-size:0.8rem; color:var(--text-muted); font-style:italic; }
        
        /* Task Items */
        .task-item { background:var(--bg-input); border-radius:12px; padding:1rem; margin-bottom:0.75rem; }
        .task-item.completed { opacity:0.6; }
        .task-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:0.5rem; }
        .task-title { font-weight:600; flex:1; }
        .task-status { font-size:0.7rem; padding:0.2rem 0.5rem; border-radius:6px; font-weight:600; }
        .task-status.pending { background:var(--bg-elevated); color:var(--text-muted); }
        .task-status.in-progress { background:rgba(212,168,72,0.2); color:var(--gold); }
        .task-status.marked-done { background:rgba(34,197,94,0.2); color:#22c55e; }
        .task-status.complete { background:rgba(212,168,72,0.3); color:var(--gold-light); }
        .task-meta { font-size:0.8rem; color:var(--text-muted); }
        
        /* Tips */
        .tip-filters { display:flex; flex-wrap:wrap; gap:0.5rem; margin-bottom:1rem; }
        .tip-filter { padding:0.4rem 0.75rem; border-radius:20px; font-size:0.75rem; font-weight:600; background:var(--bg-input); color:var(--text-secondary); border:1px solid var(--border); }
        .tip-filter.active { background:var(--gold); color:var(--bg-dark); border-color:var(--gold); }
        .tip-item { background:var(--bg-input); border-radius:12px; padding:1rem; margin-bottom:0.75rem; }
        .tip-title { font-weight:700; margin-bottom:0.5rem; }
        .tip-tags { display:flex; flex-wrap:wrap; gap:0.35rem; margin-bottom:0.5rem; }
        .tip-tag { font-size:0.65rem; padding:0.15rem 0.4rem; border-radius:4px; background:var(--bg-elevated); color:var(--text-muted); }
        .tip-desc { font-size:0.9rem; color:var(--text-secondary); line-height:1.5; }
        
        /* Calendar */
        .calendar-nav { display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; }
        .calendar-nav button { background:var(--bg-input); color:var(--text-primary); width:44px; height:44px; border-radius:50%; font-size:1.25rem; display:flex; align-items:center; justify-content:center; border:1px solid var(--border); }
        .calendar-title { font-family:'Bebas Neue',sans-serif; font-size:1.25rem; letter-spacing:0.05em; }
        .calendar-toggle { display:flex; gap:0.5rem; margin-bottom:1rem; }
        .calendar-toggle button { flex:1; padding:0.6rem; border-radius:8px; font-size:0.8rem; font-weight:600; background:var(--bg-input); color:var(--text-secondary); border:1px solid var(--border); }
        .calendar-toggle button.active { background:var(--gold); color:var(--bg-dark); border-color:var(--gold); }
        .calendar-weekdays { display:grid; grid-template-columns:40px repeat(7,1fr); text-align:center; margin-bottom:0.5rem; }
        .calendar-weekdays span { color:var(--text-muted); font-size:0.7rem; font-weight:600; padding:0.5rem 0; }
        .calendar-days { display:grid; grid-template-columns:40px repeat(7,1fr); gap:2px; }
        .calendar-week-label { display:flex; align-items:center; justify-content:center; font-size:0.65rem; font-weight:700; color:var(--text-muted); background:var(--bg-input); border-radius:6px; }
        .calendar-week-label.week-a { color:var(--primary); }
        .calendar-week-label.week-b { color:var(--gold); }
        .calendar-week-label.holiday { color:#06b6d4; }
        .calendar-day.holiday { background:rgba(30,58,138,0.3); }
        .calendar-day { min-height:56px; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:4px 2px; background:var(--bg-input); border-radius:8px; cursor:pointer; }
        .calendar-day:hover { background:var(--bg-elevated); }
        .calendar-day.empty { background:transparent; cursor:default; }
        .calendar-day.today { border:2px solid var(--gold); }
        .calendar-day.has-event { background:rgba(255,255,255,0.08); }
        .calendar-day.week-a { border-bottom:2px solid var(--primary); }
        .calendar-day.week-b { border-bottom:2px solid var(--gold); }
        .calendar-day.holiday { background:rgba(212,168,72,0.1); }
        .calendar-day .date { font-size:0.75rem; font-weight:600; }
        .calendar-day .dots { display:flex; gap:2px; margin-top:2px; }
        .calendar-day .dot { width:6px; height:6px; border-radius:50%; }
        .calendar-day .dot.event { background:var(--primary); }
        .calendar-day .dot.maintenance { background:var(--gold); }
        .calendar-legend { display:flex; gap:1rem; margin-top:1rem; flex-wrap:wrap; justify-content:center; }
        .legend-item { display:flex; align-items:center; gap:0.35rem; font-size:0.75rem; color:var(--text-muted); }
        .legend-dot { width:10px; height:10px; border-radius:50%; }
        .legend-line { width:16px; height:3px; border-radius:2px; }
        
        /* Maintenance Calendar */
        .maint-week { margin-bottom:1rem; }
        .maint-grid { display:grid; grid-template-columns:auto repeat(5,1fr); gap:2px; }
        .maint-header-cell { background:var(--bg-elevated); padding:0.5rem 0.25rem; text-align:center; font-size:0.7rem; font-weight:600; color:var(--text-muted); border-radius:4px; }
        .maint-row-label { background:var(--bg-elevated); padding:0.5rem; font-size:0.65rem; color:var(--text-muted); display:flex; align-items:center; border-radius:4px; }
        .maint-cell { background:var(--bg-input); padding:0.35rem; min-height:40px; border-radius:4px; display:flex; flex-direction:column; gap:2px; }
        .maint-name { font-size:0.6rem; padding:0.15rem 0.25rem; background:var(--bg-elevated); border-radius:3px; color:var(--text-secondary); text-align:center; }
        .maint-name.confirmed { background:rgba(212,168,72,0.2); color:var(--gold); }
        .maint-name.empty { opacity:0.3; }
        
        /* Rewards */
        .rewards-header { background:linear-gradient(135deg,var(--primary-dark),var(--gold-dark)); border-radius:16px; padding:1.5rem; margin-bottom:1rem; text-align:center; }
        .rewards-points { font-family:'Bebas Neue',sans-serif; font-size:3rem; color:var(--white); }
        .rewards-points-label { font-size:0.8rem; color:rgba(255,255,255,0.8); text-transform:uppercase; letter-spacing:0.1em; }
        .leaderboard { margin-bottom:1.5rem; max-height:300px; overflow-y:auto; }
        .leaderboard-item { display:flex; align-items:center; gap:0.75rem; padding:0.75rem; background:var(--bg-input); border-radius:10px; margin-bottom:0.5rem; }
        .leaderboard-rank { font-family:'Bebas Neue',sans-serif; font-size:1.5rem; width:36px; text-align:center; }
        .leaderboard-rank.gold { color:var(--gold); }
        .leaderboard-rank.silver { color:#c0c0c0; }
        .leaderboard-rank.bronze { color:#cd7f32; }
        .leaderboard-name { flex:1; font-weight:600; }
        .leaderboard-points { font-weight:700; color:var(--gold); }
        .badge-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:0.75rem; }
        .badge-item { text-align:center; padding:0.75rem 0.25rem; background:var(--bg-input); border-radius:12px; cursor:pointer; position:relative; border:2px solid transparent; }
        .badge-item.locked { opacity:0.4; }
        .badge-item.earned { border:2px solid var(--gold); }
        .badge-item.manual { border:2px solid rgba(255,255,255,0.5); }
        .badge-item.manual.earned { border:2px solid var(--gold); }
        .badge-icon { font-size:1.75rem; margin-bottom:0.25rem; }
        .badge-name { font-size:0.6rem; color:var(--text-secondary); line-height:1.2; }
        
        /* More Menu */
        .more-menu { display:flex; flex-direction:column; gap:0.5rem; }
        .more-item { display:flex; align-items:center; gap:1rem; padding:1rem; background:var(--bg-card); border-radius:12px; border:1px solid var(--border); text-align:left; }
        .more-item:active { background:var(--bg-elevated); }
        .more-icon { font-size:1.5rem; width:40px; text-align:center; }
        
        /* Profile Page */
        .profile-header { text-align:center; padding:1rem 0; }
        .profile-avatar { width:80px; height:80px; border-radius:50%; background:linear-gradient(135deg,var(--primary),var(--gold)); margin:0 auto 1rem; display:flex; align-items:center; justify-content:center; font-size:2rem; color:var(--white); font-weight:700; }
        .profile-name { font-size:1.25rem; font-weight:700; }
        .profile-type { font-size:0.85rem; color:var(--text-muted); text-transform:uppercase; }
        .stat-row { display:flex; justify-content:space-between; padding:0.75rem 0; border-bottom:1px solid var(--border); }
        .stat-row:last-child { border-bottom:none; }
        .stat-row span:last-child { font-weight:700; color:var(--gold); }
        
        /* Header Profile Button */
        .header-profile-btn { width:36px; height:36px; border-radius:50%; background:var(--bg-input); display:flex; align-items:center; justify-content:center; font-size:1rem; min-height:36px; border:1px solid var(--border); }
        
        /* Bottom Nav */
        .bottom-nav { position:fixed; bottom:0; left:50%; transform:translateX(-50%); width:100%; max-width:var(--app-max-width); background:var(--bg-card); border-top:1px solid var(--border); display:grid; grid-template-columns:repeat(5,1fr); padding:0.25rem 0; padding-bottom:max(0.25rem,env(safe-area-inset-bottom)); z-index:100; }
        .nav-item { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:0.15rem; padding:0.5rem 0.25rem; color:var(--text-muted); font-size:0.6rem; font-weight:600; min-height:56px; cursor:pointer; -webkit-tap-highlight-color:transparent; }
        .nav-item .icon { font-size:1.2rem; pointer-events:none; }
        .nav-item span { pointer-events:none; }
        .nav-item.active { color:var(--gold); }
        .nav-item.admin-only { display:none; }
        .nav-item.master-only { display:none; }
        .master-only { display:none; }
        .student-only { display:block; }
        .app.admin-mode .nav-item.admin-only { display:flex; }
        .app.admin-mode .nav-item.student-only { display:none; }
        .app.admin-mode .student-only { display:none; }
        .app.master-mode .nav-item.master-only { display:flex; }
        .app.master-mode .nav-item.student-only { display:none; }
        .app.master-mode .nav-item.admin-only { display:none; }
        .app.master-mode .master-only { display:block; }
        .app.master-mode .student-only { display:none; }
        
        /* Modals */
        .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.85); display:none; align-items:center; justify-content:center; z-index:500; padding:1rem; }
        .modal-overlay.active { display:flex; }
        .modal { background:var(--bg-card); border-radius:20px; padding:1.5rem; width:100%; max-width:420px; max-height:85vh; overflow-y:auto; border:1px solid var(--border); }
        .modal-title { font-family:'Bebas Neue',sans-serif; font-size:1.5rem; letter-spacing:0.05em; margin-bottom:1rem; text-align:center; }
        .modal-section { margin-bottom:1.25rem; }
        .modal-label { font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; margin-bottom:0.5rem; display:block; }
        .modal-input { width:100%; background:var(--bg-input); border:1px solid var(--border); border-radius:10px; padding:0.875rem 1rem; color:var(--text-primary); font-size:1rem; }
        .modal-input:focus { outline:none; border-color:var(--gold); }
        .modal-textarea { min-height:100px; resize:vertical; }
        .modal-select { appearance:none; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23666' viewBox='0 0 24 24'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 0.75rem center; background-size:1.5rem; padding-right:2.5rem; }
        .modal-buttons { display:flex; gap:0.75rem; margin-top:1.5rem; }
        .modal-btn { flex:1; padding:0.875rem; border-radius:12px; font-weight:600; min-height:50px; font-size:1rem; }
        .modal-btn.cancel { background:var(--bg-input); color:var(--text-secondary); }
        .modal-btn.primary { background:linear-gradient(135deg,var(--primary),var(--primary-dark)); color:var(--white); }
        .modal-btn.gold { background:linear-gradient(135deg,var(--gold),var(--gold-dark)); color:var(--bg-dark); }
        .modal-btn.danger { background:var(--danger); color:var(--white); }
        .checkbox-group { display:flex; flex-direction:column; gap:0.5rem; }
        .checkbox-item { display:flex; align-items:center; gap:0.75rem; padding:0.75rem; background:var(--bg-input); border-radius:8px; cursor:pointer; }
        .req-row { display:flex; align-items:center; gap:0.5rem; padding:0.5rem; background:var(--bg-input); border-radius:8px; margin-bottom:0.25rem; }
        .req-row label { flex:1; font-size:0.9rem; }
        .req-toggle { min-height:28px; min-width:28px; font-size:1rem; background:none; border:1px solid var(--border); border-radius:6px; }
        .req-toggle.compulsory { background:var(--primary); border-color:var(--primary); }
        .gear-item { display:flex; align-items:center; gap:0.5rem; padding:0.5rem; background:var(--bg-elevated); border-radius:6px; margin-bottom:0.25rem; }
        .gear-item span { flex:1; }
        .checkbox-item input { width:20px; height:20px; accent-color:var(--gold); }
        .checkbox-item label { flex:1; cursor:pointer; }
        .checkbox-item.required label::after { content:' *'; color:var(--primary); }
        
        /* Bottom Sheet Modal */
        .sheet-modal { position:fixed; inset:0; background:rgba(0,0,0,0.85); display:none; align-items:flex-end; z-index:500; }
        .sheet-modal.active { display:flex; }
        .sheet-content { background:var(--bg-card); width:100%; border-radius:24px 24px 0 0; padding:1.5rem; padding-bottom:max(1.5rem,env(safe-area-inset-bottom)); max-height:80vh; overflow-y:auto; }
        .sheet-handle { width:40px; height:4px; background:var(--text-muted); border-radius:2px; margin:0 auto 1rem; }
        .sheet-title { font-family:'Bebas Neue',sans-serif; font-size:1.25rem; text-align:center; margin-bottom:1rem; }
        .sheet-option { display:flex; align-items:center; gap:1rem; width:100%; padding:1rem; background:var(--bg-input); border-radius:12px; color:var(--text-primary); font-size:1rem; font-weight:600; margin-bottom:0.5rem; border:1px solid var(--border); }
        .sheet-option:active { background:var(--bg-elevated); }
        .sheet-option .icon { font-size:1.5rem; width:40px; text-align:center; }
        .sheet-close { width:100%; padding:1rem; margin-top:0.5rem; background:transparent; border:2px solid var(--text-muted); border-radius:12px; color:var(--text-secondary); font-size:1rem; }
        
        /* Toast */
        .toast { position:fixed; bottom:120px; left:50%; transform:translateX(-50%) translateY(100px); background:var(--gold); color:var(--bg-dark); padding:1rem 1.5rem; border-radius:12px; font-weight:600; opacity:0; transition:all 0.3s; z-index:600; }
        .toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
        .toast.error { background:var(--danger); color:var(--white); }
        
        /* Sync Status */
        .sync-status { position:fixed; top:0; left:0; right:0; height:3px; z-index:700; }
        .sync-status.syncing { background:linear-gradient(90deg,transparent,var(--gold),transparent); animation:syncPulse 1.5s infinite; }
        @keyframes syncPulse { 0%,100%{opacity:0.3} 50%{opacity:1} }
        
        /* Empty State */
        .empty-state { text-align:center; padding:3rem 1rem; color:var(--text-muted); }
        .empty-state-icon { font-size:3rem; margin-bottom:1rem; opacity:0.5; }
        .empty-state-text { font-size:0.9rem; }
        
        /* Event Details in Modal */
        .event-detail { padding:0.75rem; background:var(--bg-input); border-radius:8px; margin-bottom:0.5rem; }
        .event-detail-label { font-size:0.7rem; color:var(--text-muted); text-transform:uppercase; margin-bottom:0.25rem; }
        .event-detail-value { font-weight:600; }
        .crew-list { display:flex; flex-wrap:wrap; gap:0.5rem; margin-top:0.5rem; }
        .crew-chip { display:flex; align-items:center; gap:0.35rem; padding:0.35rem 0.6rem; background:var(--bg-elevated); border-radius:6px; font-size:0.8rem; }
        .crew-chip .remove { color:var(--primary); cursor:pointer; font-weight:700; }
        
        /* Admin Confirm List */
        .confirm-list { max-height:300px; overflow-y:auto; }
        .confirm-item { display:flex; align-items:center; justify-content:space-between; padding:0.75rem; background:var(--bg-input); border-radius:8px; margin-bottom:0.5rem; }
        .confirm-item-info { flex:1; }
        .confirm-item-name { font-weight:600; }
        .confirm-item-meta { font-size:0.8rem; color:var(--text-muted); }
        .confirm-btn { padding:0.5rem 1rem; border-radius:6px; font-size:0.8rem; font-weight:600; min-height:36px; }
        .confirm-btn.approve { background:var(--gold); color:var(--bg-dark); }
        .confirm-btn.deny { background:var(--bg-elevated); color:var(--text-secondary); }

        /* Settings */
        .settings-section { margin-bottom:1.5rem; }
        .settings-section-title { font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; margin-bottom:0.75rem; padding-left:0.25rem; }
        .settings-item { display:flex; align-items:center; justify-content:space-between; padding:1rem; background:var(--bg-input); border-radius:10px; margin-bottom:0.5rem; }
        .settings-item-label { font-weight:600; }
        .settings-item-value { color:var(--text-muted); font-size:0.9rem; }
        .user-list-item { display:flex; align-items:center; gap:0.75rem; padding:0.75rem; background:var(--bg-input); border-radius:10px; margin-bottom:0.5rem; }
        .user-avatar { width:40px; height:40px; border-radius:50%; background:var(--bg-elevated); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:0.9rem; }
        .user-avatar.admin { background:var(--primary-dark); }
        .user-avatar.student { background:var(--gold-dark); }
        .user-info { flex:1; }
        .user-name { font-weight:600; font-size:0.95rem; }
        .user-meta { font-size:0.75rem; color:var(--text-muted); }
        .user-actions { display:flex; gap:0.5rem; }
        .user-action-btn { width:32px; height:32px; min-height:32px; min-width:32px; border-radius:8px; background:var(--bg-elevated); display:flex; align-items:center; justify-content:center; font-size:0.9rem; }
    </style>
</head>
<body>
    <div class="sync-status" id="syncStatus"></div>
    
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-logo">TECH CREW</div>
        <div class="login-subtitle">Student Technician Hub</div>
        
        <div class="login-step active" id="stepId">
            <div class="login-label">Enter your User ID</div>
            <input type="text" class="login-input" id="userIdInput" placeholder="e.g. lastnamef" autocomplete="off" autocapitalize="off">
            <button class="modal-btn primary" style="width:100%" onclick="submitUserId()">Continue</button>
        </div>
        
        <div class="login-step" id="stepPin">
            <div class="user-welcome" id="welcomeName"></div>
            <div class="login-label">Enter Access Code</div>
            <div class="pin-dots" id="pinDots">
                <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
            </div>
            <div class="pin-keypad" id="pinKeypad">
                <button class="pin-key" data-key="1">1</button>
                <button class="pin-key" data-key="2">2</button>
                <button class="pin-key" data-key="3">3</button>
                <button class="pin-key" data-key="4">4</button>
                <button class="pin-key" data-key="5">5</button>
                <button class="pin-key" data-key="6">6</button>
                <button class="pin-key" data-key="7">7</button>
                <button class="pin-key" data-key="8">8</button>
                <button class="pin-key" data-key="9">9</button>
                <button class="pin-key empty"></button>
                <button class="pin-key" data-key="0">0</button>
                <button class="pin-key backspace" data-key="back">‚å´</button>
            </div>
            <button class="login-back" onclick="backToId()">‚Üê Different User</button>
        </div>
    </div>
    
    <!-- Main App -->
    <div class="app" id="app">
        <header class="header">
            <div class="header-top">
                <div class="header-logo">TECH CREW</div>
                <div class="header-user">
                    <button class="header-profile-btn" onclick="goToPage('pageProfile')">üë§</button>
                    <span class="header-user-name" id="headerUserName"></span>
                    <span class="header-user-badge" id="headerUserBadge"></span>
                    <button class="header-logout" onclick="logout()">Logout</button>
                </div>
            </div>
            <div class="header-info">
                <span id="headerDate"></span>
                <span id="headerTerm"></span>
                <span id="headerWeek"></span>
            </div>
        </header>
        
        <!-- Home Page -->
        <div class="page active" id="pageHome">
            <div class="page-title">üìã Events Board</div>
            <div id="jobsList"></div>
        </div>
        
        <!-- Calendar Page -->
        <div class="page" id="pageCalendar">
            <div class="page-title">üìÖ Calendar</div>
            <div class="calendar-toggle">
                <button class="active" data-view="events">Events</button>
                <button data-view="maintenance">Maintenance</button>
            </div>
            <div id="calendarEvents">
                <div class="calendar-nav">
                    <button id="prevMonth">‚Äπ</button>
                    <span class="calendar-title" id="calendarTitle"></span>
                    <button id="nextMonth">‚Ä∫</button>
                </div>
                <div class="calendar-weekdays">
                    <span></span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span><span>Sun</span>
                </div>
                <div class="calendar-days" id="calendarDays"></div>
                <div class="calendar-legend">
                    <div class="legend-item"><div class="legend-dot" style="background:#3b82f6"></div> Maintenance</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#f97316"></div> Setup</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#d4a848"></div> Event</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#22c55e"></div> Assembly</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#ef4444"></div> Training</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#a855f7"></div> Meeting</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#ec4899"></div> Other</div>
                </div>
            </div>
            <div id="calendarMaintenance" class="hidden">
                <div class="card">
                    <div class="card-title">üîß Weekly Slots</div>
                    <div class="maint-week" id="maintWeek"></div>
                    <div style="display:flex;gap:0.5rem">
                        <button class="modal-btn gold" style="flex:1" onclick="openMaintSlotModal()">Update My Slot</button>
                        <button class="modal-btn primary" style="flex:1" onclick="openConfirmMaintenance()">üìù Log Maintenance</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Rewards Page -->
        <div class="page" id="pageRewards">
            <div class="page-title">üèÜ Rewards</div>
            <div class="rewards-header">
                <div class="rewards-points" id="userPoints">0</div>
                <div class="rewards-points-label">Your Points</div>
            </div>
            <div class="card master-only">
                <div class="card-title">‚öôÔ∏è Rewards Management</div>
                <button class="modal-btn primary" style="width:100%;margin-bottom:0.5rem" onclick="openManagePointsModal()">üí∞ Manage Points</button>
                <button class="modal-btn gold" style="width:100%" onclick="openSpecialAwardModal()">‚≠ê Special Award</button>
            </div>
            <div class="card">
                <div class="card-title">ü•á Leaderboard</div>
                <div class="leaderboard" id="leaderboard"></div>
            </div>
            <div class="card">
                <div class="card-title">üéñÔ∏è Badges</div>
                <div class="badge-grid" id="badgeGrid"></div>
            </div>
        </div>
        
        <!-- Maintenance Page -->
        <div class="page" id="pageMaintenance">
            <div class="page-title">üîß Maintenance</div>
            <button class="modal-btn primary" style="width:100%;margin-bottom:1rem" onclick="openReportProblem()">üö® Report a Problem</button>
            <div id="maintenanceList"></div>
        </div>
        
        <!-- Tips Page -->
        <div class="page" id="pageTips">
            <div class="page-title">üí° Tips & Guides</div>
            <div class="tip-filters" id="tipFilters"></div>
            <div id="tipsList"></div>
        </div>
        
        <!-- Admin: Jobs Management -->
        <div class="page" id="pageAdminJobs">
            <div class="page-title">‚öôÔ∏è Manage Events</div>
            <button class="modal-btn primary" style="width:100%;margin-bottom:1rem" onclick="openAddJobModal()">+ Add New Job</button>
            <div id="adminJobsList"></div>
        </div>
        
        <!-- Admin: Confirm Attendance -->
        <div class="page" id="pageAdminRewards">
            <div class="page-title">‚úÖ Confirm Attendance</div>
            <div class="card">
                <div class="card-title">Pending Confirmations</div>
                <div class="confirm-list" id="confirmList"></div>
            </div>
        </div>
        
        <!-- Admin: Settings -->
        <div class="page" id="pageAdminSettings">
            <div class="page-title">‚öôÔ∏è Settings</div>
            <div class="settings-section">
                <div class="settings-section-title">GitHub Sync</div>
                <div class="settings-item" style="flex-direction:column;align-items:stretch;gap:0.5rem">
                    <span class="settings-item-label">Personal Access Token</span>
                    <input type="password" class="modal-input" id="patInput" placeholder="ghp_xxxxxxxxxxxx" style="font-size:0.9rem">
                    <button class="modal-btn gold" style="min-height:40px" onclick="saveGitHubPat()">Save Token</button>
                </div>
                <div class="settings-item">
                    <span class="settings-item-label">Sync Status</span>
                    <span class="settings-item-value" id="syncStatusText">Checking...</span>
                </div>
                <button class="modal-btn primary" style="width:100%;margin-top:0.5rem" onclick="loadData()">üîÑ Refresh Data</button>
            </div>
            <div class="settings-section">
                <div class="settings-section-title">User Management</div>
                <button class="modal-btn gold" style="width:100%;margin-bottom:1rem" onclick="openAddUserModal()">+ Add User</button>
                <div id="userList"></div>
            </div>
            <div class="settings-section">
                <div class="settings-section-title">Points System</div>
                <div class="settings-item">
                    <span class="settings-item-label">Event Signup</span>
                    <input type="number" class="modal-input" id="ptsSignup" style="width:60px;text-align:center" min="0">
                </div>
                <div class="settings-item">
                    <span class="settings-item-label">Event Attendance</span>
                    <input type="number" class="modal-input" id="ptsAttendance" style="width:60px;text-align:center" min="0">
                </div>
                <div class="settings-item">
                    <span class="settings-item-label">Weekly Maintenance</span>
                    <input type="number" class="modal-input" id="ptsMaintenance" style="width:60px;text-align:center" min="0">
                </div>
                <div class="settings-item">
                    <span class="settings-item-label">Task Completion</span>
                    <input type="number" class="modal-input" id="ptsTask" style="width:60px;text-align:center" min="0">
                </div>
                <button class="modal-btn primary" style="width:100%;margin-top:0.5rem" onclick="savePointsSystem()">Save Points System</button>
            </div>
            <div class="settings-section" style="border:2px solid var(--danger);border-radius:12px;padding:1rem">
                <div class="settings-section-title" style="color:var(--danger)">‚ö†Ô∏è Danger Zone</div>
                <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:1rem">Wipe all logged data for testing. This removes all events, tasks, points, badges, and user-submitted data. Users are NOT deleted.</p>
                <button class="modal-btn" style="width:100%;background:var(--danger);color:white" onclick="openWipeDataModal()">üóëÔ∏è Wipe All Data</button>
            </div>
        </div>
        
        <!-- More Page (Master only) -->
        <div class="page" id="pageMore">
            <div class="page-title">‚ò∞ More</div>
            <div class="more-menu">
                <button class="more-item" onclick="goToPage('pageRewards')"><span class="more-icon">üèÜ</span><span>Rewards</span></button>
                <button class="more-item" onclick="goToPage('pageAdminRewards')"><span class="more-icon">‚úÖ</span><span>Confirm Attendance</span></button>
                <button class="more-item" onclick="goToPage('pageTips')"><span class="more-icon">üí°</span><span>Tips</span></button>
                <button class="more-item" onclick="goToPage('pageArchive')"><span class="more-icon">üìÅ</span><span>Archived Events</span></button>
                <button class="more-item" onclick="goToPage('pageAdminSettings')"><span class="more-icon">‚öôÔ∏è</span><span>Settings</span></button>
            </div>
        </div>
        
        <!-- My Profile Page -->
        <div class="page" id="pageProfile">
            <div class="page-title">üë§ My Profile</div>
            <div class="card">
                <div class="profile-header">
                    <div class="profile-avatar" id="profileAvatar"></div>
                    <div class="profile-name" id="profileName"></div>
                    <div class="profile-type" id="profileType"></div>
                </div>
            </div>
            <div class="card" id="profileStatsCard">
                <div class="card-title">üìä My Stats</div>
                <div class="stat-row"><span>Total Points</span><span id="profilePoints">0</span></div>
                <div class="stat-row"><span>Badges Earned</span><span id="profileBadges">0</span></div>
                <div class="stat-row"><span>Events Completed</span><span id="profileEvents">0</span></div>
                <div class="stat-row"><span>Tasks Completed</span><span id="profileTasks">0</span></div>
                <div class="stat-row"><span>Weekly Streak</span><span id="profileStreak">0 weeks</span></div>
                <div class="stat-row"><span>Maintenance Slot</span><span id="profileMaintSlot">Not set</span></div>
            </div>
            <div class="card" id="profileBadgesCard">
                <div class="card-title">üéñÔ∏è My Badges</div>
                <div class="badge-grid" id="profileBadgeGrid"></div>
            </div>
            <div class="card student-only" id="profileHistoryCard">
                <button class="modal-btn primary" style="width:100%" onclick="openMyHistory()">üìú View My History</button>
            </div>
        </div>
        
        <!-- My History Modal will be shown as a page-like modal -->
        <div class="modal-overlay" id="myHistoryModal">
            <div class="modal" style="max-height:90vh;overflow-y:auto;width:95%">
                <div class="modal-title">üìú My History</div>
                <div id="myHistoryContent"></div>
                <div class="modal-buttons">
                    <button class="modal-btn gold" onclick="closeModal('myHistoryModal')">Close</button>
                </div>
            </div>
        </div>
        
        <!-- Wipe Data Confirmation Modal -->
        <div class="modal-overlay" id="wipeDataModal">
            <div class="modal">
                <div class="modal-title" style="color:var(--danger)">‚ö†Ô∏è Wipe All Data</div>
                <div style="padding:1rem 0;color:var(--text-secondary)">
                    <p style="margin-bottom:1rem">This will permanently delete:</p>
                    <ul style="margin-left:1rem;font-size:0.9rem;line-height:1.6">
                        <li>All events (active and archived)</li>
                        <li>All maintenance tasks</li>
                        <li>All points and badges</li>
                        <li>All maintenance slots and confirmations</li>
                        <li>All pending confirmations</li>
                        <li>All special awards</li>
                    </ul>
                    <p style="margin-top:1rem;font-weight:600">Users will NOT be deleted.</p>
                </div>
                <div class="modal-section">
                    <label class="modal-label">Enter Master PIN to confirm:</label>
                    <input type="password" class="modal-input" id="wipeConfirmPin" maxlength="4" inputmode="numeric" placeholder="Master PIN">
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeModal('wipeDataModal')">Cancel</button>
                    <button class="modal-btn" style="background:var(--danger);color:white" onclick="confirmWipeData()">Wipe Data</button>
                </div>
            </div>
        </div>
        
        <!-- Archive Page -->
        <div class="page" id="pageArchive">
            <div class="page-title">üìÅ Archived Events</div>
            <div id="archivedEventsList"></div>
            <div style="margin-top:1.5rem">
                <div class="page-title" style="font-size:1.25rem">üîß Completed Tasks</div>
                <div id="archivedTasksList"></div>
            </div>
        </div>
        
        <!-- Bottom Nav -->
        <nav class="bottom-nav" id="bottomNav">
            <!-- Student Nav (5 items) -->
            <button class="nav-item active student-only" data-page="pageHome"><span class="icon">üè†</span><span>Events</span></button>
            <button class="nav-item student-only" data-page="pageCalendar"><span class="icon">üìÖ</span><span>Calendar</span></button>
            <button class="nav-item student-only" data-page="pageRewards"><span class="icon">üèÜ</span><span>Rewards</span></button>
            <button class="nav-item student-only" data-page="pageMaintenance"><span class="icon">üîß</span><span>Tasks</span></button>
            <button class="nav-item student-only" data-page="pageTips"><span class="icon">üí°</span><span>Tips</span></button>
            
            <!-- Admin Nav (5 items) -->
            <button class="nav-item admin-only" data-page="pageHome"><span class="icon">üè†</span><span>Events</span></button>
            <button class="nav-item admin-only" data-page="pageAdminJobs"><span class="icon">üìù</span><span>Manage</span></button>
            <button class="nav-item admin-only" data-page="pageCalendar"><span class="icon">üìÖ</span><span>Calendar</span></button>
            <button class="nav-item admin-only" data-page="pageMaintenance"><span class="icon">üîß</span><span>Tasks</span></button>
            <button class="nav-item admin-only" data-page="pageTips"><span class="icon">üí°</span><span>Tips</span></button>
            
            <!-- Master Nav (5 main + more in header) -->
            <button class="nav-item master-only" data-page="pageHome"><span class="icon">üè†</span><span>Events</span></button>
            <button class="nav-item master-only" data-page="pageAdminJobs"><span class="icon">üìù</span><span>Manage</span></button>
            <button class="nav-item master-only" data-page="pageCalendar"><span class="icon">üìÖ</span><span>Calendar</span></button>
            <button class="nav-item master-only" data-page="pageMaintenance"><span class="icon">üîß</span><span>Tasks</span></button>
            <button class="nav-item master-only" data-page="pageMore"><span class="icon">‚ò∞</span><span>More</span></button>
        </nav>
    </div>
    
    <!-- Action Sheet -->
    <div class="sheet-modal" id="actionSheet">
        <div class="sheet-content">
            <div class="sheet-handle"></div>
            <div class="sheet-title">Quick Actions</div>
            <button class="sheet-option" onclick="openReportProblem()"><span class="icon">üö®</span> Report a Problem</button>
            <button class="sheet-option" onclick="openConfirmMaintenance()"><span class="icon">‚úÖ</span> Confirm Weekly Maintenance</button>
            <button class="sheet-close" onclick="closeActionSheet()">Cancel</button>
        </div>
    </div>
    
    <!-- Job Details Modal -->
    <div class="modal-overlay" id="jobModal">
        <div class="modal">
            <div class="modal-title" id="jobModalTitle">Job Details</div>
            <div id="jobModalContent"></div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('jobModal')">Close</button>
                <button class="modal-btn gold" id="jobSignupBtn" onclick="signupForJob()">Sign Up</button>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Job Modal (Admin) -->
    <div class="modal-overlay" id="addJobModal">
        <div class="modal" style="max-height:90vh;overflow-y:auto">
            <div class="modal-title" id="addJobModalTitle">Add Event</div>
            <div class="modal-section">
                <label class="modal-label">Event Title</label>
                <input type="text" class="modal-input" id="jobTitleInput" placeholder="e.g. Assembly Setup">
            </div>
            <div class="modal-section">
                <label class="modal-label">Category</label>
                <select class="modal-input modal-select" id="jobCategoryInput">
                    <option value="maintenance">Maintenance</option>
                    <option value="setup">Setup/Packdown</option>
                    <option value="event">Event</option>
                    <option value="assembly">Assembly</option>
                    <option value="training">Training</option>
                    <option value="meeting">Meeting</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="modal-section">
                <label class="modal-label">Date</label>
                <input type="date" class="modal-input" id="jobDateInput">
            </div>
            <div class="modal-section">
                <label class="modal-label">Time</label>
                <input type="time" class="modal-input" id="jobTimeInput">
            </div>
            <div class="modal-section">
                <label class="modal-label">Location</label>
                <input type="text" class="modal-input" id="jobLocationInput" placeholder="e.g. Main Hall">
            </div>
            <div class="modal-section">
                <label class="modal-label">Description</label>
                <textarea class="modal-input modal-textarea" id="jobDescInput" placeholder="Event details..."></textarea>
            </div>
            <div class="modal-section">
                <label class="modal-label">Gear List</label>
                <div id="gearListItems"></div>
                <div style="display:flex;gap:0.5rem;margin-top:0.5rem">
                    <input type="text" class="modal-input" id="gearInput" placeholder="Add gear item..." style="flex:1">
                    <button class="modal-btn gold" style="min-height:40px;min-width:60px" onclick="addGearItem()">+ Add</button>
                </div>
            </div>
            <div class="modal-section">
                <label class="modal-label">Role Preferences (students can select)</label>
                <div class="checkbox-group" id="jobRoles">
                    <div class="checkbox-item"><input type="checkbox" id="roleLighting"><label for="roleLighting">Lighting</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="roleSound"><label for="roleSound">Sound</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="roleStage"><label for="roleStage">Stage</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="roleAV"><label for="roleAV">AV</label></div>
                </div>
                <div style="display:flex;gap:0.5rem;margin-top:0.5rem">
                    <input type="text" class="modal-input" id="customRoleInput" placeholder="Add custom role..." style="flex:1">
                    <button class="modal-btn gold" style="min-height:40px;min-width:60px" onclick="addCustomRole()">+ Add</button>
                </div>
                <div id="customRolesList" style="margin-top:0.5rem"></div>
            </div>
            <div class="modal-section">
                <label class="modal-label">Requirements (toggle ‚ö†Ô∏è for compulsory)</label>
                <div id="jobRequirementsContainer">
                    <div class="req-row"><input type="checkbox" id="reqSetup"><label for="reqSetup">I can setup before</label><button class="req-toggle" data-req="reqSetup" onclick="toggleCompulsory(this)">‚ö™</button></div>
                    <div class="req-row"><input type="checkbox" id="reqPackdown"><label for="reqPackdown">I can packdown after</label><button class="req-toggle" data-req="reqPackdown" onclick="toggleCompulsory(this)">‚ö™</button></div>
                    <div class="req-row"><input type="checkbox" id="reqBlack"><label for="reqBlack">Wear Blacks</label><button class="req-toggle" data-req="reqBlack" onclick="toggleCompulsory(this)">‚ö™</button></div>
                    <div class="req-row"><input type="checkbox" id="reqEarly15"><label for="reqEarly15">Arrive 15 mins early</label><button class="req-toggle" data-req="reqEarly15" onclick="toggleCompulsory(this)">‚ö™</button></div>
                    <div class="req-row"><input type="checkbox" id="reqEarly30"><label for="reqEarly30">Arrive 30 mins early</label><button class="req-toggle" data-req="reqEarly30" onclick="toggleCompulsory(this)">‚ö™</button></div>
                    <div class="req-row"><input type="checkbox" id="reqEarly60"><label for="reqEarly60">Arrive 1 hour early</label><button class="req-toggle" data-req="reqEarly60" onclick="toggleCompulsory(this)">‚ö™</button></div>
                </div>
                <div style="display:flex;gap:0.5rem;margin-top:0.5rem">
                    <input type="text" class="modal-input" id="customReqInput" placeholder="Add custom requirement..." style="flex:1">
                    <button class="modal-btn gold" style="min-height:40px;min-width:60px" onclick="addCustomRequirement()">+ Add</button>
                </div>
                <div id="customReqsList" style="margin-top:0.5rem"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('addJobModal')">Cancel</button>
                <button class="modal-btn primary" onclick="saveJob()">Save Event</button>
            </div>
        </div>
    </div>
    
    <!-- Signup Confirmation Modal -->
    <div class="modal-overlay" id="signupModal">
        <div class="modal">
            <div class="modal-title">Confirm Signup</div>
            <p style="color:var(--text-secondary);margin-bottom:1rem;text-align:center" id="signupJobName"></p>
            <div class="checkbox-group" id="signupRequirements"></div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('signupModal')">Cancel</button>
                <button class="modal-btn gold" onclick="confirmSignup()">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- Report Problem Modal -->
    <div class="modal-overlay" id="reportModal">
        <div class="modal">
            <div class="modal-title">üö® Report Problem</div>
            <div class="modal-section">
                <label class="modal-label">Location</label>
                <select class="modal-input modal-select" id="reportLocation">
                    <option value="">Select location...</option>
                    <option value="Theatre">Theatre</option>
                    <option value="Stage">Stage</option>
                    <option value="Stage Managers Corner">Stage Managers Corner</option>
                    <option value="Winches">Winches</option>
                    <option value="Dock">Dock</option>
                    <option value="Dressing Rooms">Dressing Rooms</option>
                    <option value="Patch Bay">Patch Bay</option>
                    <option value="Amp Room">Amp Room</option>
                    <option value="Gantry">Gantry</option>
                    <option value="Tech Booth">Tech Booth</option>
                    <option value="Foyer">Foyer</option>
                    <option value="Studio A">Studio A</option>
                    <option value="Studio B">Studio B</option>
                    <option value="Studio C">Studio C</option>
                    <option value="K119">K119</option>
                    <option value="K106">K106</option>
                    <option value="K104">K104</option>
                    <option value="Music Practice Room">Music Practice Room</option>
                    <option value="Recording Studio">Recording Studio</option>
                    <option value="Titan Box">Titan Box</option>
                    <option value="Cave">Cave</option>
                    <option value="Tempero/Horn Office">Tempero/Horn Office</option>
                    <option value="Gym 1">Gym 1</option>
                    <option value="Gym 2">Gym 2</option>
                    <option value="Ticket Office">Ticket Office</option>
                    <option value="custom">*Custom Location*</option>
                </select>
                <input type="text" class="modal-input hidden" id="customLocationInput" placeholder="Enter custom location..." style="margin-top:0.5rem">
            </div>
            <div class="modal-section">
                <label class="modal-label">Title</label>
                <input type="text" class="modal-input" id="reportTitle" placeholder="Brief title for the problem...">
            </div>
            <div class="modal-section">
                <label class="modal-label">Description</label>
                <textarea class="modal-input modal-textarea" id="reportDesc" placeholder="Describe the problem in detail..."></textarea>
            </div>
            <div class="modal-section">
                <label class="modal-label">Urgency: <span id="urgencyLabel">This week</span></label>
                <input type="range" id="reportUrgency" min="1" max="5" value="2" style="width:100%" oninput="updateUrgencyLabel()">
                <div style="display:flex;justify-content:space-between;font-size:0.65rem;color:var(--text-muted);margin-top:0.25rem">
                    <span>ASAP</span><span>This week</span><span>Few weeks</span><span>End of term</span><span>End of year</span>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('reportModal')">Cancel</button>
                <button class="modal-btn primary" onclick="submitReport()">Submit</button>
            </div>
        </div>
    </div>
    
    <!-- Add Maintenance Task Modal (Admin) -->
    <div class="modal-overlay" id="addTaskModal">
        <div class="modal">
            <div class="modal-title">Add Maintenance Task</div>
            <div class="modal-section">
                <label class="modal-label">Task Title</label>
                <input type="text" class="modal-input" id="taskTitleInput" placeholder="e.g. Check cables">
            </div>
            <div class="modal-section">
                <label class="modal-label">Location</label>
                <select class="modal-input modal-select" id="taskLocationInput">
                    <option value="Studio 1">Studio 1</option>
                    <option value="Studio 2">Studio 2</option>
                    <option value="Stage">Stage</option>
                    <option value="Booth">Booth</option>
                    <option value="K119">K119</option>
                    <option value="General">General</option>
                </select>
            </div>
            <div class="modal-section">
                <label class="modal-label">Description</label>
                <textarea class="modal-input modal-textarea" id="taskDescInput" placeholder="Task details..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('addTaskModal')">Cancel</button>
                <button class="modal-btn primary" onclick="saveTask()">Add Task</button>
            </div>
        </div>
    </div>
    
    <!-- Add Tip Modal (Admin) -->
    <div class="modal-overlay" id="addTipModal">
        <div class="modal">
            <div class="modal-title">Add Tip</div>
            <div class="modal-section">
                <label class="modal-label">Title</label>
                <input type="text" class="modal-input" id="tipTitleInput" placeholder="e.g. Coiling cables properly">
            </div>
            <div class="modal-section">
                <label class="modal-label">Tags (comma separated)</label>
                <input type="text" class="modal-input" id="tipTagsInput" placeholder="e.g. Sound, General">
            </div>
            <div class="modal-section">
                <label class="modal-label">Content</label>
                <textarea class="modal-input modal-textarea" id="tipContentInput" placeholder="Tip details..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('addTipModal')">Cancel</button>
                <button class="modal-btn primary" onclick="saveTip()">Add Tip</button>
            </div>
        </div>
    </div>
    
    <!-- Add User Modal (Admin) -->
    <div class="modal-overlay" id="addUserModal">
        <div class="modal">
            <div class="modal-title">Add User</div>
            <div class="modal-section">
                <label class="modal-label">User ID</label>
                <input type="text" class="modal-input" id="newUserIdInput" placeholder="e.g. smithj">
            </div>
            <div class="modal-section">
                <label class="modal-label">First Name</label>
                <input type="text" class="modal-input" id="newUserFirstInput" placeholder="John">
            </div>
            <div class="modal-section">
                <label class="modal-label">Last Name</label>
                <input type="text" class="modal-input" id="newUserLastInput" placeholder="Smith">
            </div>
            <div class="modal-section">
                <label class="modal-label">Type</label>
                <select class="modal-input modal-select" id="newUserTypeInput">
                    <option value="student">Student</option>
                    <option value="admin">Admin (Staff)</option>
                </select>
            </div>
            <div class="modal-section">
                <label class="modal-label">Year Level</label>
                <select class="modal-input modal-select" id="newUserYearInput">
                    <option value="10">Year 10</option>
                    <option value="11">Year 11</option>
                    <option value="12">Year 12</option>
                    <option value="13">Year 13</option>
                    <option value="Staff">Staff</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('addUserModal')">Cancel</button>
                <button class="modal-btn primary" onclick="saveUser()">Add User</button>
            </div>
        </div>
    </div>
    
    <!-- Edit User Modal -->
    <div class="modal-overlay" id="editUserModal">
        <div class="modal" style="max-height:90vh;overflow-y:auto">
            <div class="modal-title">Edit User</div>
            <div class="modal-section">
                <label class="modal-label">User ID</label>
                <input type="text" class="modal-input" id="editUserIdDisplay" disabled style="opacity:0.6">
            </div>
            <div class="modal-section">
                <label class="modal-label">First Name</label>
                <input type="text" class="modal-input" id="editUserFirstInput">
            </div>
            <div class="modal-section">
                <label class="modal-label">Last Name</label>
                <input type="text" class="modal-input" id="editUserLastInput">
            </div>
            <div class="modal-section">
                <label class="modal-label">Type</label>
                <select class="modal-input modal-select" id="editUserTypeInput">
                    <option value="student">Student</option>
                    <option value="admin">Admin (Staff)</option>
                </select>
            </div>
            <div class="modal-section">
                <label class="modal-label">Year Level</label>
                <select class="modal-input modal-select" id="editUserYearInput">
                    <option value="10">Year 10</option>
                    <option value="11">Year 11</option>
                    <option value="12">Year 12</option>
                    <option value="13">Year 13</option>
                    <option value="Staff">Staff</option>
                </select>
            </div>
            <div class="modal-section">
                <label class="modal-label">Points</label>
                <input type="number" class="modal-input" id="editUserPointsInput" min="0">
            </div>
            <div class="modal-section">
                <label class="modal-label">Maintenance Slot</label>
                <select class="modal-input modal-select" id="editUserMaintInput">
                    <option value="">Not assigned</option>
                    <optgroup label="Monday">
                        <option value="Monday-Before School">Monday - Before School</option>
                        <option value="Monday-Interval">Monday - Interval</option>
                        <option value="Monday-Lunchtime">Monday - Lunchtime</option>
                        <option value="Monday-After School">Monday - After School</option>
                    </optgroup>
                    <optgroup label="Tuesday">
                        <option value="Tuesday-Before School">Tuesday - Before School</option>
                        <option value="Tuesday-Interval">Tuesday - Interval</option>
                        <option value="Tuesday-Lunchtime">Tuesday - Lunchtime</option>
                        <option value="Tuesday-After School">Tuesday - After School</option>
                    </optgroup>
                    <optgroup label="Wednesday">
                        <option value="Wednesday-Before School">Wednesday - Before School</option>
                        <option value="Wednesday-Interval">Wednesday - Interval</option>
                        <option value="Wednesday-Lunchtime">Wednesday - Lunchtime</option>
                        <option value="Wednesday-After School">Wednesday - After School</option>
                    </optgroup>
                    <optgroup label="Thursday">
                        <option value="Thursday-Before School">Thursday - Before School</option>
                        <option value="Thursday-Interval">Thursday - Interval</option>
                        <option value="Thursday-Lunchtime">Thursday - Lunchtime</option>
                        <option value="Thursday-After School">Thursday - After School</option>
                    </optgroup>
                    <optgroup label="Friday">
                        <option value="Friday-Before School">Friday - Before School</option>
                        <option value="Friday-Interval">Friday - Interval</option>
                        <option value="Friday-Lunchtime">Friday - Lunchtime</option>
                        <option value="Friday-After School">Friday - After School</option>
                    </optgroup>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('editUserModal')">Cancel</button>
                <button class="modal-btn primary" onclick="saveEditUser()">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Remove Points Modal -->
    <div class="modal-overlay" id="removePointsModal">
        <div class="modal">
            <div class="modal-title">‚ûñ Remove Points</div>
            <div class="modal-section">
                <label class="modal-label">Select Student</label>
                <select class="modal-input modal-select" id="removePointsStudent"></select>
            </div>
            <div class="modal-section">
                <label class="modal-label">Points to Remove</label>
                <input type="number" class="modal-input" id="removePointsAmount" min="1" max="1000" value="10">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('removePointsModal')">Cancel</button>
                <button class="modal-btn primary" onclick="confirmRemovePoints()">Remove</button>
            </div>
        </div>
    </div>
    
    <!-- Remove Badge Modal -->
    <div class="modal-overlay" id="removeBadgeModal">
        <div class="modal">
            <div class="modal-title">üóëÔ∏è Remove Badge</div>
            <div class="modal-section">
                <label class="modal-label">Select Student</label>
                <select class="modal-input modal-select" id="removeBadgeStudent" onchange="updateRemoveBadgeList()"></select>
            </div>
            <div class="modal-section">
                <label class="modal-label">Select Badge to Remove</label>
                <select class="modal-input modal-select" id="removeBadgeSelect"></select>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('removeBadgeModal')">Cancel</button>
                <button class="modal-btn primary" onclick="confirmRemoveBadge()">Remove</button>
            </div>
        </div>
    </div>
    
    <!-- Manage Points Modal -->
    <div class="modal-overlay" id="managePointsModal">
        <div class="modal">
            <div class="modal-title">üí∞ Manage Points</div>
            <div class="modal-section">
                <label class="modal-label">Select Student</label>
                <select class="modal-input modal-select" id="managePointsStudent" onchange="updateManagePointsDisplay()"></select>
            </div>
            <div class="modal-section">
                <label class="modal-label">Current Points: <span id="currentPointsDisplay">0</span></label>
            </div>
            <div class="modal-section">
                <label class="modal-label">Add/Remove Points</label>
                <div style="display:flex;gap:0.5rem;align-items:center">
                    <button class="modal-btn" style="min-width:50px" onclick="adjustPointsBy(-10)">-10</button>
                    <button class="modal-btn" style="min-width:50px" onclick="adjustPointsBy(-1)">-1</button>
                    <input type="number" class="modal-input" id="managePointsAmount" value="0" style="text-align:center;flex:1">
                    <button class="modal-btn" style="min-width:50px" onclick="adjustPointsBy(1)">+1</button>
                    <button class="modal-btn" style="min-width:50px" onclick="adjustPointsBy(10)">+10</button>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('managePointsModal')">Cancel</button>
                <button class="modal-btn primary" onclick="confirmManagePoints()">Apply</button>
            </div>
        </div>
    </div>
    
    <!-- Special Award Modal -->
    <div class="modal-overlay" id="specialAwardModal">
        <div class="modal">
            <div class="modal-title">‚≠ê Special Award</div>
            <div class="modal-section">
                <label class="modal-label">Select Student</label>
                <select class="modal-input modal-select" id="specialAwardStudent"></select>
            </div>
            <div class="modal-section">
                <label class="modal-label">Award Title</label>
                <input type="text" class="modal-input" id="specialAwardTitle" placeholder="e.g. Star Performer">
            </div>
            <div class="modal-section">
                <label class="modal-label">Description</label>
                <textarea class="modal-input modal-textarea" id="specialAwardDesc" placeholder="Why they earned this award..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('specialAwardModal')">Cancel</button>
                <button class="modal-btn gold" onclick="confirmSpecialAward()">Award</button>
            </div>
        </div>
    </div>
    
    <!-- Award Badge to Student Modal -->
    <div class="modal-overlay" id="awardBadgeToStudentModal">
        <div class="modal">
            <div class="modal-title" id="awardBadgeToStudentTitle">Award Badge</div>
            <div class="modal-section">
                <label class="modal-label">Select Student</label>
                <select class="modal-input modal-select" id="awardBadgeToStudent"></select>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('awardBadgeToStudentModal')">Cancel</button>
                <button class="modal-btn gold" onclick="confirmAwardBadgeToStudent()">Award Badge</button>
            </div>
        </div>
    </div>
    
    <!-- Badge Detail Modal -->
    <div class="modal-overlay" id="badgeModal">
        <div class="modal">
            <div class="modal-title" id="badgeModalTitle">Badge</div>
            <div id="badgeModalContent" style="text-align:center;padding:1rem 0;"></div>
            <div class="modal-buttons" id="badgeModalButtons">
                <button class="modal-btn gold" onclick="closeModal('badgeModal')">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Calendar Settings Modal (Admin) -->
    <div class="modal-overlay" id="calendarSettingsModal">
        <div class="modal">
            <div class="modal-title">Calendar Settings</div>
            <div class="modal-section">
                <label class="modal-label">Current Term</label>
                <select class="modal-input modal-select" id="termInput">
                    <option value="1">Term 1</option>
                    <option value="2">Term 2</option>
                    <option value="3">Term 3</option>
                    <option value="4">Term 4</option>
                </select>
            </div>
            <div class="modal-section">
                <label class="modal-label">Current Week Number</label>
                <input type="number" class="modal-input" id="weekNumInput" min="1" max="12" value="1">
            </div>
            <div class="modal-section">
                <label class="modal-label">Week Type</label>
                <select class="modal-input modal-select" id="weekTypeInput">
                    <option value="A">Week A</option>
                    <option value="B">Week B</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('calendarSettingsModal')">Cancel</button>
                <button class="modal-btn primary" onclick="saveCalendarSettings()">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Maintenance Slot Modal -->
    <div class="modal-overlay" id="maintSlotModal">
        <div class="modal">
            <div class="modal-title">Weekly Maintenance Slot</div>
            <div class="modal-section">
                <label class="modal-label">Select Your Slot</label>
                <select class="modal-input modal-select" id="maintDayInput">
                    <option value="">Not assigned</option>
                    <optgroup label="Monday">
                        <option value="Monday-Before School">Monday - Before School</option>
                        <option value="Monday-Interval">Monday - Interval</option>
                        <option value="Monday-Lunchtime">Monday - Lunchtime</option>
                        <option value="Monday-After School">Monday - After School</option>
                    </optgroup>
                    <optgroup label="Tuesday">
                        <option value="Tuesday-Before School">Tuesday - Before School</option>
                        <option value="Tuesday-Interval">Tuesday - Interval</option>
                        <option value="Tuesday-Lunchtime">Tuesday - Lunchtime</option>
                        <option value="Tuesday-After School">Tuesday - After School</option>
                    </optgroup>
                    <optgroup label="Wednesday">
                        <option value="Wednesday-Before School">Wednesday - Before School</option>
                        <option value="Wednesday-Interval">Wednesday - Interval</option>
                        <option value="Wednesday-Lunchtime">Wednesday - Lunchtime</option>
                        <option value="Wednesday-After School">Wednesday - After School</option>
                    </optgroup>
                    <optgroup label="Thursday">
                        <option value="Thursday-Before School">Thursday - Before School</option>
                        <option value="Thursday-Interval">Thursday - Interval</option>
                        <option value="Thursday-Lunchtime">Thursday - Lunchtime</option>
                        <option value="Thursday-After School">Thursday - After School</option>
                    </optgroup>
                    <optgroup label="Friday">
                        <option value="Friday-Before School">Friday - Before School</option>
                        <option value="Friday-Interval">Friday - Interval</option>
                        <option value="Friday-Lunchtime">Friday - Lunchtime</option>
                        <option value="Friday-After School">Friday - After School</option>
                    </optgroup>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('maintSlotModal')">Cancel</button>
                <button class="modal-btn gold" onclick="saveMaintSlot()">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Task Detail Modal -->
    <div class="modal-overlay" id="taskModal">
        <div class="modal">
            <div class="modal-title" id="taskModalTitle">Task Details</div>
            <div id="taskModalContent"></div>
            <div class="modal-buttons" id="taskModalButtons">
                <button class="modal-btn cancel" onclick="closeModal('taskModal')">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Confirm Maintenance Done Modal -->
    <div class="modal-overlay" id="confirmMaintModal">
        <div class="modal">
            <div class="modal-title">‚úÖ Confirm Maintenance</div>
            <p style="color:var(--text-secondary);margin-bottom:1rem;">Confirm you've completed your weekly maintenance slot.</p>
            <div class="modal-section">
                <label class="modal-label">What did you do?</label>
                <textarea class="modal-input modal-textarea" id="maintDetailsInput" placeholder="Describe what you did..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('confirmMaintModal')">Cancel</button>
                <button class="modal-btn gold" onclick="submitMaintConfirmation()">Submit</button>
            </div>
        </div>
    </div>
    
    <!-- Day Events Modal -->
    <div class="modal-overlay" id="dayEventsModal">
        <div class="modal">
            <div class="modal-title" id="dayEventsTitle">Events</div>
            <div id="dayEventsList"></div>
            <div class="modal-buttons">
                <button class="modal-btn gold" onclick="closeModal('dayEventsModal')">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Award Points Modal (Master) -->
    <div class="modal-overlay" id="awardPointsModal">
        <div class="modal">
            <div class="modal-title">üèÜ Award Points</div>
            <div class="modal-section">
                <label class="modal-label">Select Student</label>
                <select class="modal-input modal-select" id="awardPointsStudent"></select>
            </div>
            <div class="modal-section">
                <label class="modal-label">Points to Award</label>
                <input type="number" class="modal-input" id="awardPointsAmount" value="10" min="1" max="100">
            </div>
            <div class="modal-section">
                <label class="modal-label">Reason</label>
                <input type="text" class="modal-input" id="awardPointsReason" placeholder="e.g. Extra help at assembly">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('awardPointsModal')">Cancel</button>
                <button class="modal-btn gold" onclick="confirmAwardPoints()">Award Points</button>
            </div>
        </div>
    </div>
    
    <!-- Award Badge Modal (Master) -->
    <div class="modal-overlay" id="awardBadgeModal">
        <div class="modal">
            <div class="modal-title">üéñÔ∏è Award Badge</div>
            <div class="modal-section">
                <label class="modal-label">Select Student</label>
                <select class="modal-input modal-select" id="awardBadgeStudent"></select>
            </div>
            <div class="modal-section">
                <label class="modal-label">Select Badge</label>
                <select class="modal-input modal-select" id="awardBadgeSelect"></select>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('awardBadgeModal')">Cancel</button>
                <button class="modal-btn gold" onclick="confirmAwardBadge()">Award Badge</button>
            </div>
        </div>
    </div>
    
    <!-- Manage Event Crew Modal (Admin) -->
    <div class="modal-overlay" id="manageCrewModal">
        <div class="modal" style="max-height:90vh;overflow-y:auto">
            <div class="modal-title">üë• Manage Crew</div>
            <div class="modal-section">
                <label class="modal-label">Current Crew & Role Assignments</label>
                <div id="currentCrewList"></div>
            </div>
            <div class="modal-section">
                <label class="modal-label">Add Student</label>
                <select class="modal-input modal-select" id="addCrewStudent"></select>
                <button class="modal-btn gold" style="margin-top:0.5rem" onclick="addStudentToCrew()">+ Add to Crew</button>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="saveCrewRoles()">Save Roles</button>
                <button class="modal-btn cancel" onclick="closeModal('manageCrewModal')">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Complete Event Modal (Admin) -->
    <div class="modal-overlay" id="completeEventModal">
        <div class="modal">
            <div class="modal-title">‚úÖ Complete Event</div>
            <p style="color:var(--text-secondary);margin-bottom:1rem;text-align:center" id="completeEventName"></p>
            <div class="modal-section">
                <label class="modal-label">Confirm Attendance (tick students who attended)</label>
                <div class="checkbox-group" id="attendanceList"></div>
            </div>
            <div class="modal-section">
                <label class="modal-label">Assign Roles</label>
                <div id="roleAssignmentList"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('completeEventModal')">Cancel</button>
                <button class="modal-btn primary" onclick="confirmCompleteEvent()">Complete & Award Points</button>
            </div>
        </div>
    </div>
    
    <!-- Confirm Maintenance Modal (Admin) -->
    <div class="modal-overlay" id="adminConfirmMaintModal">
        <div class="modal">
            <div class="modal-title">‚úÖ Confirm Maintenance</div>
            <div class="modal-section">
                <label class="modal-label">Task</label>
                <div id="confirmMaintTaskName" style="font-weight:600;margin-bottom:0.5rem"></div>
            </div>
            <div class="modal-section">
                <label class="modal-label">Confirm Students (tick who participated)</label>
                <div class="checkbox-group" id="maintAttendanceList"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('adminConfirmMaintModal')">Cancel</button>
                <button class="modal-btn primary" onclick="confirmMaintComplete()">Complete & Award Points</button>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

<script>
const $ = id => document.getElementById(id);
const $$ = sel => document.querySelectorAll(sel);

// PAT encoding (simple obfuscation to bypass GitHub secret scanning)
// This is NOT encryption - just makes the token unrecognizable to scanners
function encodePat(pat) {
    // Reverse and convert to base64, then reverse again
    const reversed = pat.split('').reverse().join('');
    const b64 = btoa(reversed);
    return b64.split('').reverse().join('');
}

function decodePat(encoded) {
    try {
        const unreversed = encoded.split('').reverse().join('');
        const decoded = atob(unreversed);
        return decoded.split('').reverse().join('');
    } catch (e) {
        return '';
    }
}

// Config
const CONFIG = {
    MASTER_PIN: '9743',
    ADMIN_PIN: '2026',
    STUDENT_PIN: '3489',
    REPO_OWNER: 'joeltempero',
    REPO_NAME: 'grangetech',
    DATA_FILE: 'data.json',
    // GitHub Personal Access Token - set this once in Settings (Master only)
    // After setting, it syncs to data.json so all devices use it
    get PAT() { return localStorage.getItem('github_pat') || state.data?.githubPat || ''; }
};

// Initial Data Structure
const DEFAULT_DATA = {
    users: [
        {id:'Tempero',type:'master',firstName:'Joel',lastName:'Tempero',year:'Staff',pin:'9743'},
        {id:'Horn',type:'admin',firstName:'Rhian',lastName:'Horn',year:'Staff',pin:'2026'},
        {id:'Baker',type:'admin',firstName:'Aidan',lastName:'Baker',year:'Staff',pin:'2026'},
        {id:'Horner',type:'admin',firstName:'Nathan',lastName:'Horner',year:'Staff',pin:'2026'},
        {id:'McCormack',type:'admin',firstName:'Michael',lastName:'McCormack',year:'Staff',pin:'2026'},
        {id:'Murray',type:'admin',firstName:'Chris',lastName:'Murray',year:'Staff',pin:'2026'},
        {id:'Townshend',type:'admin',firstName:'Ben',lastName:'Townshend',year:'Staff',pin:'2026'},
        {id:'Medland',type:'admin',firstName:'Zac',lastName:'Medland',year:'Staff',pin:'2026'},
        {id:'Lingley',type:'admin',firstName:'Nick',lastName:'Lingley',year:'Staff',pin:'2026'},
        {id:'McKenzie',type:'admin',firstName:'Dean',lastName:'McKenzie',year:'Staff',pin:'2026'},
        {id:'Utting',type:'admin',firstName:'Craig',lastName:'Utting',year:'Staff',pin:'2026'},
        {id:'McConnell',type:'admin',firstName:'Shane',lastName:'McConnell',year:'Staff',pin:'2026'},
        {id:'Arndt',type:'admin',firstName:'Louise',lastName:'Arndt',year:'Staff',pin:'2026'},
        {id:'Gregg',type:'admin',firstName:'Gregg',lastName:'Le Roux',year:'Staff',pin:'2026'},
        {id:'mckinnonc',type:'student',firstName:'Caleb',lastName:'McKinnon',year:'13',pin:'3489'},
        {id:'milminel',type:'student',firstName:'Liam',lastName:'Milmine',year:'13',pin:'3489'},
        {id:'falknerc',type:'student',firstName:'Charlie',lastName:'Falkner',year:'13',pin:'3489'},
        {id:'englandj',type:'student',firstName:'Joshua',lastName:'England',year:'13',pin:'3489'},
        {id:'sabeyl',type:'student',firstName:'Levi',lastName:'Sabey',year:'13',pin:'3489'},
        {id:'thompsonj',type:'student',firstName:'Joel',lastName:'Thompson',year:'13',pin:'3489'},
        {id:'capillc',type:'student',firstName:'Caleb',lastName:'Capill',year:'12',pin:'3489'},
        {id:'jeagerm',type:'student',firstName:'Matthew',lastName:'Jeager',year:'12',pin:'3489'},
        {id:'blewettm',type:'student',firstName:'Marica',lastName:'Blewett',year:'11',pin:'3489'},
        {id:'xuj',type:'student',firstName:'Jess',lastName:'Xu',year:'11',pin:'3489'},
        {id:'ballingerc',type:'student',firstName:'Cody',lastName:'Ballinger',year:'11',pin:'3489'},
        {id:'posthumaa',type:'student',firstName:'Austin',lastName:'Posthuma',year:'11',pin:'3489'},
        {id:'scouldingh',type:'student',firstName:'Henry',lastName:'Scoulding',year:'10',pin:'3489'},
        {id:'lus',type:'student',firstName:'Symphony',lastName:'Lu',year:'10',pin:'3489'}
    ],
    jobs: [],
    tasks: [],
    tips: [
        {id:1,title:'Coiling Cables Properly',tags:['Sound','General'],content:'Always use the over-under technique to prevent kinks and extend cable life.'},
        {id:2,title:'Stage Left vs Stage Right',tags:['Stage','General'],content:'Stage left and right are from the performer\'s perspective facing the audience.'},
        {id:3,title:'Radio Etiquette',tags:['General'],content:'Keep transmissions brief. Say "copy" to confirm, "stand by" if you need a moment.'},
        {id:4,title:'Lighting Safety',tags:['Lighting'],content:'Never look directly at stage lights. Always let fixtures cool before handling.'},
        {id:5,title:'Sound Check Order',tags:['Sound','Booth'],content:'Start with drums, then bass, guitars, keys, and vocals last.'}
    ],
    calendar: {
        term: 1,
        weekNum: 1,
        weekType: 'A',
        holidays: []
    },
    points: {},
    badges: {},
    maintSlots: {},
    maintConfirmations: [],
    pendingConfirmations: []
};

// Badges Definition
const BADGES = [
    // Event Milestones
    {id:1,icon:'üéØ',name:'First Event',desc:'Sign up for your first event',master:false},
    {id:2,icon:'‚úÖ',name:'Getting Started',desc:'Complete your first event',master:false},
    {id:3,icon:'‚≠ê',name:'High Five',desc:'Complete 5 events',master:false},
    {id:4,icon:'üî•',name:'Perfect 10',desc:'Complete 10 events',master:false},
    {id:5,icon:'üí™',name:'Quarter Century',desc:'Complete 25 events',master:false},
    {id:6,icon:'üèÜ',name:'Half Century',desc:'Complete 50 events',master:false},
    {id:7,icon:'üëë',name:'Century Club',desc:'Complete 100 events',master:false},
    {id:8,icon:'üöÄ',name:'Event Machine',desc:'Complete 150 events',master:false},
    {id:9,icon:'‚ö°',name:'Legendary',desc:'Complete 200 events',master:false},
    {id:10,icon:'üî•',name:'Event Addict',desc:'Sign up for 5 events in one week',master:false},
    {id:11,icon:'üí•',name:'Event Junkie',desc:'Sign up for 10 events in 3 weeks',master:false},
    {id:12,icon:'üåü',name:'Quite the Term!',desc:'Sign up for 25 events in one term',master:false},
    // Maintenance & Tasks
    {id:13,icon:'üîß',name:'I Can Fix It!',desc:'Complete first maintenance task',master:false},
    {id:14,icon:'üõ†Ô∏è',name:'Handy Helper',desc:'Complete 5 maintenance tasks',master:false},
    {id:15,icon:'üî®',name:'Mr/Ms Fix It',desc:'Complete 10 maintenance tasks',master:false},
    {id:16,icon:'‚öôÔ∏è',name:'Maintenance Pro',desc:'Complete 25 maintenance tasks',master:false},
    {id:17,icon:'üèóÔ∏è',name:'Fix-It Felix',desc:'Complete 50 maintenance tasks',master:false},
    {id:18,icon:'üëÅÔ∏è',name:'Problem Spotter',desc:'Report your first problem',master:false},
    {id:19,icon:'ü¶Ö',name:'Eagle Eye',desc:'Report 10 problems',master:false},
    {id:20,icon:'üéñÔ∏è',name:'Quality Control',desc:'Report 25 problems',master:false},
    {id:21,icon:'‚öîÔ∏è',name:'Weekly Warrior',desc:'Complete weekly maintenance 4 weeks in a row',master:false},
    {id:22,icon:'üîó',name:'Maintenance Streak',desc:'Complete weekly maintenance 8 weeks in a row',master:false},
    {id:23,icon:'üè†',name:'House in Order',desc:'Complete weekly maintenance for an entire term',master:false},
    {id:24,icon:'‚ú®',name:'Order from Chaos',desc:'Complete weekly maintenance for 2 terms',master:false},
    {id:25,icon:'üåå',name:'Order from the Heavens!',desc:'Complete weekly maintenance for the whole year',master:false},
    // Roles & Specializations
    {id:26,icon:'üí°',name:'Lights Up!',desc:'Do lighting for an event',master:false},
    {id:27,icon:'üî¶',name:'Lighting Tech',desc:'Do lighting for 5 events',master:false},
    {id:28,icon:'‚ú®',name:'Lighting Designer',desc:'Do lighting for 15 events',master:false},
    {id:29,icon:'‚òÄÔ∏è',name:'Master of Light',desc:'Do lighting for 30 events',master:false},
    {id:30,icon:'üîä',name:'Sounds Good!',desc:'Do sound for an event',master:false},
    {id:31,icon:'üéß',name:'Sound Tech',desc:'Do sound for 5 events',master:false},
    {id:32,icon:'üéöÔ∏è',name:'Audio Engineer',desc:'Do sound for 15 events',master:false},
    {id:33,icon:'üéµ',name:'Sound Master',desc:'Do sound for 30 events',master:false},
    {id:34,icon:'üì∫',name:'I See You!',desc:'Do AV for an event',master:false},
    {id:35,icon:'üñ•Ô∏è',name:'AV Tech',desc:'Do AV for 5 events',master:false},
    {id:36,icon:'üìΩÔ∏è',name:'Visual Wizard',desc:'Do AV for 15 events',master:false},
    {id:37,icon:'üé¨',name:'AV Master',desc:'Do AV for 30 events',master:false},
    {id:38,icon:'üé≠',name:'Side of Stage',desc:'Do stage for an event',master:false},
    {id:39,icon:'üé™',name:'Stage Hand',desc:'Do stage for 5 events',master:false},
    {id:40,icon:'üìã',name:'Stage Manager',desc:'Do stage for 15 events',master:false},
    {id:41,icon:'üé≠',name:'Stage Master',desc:'Do stage for 30 events',master:false},
    {id:42,icon:'üåà',name:'All Rounder',desc:'Work in Lighting, Sound, Stage & AV',master:false},
    {id:43,icon:'üÉè',name:'Jack of All Trades',desc:'Do 3 different roles in one week',master:false},
    {id:44,icon:'üî™',name:'Swiss Army Knife',desc:'Work 5+ events in each role',master:false},
    // Points & Leaderboard
    {id:45,icon:'üí∞',name:'Point Scorer',desc:'Earn your first points',master:false},
    {id:46,icon:'üòé',name:'Chad',desc:'Earn 50+ points',master:false},
    {id:47,icon:'ü¶∏',name:'Legend',desc:'Earn 100+ points',master:false},
    {id:48,icon:'üíé',name:'Tuff',desc:'Earn 200+ points',master:false},
    {id:49,icon:'ü§ñ',name:'Point Machine',desc:'Earn 500+ points',master:false},
    {id:50,icon:'üèõÔ∏è',name:'Point Legend',desc:'Earn 1000+ points',master:false},
    {id:51,icon:'üîü',name:'Top 10',desc:'Reach the leaderboard',master:false},
    {id:52,icon:'üñêÔ∏è',name:'Famous 5',desc:'Reach top 5 on leaderboard',master:false},
    {id:53,icon:'ü•â',name:'Podium Finish',desc:'Reach top 3 on leaderboard',master:false},
    {id:54,icon:'ü•á',name:'Number One',desc:'Reach #1 on leaderboard',master:false},
    // Attendance & Reliability
    {id:55,icon:'‚úì',name:'Reliable',desc:'Attend every event you sign up for (10+)',master:false},
    {id:56,icon:'üìÖ',name:'Weekend Warrior',desc:'Work 1 weekend event',master:false},
    {id:57,icon:'‚öîÔ∏è',name:'Weekend Warlord',desc:'Work 3 weekend events',master:false},
    {id:58,icon:'ü¶â',name:'Night Owl',desc:'Work 5 evening events',master:false},
    {id:59,icon:'üåÖ',name:'Dawn Patrol',desc:'Work 3 early morning setups',master:false},
    {id:60,icon:'‚úåÔ∏è',name:'Double Header',desc:'Work 2 events in one day',master:false},
    {id:61,icon:'üëä',name:'Triple Threat',desc:'Work 3 events in one day',master:false},
    {id:62,icon:'üèÉ',name:'Marathon Day',desc:'Work 4+ events in one day',master:false},
    {id:63,icon:'üìÜ',name:'Full Week',desc:'Work at least one event every day for a week',master:false},
    {id:64,icon:'üö™',name:'Last to Leave',desc:'Final technician onsite after a big event',master:true},
    // Event Types
    {id:65,icon:'üì¢',name:'Assembly Pro',desc:'Work 6 assemblies',master:false},
    {id:66,icon:'üé§',name:'Assembly Veteran',desc:'Work 12 assemblies',master:false},
    {id:67,icon:'üîß',name:'Setup Specialist',desc:'Work 10 setup/packdowns',master:false},
    {id:68,icon:'üèóÔ∏è',name:'Setup Veteran',desc:'Work 25 setup/packdowns',master:false},
    {id:69,icon:'üìö',name:'Training Complete',desc:'Attend 3 training sessions',master:false},
    {id:70,icon:'üéì',name:'Training Expert',desc:'Attend 8 training sessions',master:false},
    {id:71,icon:'‚úã',name:'Present!',desc:'Attend 4 meetings',master:false},
    {id:72,icon:'üé∏',name:'Concert Crew',desc:'Work a music concert',master:true},
    {id:73,icon:'üéº',name:'Crescendo!',desc:'Work 4 music concerts',master:true},
    // Special Events & Productions
    {id:74,icon:'üé™',name:'Production Badge',desc:'Support the school production',master:true},
    {id:75,icon:'üßô',name:'Production Wizard',desc:'Support the production in a big way',master:true},
    {id:76,icon:'üèÜ',name:'Prize Giving Pro',desc:'Support a prizegiving',master:true},
    {id:77,icon:'üé≠',name:"Don't be so Dramatic",desc:'Support a drama assessment',master:true},
    {id:78,icon:'üé™',name:'Okay, be Dramatic!',desc:'Support 3 drama assessments',master:true},
    {id:79,icon:'üíÉ',name:'Dance the Night Away',desc:'Support a dance event',master:true},
    {id:80,icon:'üî•',name:'Kia Kaha!',desc:'Support a Kapa Haka or Pasifika Event',master:true},
    // Teamwork & Leadership
    {id:81,icon:'ü§ù',name:'Team Player',desc:'Work with 5 different crew members',master:false},
    {id:82,icon:'ü¶ã',name:'Social Butterfly',desc:'Work with 15 different crew members',master:false},
    {id:83,icon:'üíõ',name:"Everyone's Friend",desc:'Work with every team member',master:false},
    {id:84,icon:'üë®‚Äçüè´',name:'Mentor',desc:'Help train a new member',master:true},
    {id:85,icon:'üéñÔ∏è',name:'Senior Tech',desc:'Be on the team for 2 years',master:true},
    {id:86,icon:'üèÖ',name:'Veteran Tech',desc:'Be on the team for 3 years',master:true},
    {id:87,icon:'üë¥',name:'The Tech',desc:'Be on the team for 5 years',master:true},
    {id:88,icon:'‚≠ê',name:'Leadership Material',desc:'Lead a crew for an event',master:true},
    // Fun & Special
    {id:89,icon:'üéâ',name:'First Day',desc:'Join Tech Crew',master:false},
    {id:90,icon:'üí™',name:'Survivor',desc:'Make it through a chaotic event',master:true},
    {id:91,icon:'ü¶∏',name:'Unsung Hero',desc:'Go above and beyond',master:true},
    // Locations
    {id:92,icon:'üé¨',name:'Studio A Regular',desc:'Complete 10 Studio A tasks',master:false},
    {id:93,icon:'üñ•Ô∏è',name:'K119 Crew',desc:'Complete 10 K119 tasks',master:false},
    {id:94,icon:'üé≠',name:'Fixer Upper',desc:'Complete 10 Stage tasks',master:false},
    {id:95,icon:'üåç',name:'Everywhere',desc:'Complete tasks in every location',master:false}
];

// State
let state = {
    currentUser: null,
    isAdmin: false,
    isMaster: false,
    data: null,
    calendarMonth: new Date(),
    calendarView: 'events',
    selectedJob: null,
    selectedTask: null,
    selectedBadgeId: null,
    editingJob: null,
    tipFilter: 'All',
    pin: '',
    pat: localStorage.getItem('github_pat') || '',
    sha: null,
    saveInProgress: false,
    savePending: false
};

// ============ LOGIN ============
function submitUserId() {
    const id = $('userIdInput').value.trim().toLowerCase();
    if (!id) return showToast('Please enter your User ID', true);
    
    // Check against stored or default users
    const users = state.data?.users || DEFAULT_DATA.users;
    const user = users.find(u => u.id.toLowerCase() === id);
    
    if (!user) return showToast('User not found', true);
    
    state.currentUser = user;
    $('welcomeName').textContent = `Welcome, ${user.firstName}!`;
    $('stepId').classList.remove('active');
    $('stepPin').classList.add('active');
    state.pin = '';
    updatePinDots();
}

function backToId() {
    $('stepPin').classList.remove('active');
    $('stepId').classList.add('active');
    state.pin = '';
    state.currentUser = null;
}

function handlePinKey(key) {
    if (key === 'back') {
        state.pin = state.pin.slice(0, -1);
    } else if (state.pin.length < 4) {
        state.pin += key;
    }
    updatePinDots();
    
    if (state.pin.length === 4) {
        validatePin();
    }
}

function updatePinDots() {
    const dots = $$('#pinDots .pin-dot');
    dots.forEach((dot, i) => {
        dot.classList.remove('filled', 'error');
        if (i < state.pin.length) dot.classList.add('filled');
    });
}

function validatePin() {
    const user = state.currentUser;
    const userType = user.type;
    
    // Use fixed PINs based on user type
    const correctPin = userType === 'master' ? CONFIG.MASTER_PIN : userType === 'admin' ? CONFIG.ADMIN_PIN : CONFIG.STUDENT_PIN;
    
    if (state.pin === correctPin) {
        state.isAdmin = userType === 'admin' || userType === 'master';
        state.isMaster = userType === 'master';
        localStorage.setItem('techcrew_user', JSON.stringify(state.currentUser));
        localStorage.setItem('techcrew_admin', state.isAdmin);
        localStorage.setItem('techcrew_master', state.isMaster);
        enterApp();
    } else {
        const dots = $$('#pinDots .pin-dot');
        dots.forEach(d => d.classList.add('error'));
        setTimeout(() => {
            state.pin = '';
            updatePinDots();
        }, 500);
        showToast('Incorrect code', true);
    }
}

function enterApp() {
    $('loginScreen').classList.add('hidden');
    $('app').classList.add('active');
    if (state.isMaster) {
        $('app').classList.add('master-mode');
    } else if (state.isAdmin) {
        $('app').classList.add('admin-mode');
    }
    
    $('headerUserName').textContent = `${state.currentUser.firstName} ${state.currentUser.lastName}`;
    const badgeText = state.isMaster ? 'Master' : (state.isAdmin ? 'Admin' : 'Student');
    const badgeClass = state.isMaster ? 'master' : (state.isAdmin ? 'admin' : 'student');
    $('headerUserBadge').textContent = badgeText;
    $('headerUserBadge').className = 'header-user-badge ' + badgeClass;
    
    // Always start on Home page
    $$('.page').forEach(p => p.classList.remove('active'));
    $('pageHome').classList.add('active');
    $$('.nav-item').forEach(n => n.classList.remove('active'));
    $$('.nav-item[data-page="pageHome"]').forEach(n => n.classList.add('active'));
    
    updateHeaderInfo();
    loadData().then(() => {
        loadPointsSystemUI();
    });
}

function logout() {
    localStorage.removeItem('techcrew_user');
    localStorage.removeItem('techcrew_admin');
    localStorage.removeItem('techcrew_master');
    state.currentUser = null;
    state.isAdmin = false;
    state.isMaster = false;
    state.pin = '';
    $('app').classList.remove('active', 'admin-mode', 'master-mode');
    $('loginScreen').classList.remove('hidden');
    $('stepPin').classList.remove('active');
    $('stepId').classList.add('active');
    $('userIdInput').value = '';
}

// ============ DATA SYNC ============
async function loadData() {
    $('syncStatus')?.classList.add('syncing');
    
    // First try to load from GitHub (public repo can be read without auth)
    try {
        const res = await fetch(`https://api.github.com/repos/${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}/contents/${CONFIG.DATA_FILE}`, {
            cache: 'no-store'
        });
        if (res.ok) {
            const file = await res.json();
            state.sha = file.sha;
            state.data = JSON.parse(atob(file.content));
            // Decode and store PAT locally if it exists in data
            if (state.data.githubPatEncoded) {
                const decodedPat = decodePat(state.data.githubPatEncoded);
                if (decodedPat) {
                    localStorage.setItem('github_pat', decodedPat);
                }
            }
            localStorage.setItem('techcrew_data', JSON.stringify(state.data));
        } else {
            console.error('GitHub fetch failed:', res.status);
            // Fallback to localStorage
            const saved = localStorage.getItem('techcrew_data');
            state.data = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(DEFAULT_DATA));
        }
    } catch (e) {
        console.error('Load error:', e);
        const saved = localStorage.getItem('techcrew_data');
        state.data = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(DEFAULT_DATA));
    }
    
    $('syncStatus')?.classList.remove('syncing');
    renderAll();
}

async function saveData() {
    // Debounce - prevent rapid successive saves
    if (state.saveInProgress) {
        console.log('[SYNC] Save already in progress, queuing...');
        state.savePending = true;
        return { success: false, error: 'Save in progress' };
    }
    
    state.saveInProgress = true;
    $('syncStatus')?.classList.add('syncing');
    
    // Always save to localStorage first
    localStorage.setItem('techcrew_data', JSON.stringify(state.data));
    console.log('[SYNC] Saved to localStorage');
    
    // Get PAT from localStorage (already decoded) or decode from data
    let pat = localStorage.getItem('github_pat');
    if (!pat && state.data?.githubPatEncoded) {
        pat = decodePat(state.data.githubPatEncoded);
    }
    
    if (!pat) {
        console.warn('[SYNC] No PAT available - changes saved locally only');
        state.saveInProgress = false;
        $('syncStatus')?.classList.remove('syncing');
        checkPendingSave();
        return { success: false, error: 'No PAT' };
    }
    
    if (CONFIG.REPO_OWNER && pat) {
        // Retry up to 3 times on conflict
        for (let attempt = 1; attempt <= 3; attempt++) {
            try {
                console.log(`[SYNC] Attempt ${attempt}: Fetching latest SHA...`);
                
                // Fetch latest SHA and merge with remote
                const getRes = await fetch(`https://api.github.com/repos/${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}/contents/${CONFIG.DATA_FILE}`, {
                    cache: 'no-store'
                });
                if (getRes.ok) {
                    const file = await getRes.json();
                    state.sha = file.sha;
                    
                    // Parse remote data and merge (keep newer changes)
                    const remoteData = JSON.parse(decodeURIComponent(escape(atob(file.content))));
                    mergeData(remoteData);
                    
                    console.log('[SYNC] Got SHA:', state.sha.slice(0,7));
                } else {
                    console.error('[SYNC] Failed to get SHA:', getRes.status);
                    state.saveInProgress = false;
                    $('syncStatus')?.classList.remove('syncing');
                    checkPendingSave();
                    return { success: false, error: 'Failed to get SHA: ' + getRes.status };
                }
                
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(state.data, null, 2))));
                console.log('[SYNC] Pushing to GitHub...');
                
                const res = await fetch(`https://api.github.com/repos/${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}/contents/${CONFIG.DATA_FILE}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${pat}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'Update data',
                        content: content,
                        sha: state.sha
                    })
                });
                
                if (res.ok) {
                    const result = await res.json();
                    state.sha = result.content.sha;
                    console.log('[SYNC] ‚úì Saved to GitHub successfully');
                    localStorage.setItem('techcrew_data', JSON.stringify(state.data));
                    state.saveInProgress = false;
                    $('syncStatus')?.classList.remove('syncing');
                    checkPendingSave();
                    return { success: true };
                } else if (res.status === 409 && attempt < 3) {
                    console.log('[SYNC] Conflict detected, retrying...');
                    await new Promise(r => setTimeout(r, 500 * attempt));
                    continue;
                } else {
                    const errorText = await res.text();
                    console.error('[SYNC] Save failed:', res.status, errorText);
                    state.saveInProgress = false;
                    $('syncStatus')?.classList.remove('syncing');
                    checkPendingSave();
                    return { success: false, error: `GitHub error ${res.status}` };
                }
            } catch (e) {
                console.error('[SYNC] Error:', e);
                if (attempt === 3) {
                    state.saveInProgress = false;
                    $('syncStatus')?.classList.remove('syncing');
                    checkPendingSave();
                    return { success: false, error: e.message };
                }
            }
        }
    }
    
    state.saveInProgress = false;
    $('syncStatus')?.classList.remove('syncing');
    checkPendingSave();
    return { success: false, error: 'No repo configured' };
}

function checkPendingSave() {
    if (state.savePending) {
        state.savePending = false;
        console.log('[SYNC] Processing queued save...');
        setTimeout(() => saveData(), 100);
    }
}

function mergeData(remoteData) {
    // Merge arrays by ID (keep items from both, prefer local for conflicts)
    const mergeArrayById = (local, remote, key = 'id') => {
        const merged = [...local];
        const localIds = new Set(local.map(i => i[key]));
        remote.forEach(item => {
            if (!localIds.has(item[key])) {
                merged.push(item);
            }
        });
        return merged;
    };
    
    // Merge jobs and tasks
    if (remoteData.jobs) {
        state.data.jobs = mergeArrayById(state.data.jobs || [], remoteData.jobs);
    }
    if (remoteData.tasks) {
        state.data.tasks = mergeArrayById(state.data.tasks || [], remoteData.tasks);
    }
    
    // Merge points (keep higher values)
    if (remoteData.points) {
        if (!state.data.points) state.data.points = {};
        Object.keys(remoteData.points).forEach(uid => {
            state.data.points[uid] = Math.max(state.data.points[uid] || 0, remoteData.points[uid] || 0);
        });
    }
    
    // Merge badges (union)
    if (remoteData.badges) {
        if (!state.data.badges) state.data.badges = {};
        Object.keys(remoteData.badges).forEach(uid => {
            const local = state.data.badges[uid] || [];
            const remote = remoteData.badges[uid] || [];
            state.data.badges[uid] = [...new Set([...local, ...remote])];
        });
    }
    
    console.log('[SYNC] Merged with remote data');
}

// ============ RENDER ============
function renderAll() {
    renderJobs();
    renderCalendar();
    renderMaintenance();
    renderTips();
    renderRewards();
    if (state.isAdmin || state.isMaster) {
        renderAdminJobs();
        renderConfirmList();
        renderUserList();
    }
    if (state.isMaster) {
        renderArchive();
    }
}

function updateHeaderInfo() {
    const now = new Date();
    const options = { weekday: 'long', day: 'numeric', month: 'long' };
    $('headerDate').textContent = 'üìÖ ' + now.toLocaleDateString('en-NZ', options);
    
    const weekInfo = getWeekInfo(now);
    if (weekInfo.term > 0) {
        $('headerTerm').textContent = `üìö Term ${weekInfo.term}`;
        $('headerWeek').textContent = `Week ${weekInfo.week} (${weekInfo.type})`;
    } else {
        $('headerTerm').textContent = `üìö Holidays`;
        $('headerWeek').textContent = '';
    }
    
    // Update sync status if on settings page
    if (state.isMaster) {
        setTimeout(updateSyncStatus, 500);
    }
}

function renderJobs() {
    const jobs = state.data?.jobs || [];
    const upcoming = jobs.filter(j => new Date(j.date) >= new Date().setHours(0,0,0,0) && j.status !== 'completed')
                         .sort((a,b) => new Date(a.date) - new Date(b.date));
    
    if (!upcoming.length) {
        $('jobsList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><div class="empty-state-text">No upcoming events</div></div>';
        return;
    }
    
    let html = '';
    let currentTermWeek = '';
    let currentDate = '';
    
    upcoming.forEach(job => {
        const termWeek = getTermWeekForDate(job.date);
        const jobDate = new Date(job.date).toLocaleDateString('en-NZ', {weekday:'long', day:'numeric', month:'long'});
        
        // Group header by Term/Week
        if (termWeek !== currentTermWeek) {
            currentTermWeek = termWeek;
            currentDate = ''; // Reset date when term changes
            html += `<div style="font-size:0.9rem;font-weight:700;color:var(--gold);margin:1.25rem 0 0.5rem;padding:0.5rem;background:var(--bg-input);border-radius:8px">${termWeek}</div>`;
        }
        
        // Sub-header by date
        if (jobDate !== currentDate) {
            currentDate = jobDate;
            html += `<div style="font-size:0.75rem;color:var(--text-muted);margin:0.75rem 0 0.25rem;padding-left:0.25rem">${jobDate}</div>`;
        }
        
        const crewHtml = job.crew?.length 
            ? job.crew.map(c => {
                const role = job.crewRoles?.[c];
                return `<span class="job-crew-member">${c}${role ? ' ('+role+')' : ''}</span>`;
            }).join('')
            : '<span class="job-crew-empty">No signups yet</span>';
        
        html += `
            <div class="job-item ${job.category}" onclick="openJobDetails('${job.id}')">
                <div class="job-header">
                    <span class="job-title">${job.title}</span>
                    <span class="job-category">${job.category}</span>
                </div>
                <div class="job-meta" style="color:var(--text-muted)">üïê ${formatTime(job.time)} ¬∑ üìç ${job.location}</div>
                <div class="job-crew">${crewHtml}</div>
            </div>
        `;
    });
    
    $('jobsList').innerHTML = html;
}

function renderCalendar() {
    const year = state.calendarMonth.getFullYear();
    const month = state.calendarMonth.getMonth();
    
    $('calendarTitle').textContent = state.calendarMonth.toLocaleDateString('en-NZ', {month:'long', year:'numeric'});
    
    const firstDay = new Date(year, month, 1).getDay();
    const startOffset = firstDay === 0 ? 6 : firstDay - 1; // Monday start
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const today = new Date();
    
    let html = '';
    let dayCount = 0;
    let weekInMonth = 0;
    
    // Empty cells before first day (with week label for first row)
    if (startOffset > 0) {
        const firstDate = new Date(year, month, 1);
        const weekInfo = getWeekInfo(firstDate);
        const labelClass = weekInfo.term === 0 ? 'holiday' : weekInfo.type === 'A' ? 'week-a' : 'week-b';
        html += `<div class="calendar-week-label ${labelClass}">${weekInfo.label}</div>`;
        for (let i = 0; i < startOffset; i++) {
            html += '<div class="calendar-day empty"></div>';
        }
        dayCount = startOffset;
        weekInMonth = 1;
    }
    
    // Days
    for (let d = 1; d <= daysInMonth; d++) {
        // Start new row with week label
        if (dayCount % 7 === 0) {
            const dateForWeek = new Date(year, month, d);
            const weekInfo = getWeekInfo(dateForWeek);
            const labelClass = weekInfo.term === 0 ? 'holiday' : weekInfo.type === 'A' ? 'week-a' : 'week-b';
            html += `<div class="calendar-week-label ${labelClass}">${weekInfo.label}</div>`;
            weekInMonth++;
        }
        
        const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === d;
        
        // Events only - no maintenance
        const jobs = (state.data?.jobs || []).filter(j => j.date === dateStr && j.status !== 'completed');
        
        let classes = ['calendar-day'];
        if (isToday) classes.push('today');
        if (jobs.length) classes.push('has-event');
        
        // Check if holiday
        const dateObj = new Date(dateStr);
        if (isHoliday(dateObj)) classes.push('holiday');
        
        // Show dots with category colors (no maintenance)
        let dots = '';
        if (jobs.length) {
            jobs.slice(0, 3).forEach(j => {
                const color = getCategoryColor(j.category);
                dots += `<div class="dot" style="background:${color}"></div>`;
            });
        }
        
        html += `
            <div class="${classes.join(' ')}" onclick="openDayEvents('${dateStr}')">
                <span class="date">${d}</span>
                <div class="dots">${dots}</div>
            </div>
        `;
        dayCount++;
    }
    
    // Fill remaining cells in last row
    const remaining = 7 - (dayCount % 7);
    if (remaining < 7) {
        for (let i = 0; i < remaining; i++) {
            html += '<div class="calendar-day empty"></div>';
        }
    }
    
    $('calendarDays').innerHTML = html;
    renderMaintenanceCalendar();
}

function getWeekInfo(date) {
    // 2026 term dates
    const terms = [
        { term: 1, start: new Date(2026, 0, 26), end: new Date(2026, 3, 3), startWeek: 'B' },
        { term: 2, start: new Date(2026, 3, 20), end: new Date(2026, 6, 3), startWeek: 'B' },
        { term: 3, start: new Date(2026, 6, 20), end: new Date(2026, 8, 25), startWeek: 'A' },
        { term: 4, start: new Date(2026, 9, 12), end: new Date(2026, 11, 11), startWeek: 'A' }
    ];
    
    for (const t of terms) {
        if (date >= t.start && date <= t.end) {
            const weekNum = Math.floor((date - t.start) / (7 * 24 * 60 * 60 * 1000)) + 1;
            const weekType = (weekNum % 2 === 1) === (t.startWeek === 'A') ? 'A' : 'B';
            return { label: `W${weekNum}${weekType}`, type: weekType, term: t.term, week: weekNum };
        }
    }
    return { label: 'Hol', type: 'A', term: 0, week: 0 };
}

function isHoliday(date) {
    // 2026 term dates - check if outside terms
    const terms = [
        { start: new Date(2026, 0, 26), end: new Date(2026, 3, 3) },
        { start: new Date(2026, 3, 20), end: new Date(2026, 6, 3) },
        { start: new Date(2026, 6, 20), end: new Date(2026, 8, 25) },
        { start: new Date(2026, 9, 12), end: new Date(2026, 11, 11) }
    ];
    
    if (date.getFullYear() !== 2026) return false;
    
    for (const t of terms) {
        if (date >= t.start && date <= t.end) return false;
    }
    return true;
}

function getCategoryColor(category) {
    const colors = {
        'maintenance': '#3b82f6',
        'setup': '#f97316',
        'event': '#d4a848',
        'assembly': '#22c55e',
        'training': '#ef4444',
        'meeting': '#a855f7',
        'other': '#ec4899'
    };
    return colors[category] || '#666';
}

function renderMaintenanceCalendar() {
    const days = ['Monday','Tuesday','Wednesday','Thursday','Friday'];
    const timeSlots = ['Before School','Interval','Lunchtime','After School'];
    const userSlots = state.data?.maintSlots || {};
    const users = state.data?.users || [];
    
    // Build header row
    let html = '<div class="maint-grid">';
    html += '<div class="maint-header-cell"></div>'; // Empty corner
    days.forEach(day => {
        html += `<div class="maint-header-cell">${day.slice(0,3)}</div>`;
    });
    
    // Build each time slot row
    timeSlots.forEach(slot => {
        html += `<div class="maint-row-label">${slot}</div>`;
        days.forEach(day => {
            const slotKey = `${day}-${slot}`;
            const slotUsers = Object.entries(userSlots).filter(([uid, s]) => s === slotKey);
            const cellHtml = slotUsers.length 
                ? slotUsers.map(([uid]) => {
                    const user = users.find(u => u.id === uid);
                    const name = user ? user.firstName : uid;
                    const confirmed = (state.data?.maintConfirmations || []).some(c => c.userId === uid && c.week === getCurrentWeekId());
                    return `<div class="maint-name ${confirmed ? 'confirmed' : ''}">${name}</div>`;
                }).join('')
                : '<div class="maint-name empty">‚Äî</div>';
            html += `<div class="maint-cell">${cellHtml}</div>`;
        });
    });
    
    html += '</div>';
    $('maintWeek').innerHTML = html;
}

function renderMaintenance() {
    const tasks = state.data?.tasks || [];
    
    if (!tasks.length) {
        $('maintenanceList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîß</div><div class="empty-state-text">No maintenance tasks</div></div>';
        return;
    }
    
    // Students only see pending tasks, Master sees all (completed moved to Archive)
    const pending = tasks.filter(t => t.status !== 'complete');
    
    let html = '';
    
    if (pending.length) {
        pending.forEach(task => {
            html += renderTaskItem(task);
        });
    } else {
        html = '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><div class="empty-state-text">All tasks complete!</div></div>';
    }
    
    $('maintenanceList').innerHTML = html;
}

function renderTaskItem(task, completed = false) {
    let statusClass, statusText;
    switch(task.status) {
        case 'complete': statusClass = 'complete'; statusText = 'Complete'; break;
        case 'marked-done': statusClass = 'marked-done'; statusText = 'Marked Done'; break;
        case 'in-progress': statusClass = 'in-progress'; statusText = 'In Progress'; break;
        default: statusClass = 'pending'; statusText = 'Pending';
    }
    
    const reportedBy = task.reporterName ? `<div style="font-size:0.7rem;color:var(--text-muted);margin-top:0.25rem">Reported by: ${task.reporterName}</div>` : '';
    const urgencyInfo = task.urgency ? `<span style="font-size:0.7rem;color:${task.urgencyLevel === 1 ? 'var(--danger)' : 'var(--text-muted)'}"> ¬∑ ‚è∞ ${task.urgency}</span>` : '';
    
    let adminButtons = '';
    if ((state.isAdmin || state.isMaster) && (task.status === 'in-progress' || task.status === 'marked-done') && !completed) {
        adminButtons = `<button class="modal-btn primary" style="margin-top:0.5rem;min-height:36px;font-size:0.8rem" onclick="event.stopPropagation();openAdminConfirmMaint('${task.id}')">‚úÖ Confirm Complete</button>`;
    }
    
    return `
        <div class="task-item ${completed ? 'completed' : ''}" onclick="openTaskDetails('${task.id}')">
            <div class="task-header">
                <span class="task-title">${task.title}</span>
                <span class="task-status ${statusClass}">${statusText}</span>
            </div>
            <div class="task-meta">üìç ${task.location}${urgencyInfo}${task.assignees?.length ? ' ¬∑ üë• ' + task.assignees.join(', ') : ''}</div>
            ${reportedBy}
            ${adminButtons}
        </div>
    `;
}

function renderTips() {
    const tips = state.data?.tips || [];
    const allTags = ['All', ...new Set(tips.flatMap(t => t.tags))];
    
    let filterHtml = allTags.map(tag => 
        `<button class="tip-filter ${state.tipFilter === tag ? 'active' : ''}" onclick="setTipFilter('${tag}')">${tag}</button>`
    ).join('');
    $('tipFilters').innerHTML = filterHtml;
    
    const filtered = state.tipFilter === 'All' ? tips : tips.filter(t => t.tags.includes(state.tipFilter));
    
    if (!filtered.length) {
        $('tipsList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí°</div><div class="empty-state-text">No tips found</div></div>';
        return;
    }
    
    let html = '';
    
    // Admin add button
    if (state.isAdmin) {
        html += `<button class="modal-btn primary" style="width:100%;margin-bottom:1rem" onclick="openAddTipModal()">+ Add Tip</button>`;
    }
    
    filtered.forEach(tip => {
        html += `
            <div class="tip-item">
                <div class="tip-title">${tip.title}</div>
                <div class="tip-tags">${tip.tags.map(t => `<span class="tip-tag">${t}</span>`).join('')}</div>
                <div class="tip-desc">${tip.content}</div>
            </div>
        `;
    });
    
    $('tipsList').innerHTML = html;
}

function renderRewards() {
    const userId = state.currentUser?.id;
    const points = state.data?.points || {};
    const userPoints = points[userId] || 0;
    
    $('userPoints').textContent = userPoints;
    
    // Leaderboard - top 10 students only
    const users = state.data?.users || [];
    const studentIds = users.filter(u => u.type === 'student').map(u => u.id);
    
    const sortedUsers = Object.entries(points)
        .filter(([uid]) => studentIds.includes(uid))
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
    
    let leaderHtml = '';
    
    sortedUsers.forEach(([uid, pts], i) => {
        const user = users.find(u => u.id === uid);
        const name = user ? `${user.firstName} ${user.lastName}` : uid;
        const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
        
        leaderHtml += `
            <div class="leaderboard-item">
                <span class="leaderboard-rank ${rankClass}">${i + 1}</span>
                <span class="leaderboard-name">${name}</span>
                <span class="leaderboard-points">${pts} pts</span>
            </div>
        `;
    });
    
    if (!sortedUsers.length) {
        leaderHtml = '<div style="text-align:center;color:var(--text-muted);padding:1rem">No points earned yet</div>';
    }
    
    $('leaderboard').innerHTML = leaderHtml;
    
    // Badges - add manual class for master-awarded badges
    const userBadges = state.data?.badges?.[userId] || [];
    let badgeHtml = '';
    
    BADGES.forEach(badge => {
        const earned = userBadges.includes(badge.id);
        const manualClass = badge.master ? 'manual' : '';
        badgeHtml += `
            <div class="badge-item ${earned ? 'earned' : 'locked'} ${manualClass}" onclick="showBadgeDetails(${badge.id})">
                <div class="badge-icon">${badge.icon}</div>
                <div class="badge-name">${badge.name}</div>
            </div>
        `;
    });
    
    $('badgeGrid').innerHTML = badgeHtml;
}

function renderAdminJobs() {
    const jobs = state.data?.jobs || [];
    
    if (!jobs.length) {
        $('adminJobsList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><div class="empty-state-text">No events created</div></div>';
        return;
    }
    
    const active = jobs.filter(j => j.status !== 'completed').sort((a,b) => new Date(a.date) - new Date(b.date));
    const completed = jobs.filter(j => j.status === 'completed').sort((a,b) => new Date(b.date) - new Date(a.date));
    
    let html = '';
    
    if (active.length) {
        html += '<div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:0.5rem">Active Events</div>';
        html += active.map(job => `
            <div class="job-item ${job.category}">
                <div class="job-header">
                    <span class="job-title">${job.title}</span>
                    <span class="job-category">${job.category}</span>
                </div>
                <div class="job-meta">üìÖ ${formatDate(job.date)} ¬∑ üïê ${formatTime(job.time)} ¬∑ üìç ${job.location}</div>
                <div class="job-crew">${job.crew?.length ? job.crew.map(c => `<span class="job-crew-member">${c}</span>`).join('') : '<span class="job-crew-empty">No signups</span>'}</div>
                <div style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-top:0.75rem">
                    <button class="modal-btn cancel" style="flex:1;min-height:40px;font-size:0.8rem" onclick="editJob('${job.id}')">Edit</button>
                    <button class="modal-btn gold" style="flex:1;min-height:40px;font-size:0.8rem" onclick="openManageCrewModal('${job.id}')">üë• Crew</button>
                    <button class="modal-btn primary" style="flex:1;min-height:40px;font-size:0.8rem" onclick="openCompleteEventModal('${job.id}')">‚úÖ Complete</button>
                    <button class="modal-btn danger" style="flex:1;min-height:40px;font-size:0.8rem" onclick="deleteJob('${job.id}')">Delete</button>
                </div>
            </div>
        `).join('');
    }
    
    if (completed.length) {
        html += '<div style="font-size:0.8rem;color:var(--text-muted);margin:1rem 0 0.5rem">Completed Events</div>';
        html += completed.slice(0, 10).map(job => `
            <div class="job-item ${job.category}" style="opacity:0.6">
                <div class="job-header">
                    <span class="job-title">${job.title}</span>
                    <span class="job-category">‚úì ${job.category}</span>
                </div>
                <div class="job-meta">üìÖ ${formatDate(job.date)} ¬∑ ${job.attendees?.length || 0} attended</div>
            </div>
        `).join('');
    }
    
    $('adminJobsList').innerHTML = html || '<div class="empty-state"><div class="empty-state-icon">üìù</div><div class="empty-state-text">No events created</div></div>';
}

function renderConfirmList() {
    const pending = state.data?.pendingConfirmations || [];
    
    if (!pending.length) {
        $('confirmList').innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:1rem">No pending confirmations</div>';
        return;
    }
    
    const users = state.data?.users || [];
    
    let html = pending.map(p => {
        const user = users.find(u => u.id === p.userId);
        const name = p.userName || (user ? `${user.firstName} ${user.lastName}` : p.userId);
        const timeAgo = getTimeAgo(p.timestamp);
        
        return `
            <div class="confirm-item" style="flex-direction:column;align-items:stretch;gap:0.5rem">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div class="confirm-item-name">${name}</div>
                    <div style="font-size:0.7rem;color:var(--text-muted)">${timeAgo}</div>
                </div>
                <div class="confirm-item-meta">${p.type}${p.week ? ` (${p.week})` : ''}</div>
                <div style="font-size:0.85rem;color:var(--text-secondary);background:var(--bg-elevated);padding:0.5rem;border-radius:6px">${p.detail}</div>
                <div style="display:flex;gap:0.5rem">
                    <button class="confirm-btn approve" style="flex:1" onclick="approveConfirmation('${p.id}')">‚úì Approve (+${p.points || 5} pts)</button>
                    <button class="confirm-btn deny" style="flex:1" onclick="denyConfirmation('${p.id}')">‚úï Deny</button>
                </div>
            </div>
        `;
    }).join('');
    
    $('confirmList').innerHTML = html;
}

function getTimeAgo(timestamp) {
    const now = new Date();
    const then = new Date(timestamp);
    const mins = Math.floor((now - then) / 60000);
    if (mins < 60) return `${mins}m ago`;
    const hours = Math.floor(mins / 60);
    if (hours < 24) return `${hours}h ago`;
    const days = Math.floor(hours / 24);
    return `${days}d ago`;
}

function denyConfirmation(confirmId) {
    state.data.pendingConfirmations = (state.data.pendingConfirmations || []).filter(p => p.id !== confirmId);
    saveData();
    showToast('Confirmation denied');
    renderAll();
}

function renderUserList() {
    const users = state.data?.users || [];
    
    let html = users.map(user => {
        const initials = (user.firstName[0] + user.lastName[0]).toUpperCase();
        const points = state.data?.points?.[user.id] || 0;
        const badges = state.data?.badges?.[user.id]?.length || 0;
        return `
            <div class="user-list-item">
                <div class="user-avatar ${user.type}">${initials}</div>
                <div class="user-info">
                    <div class="user-name">${user.firstName} ${user.lastName}</div>
                    <div class="user-meta">${user.id} ¬∑ ${user.type === 'master' ? 'Master' : user.type === 'admin' ? 'Staff' : 'Year ' + user.year} ¬∑ ${points}pts ¬∑ ${badges} badges</div>
                </div>
                <div class="user-actions">
                    <button class="user-action-btn" onclick="openEditUserModal('${user.id}')">‚úèÔ∏è</button>
                    ${user.type !== 'master' ? `<button class="user-action-btn" onclick="deleteUser('${user.id}')">üóëÔ∏è</button>` : ''}
                </div>
            </div>
        `;
    }).join('');
    
    $('userList').innerHTML = html;
}

// ============ MODALS ============
function openModal(id) { $(id).classList.add('active'); }
function closeModal(id) { $(id).classList.remove('active'); }

function openJobDetails(jobId) {
    const job = state.data.jobs.find(j => j.id === jobId);
    if (!job) return;
    
    state.selectedJob = job;
    $('jobModalTitle').textContent = job.title;
    
    let html = `
        <div class="event-detail"><div class="event-detail-label">Category</div><div class="event-detail-value">${job.category}</div></div>
        <div class="event-detail"><div class="event-detail-label">Date & Time</div><div class="event-detail-value">${formatDate(job.date)} at ${formatTime(job.time)}</div></div>
        <div class="event-detail"><div class="event-detail-label">Term/Week</div><div class="event-detail-value">${getTermWeekForDate(job.date)}</div></div>
        <div class="event-detail"><div class="event-detail-label">Location</div><div class="event-detail-value">${job.location}</div></div>
        <div class="event-detail"><div class="event-detail-label">Description</div><div class="event-detail-value">${job.description || 'No description'}</div></div>
    `;
    
    // Gear list
    if (job.gearList?.length) {
        html += `<div class="event-detail"><div class="event-detail-label">Gear Required</div><div class="event-detail-value">${job.gearList.map(g => '‚Ä¢ '+g).join('<br>')}</div></div>`;
    }
    
    // Requirements as bullet points
    if (job.requirements?.length) {
        const reqList = job.requirements.map(r => {
            const isCompulsory = job.compulsoryReqs?.includes(r);
            return isCompulsory ? `‚Ä¢ <strong>${r} *</strong>` : `‚Ä¢ ${r}`;
        }).join('<br>');
        html += `<div class="event-detail"><div class="event-detail-label">Requirements</div><div class="event-detail-value">${reqList}</div></div>`;
    }
    
    // Crew with roles (only show preferences to admin/master)
    html += `<div class="event-detail"><div class="event-detail-label">Crew</div>`;
    if (job.crew?.length) {
        html += `<div class="crew-list">`;
        job.crew.forEach(name => {
            const role = job.crewRoles?.[name];
            const prefs = job.crewPrefs?.[name]?.roles;
            let chipContent = name;
            if (role) {
                chipContent += ` <span style="color:var(--gold)">(${role})</span>`;
            } else if (prefs?.length && (state.isAdmin || state.isMaster)) {
                // Only show preferences to admin/master
                chipContent += ` <span style="color:var(--text-muted);font-size:0.75rem">[prefers: ${prefs.join(', ')}]</span>`;
            }
            html += `<span class="crew-chip">${chipContent}</span>`;
        });
        html += `</div>`;
    } else {
        html += `<div class="event-detail-value" style="color:var(--text-muted)">No one signed up yet</div>`;
    }
    html += '</div>';
    
    $('jobModalContent').innerHTML = html;
    
    // Check if already signed up
    const userName = `${state.currentUser.firstName} ${state.currentUser.lastName}`;
    const alreadySigned = job.crew?.includes(userName);
    
    if (state.isAdmin || state.isMaster) {
        $('jobSignupBtn').classList.add('hidden');
    } else {
        $('jobSignupBtn').classList.remove('hidden');
        $('jobSignupBtn').textContent = alreadySigned ? 'Already Signed Up' : 'Sign Up';
        $('jobSignupBtn').disabled = alreadySigned;
        $('jobSignupBtn').style.opacity = alreadySigned ? '0.5' : '1';
    }
    
    openModal('jobModal');
}

function signupForJob() {
    const job = state.selectedJob;
    if (!job) return;
    
    $('signupJobName').textContent = `Sign up for: ${job.title}`;
    
    let html = '';
    
    // Role preferences section (if job has roles enabled)
    if (job.roles?.length) {
        html += '<div style="margin-bottom:1rem"><div style="font-weight:600;margin-bottom:0.5rem;color:var(--text-secondary)">Role Preferences (optional)</div>';
        html += '<div class="checkbox-group">';
        job.roles.forEach((role, i) => {
            html += `
                <div class="checkbox-item">
                    <input type="checkbox" id="rolePrefs${i}" data-role="${role}">
                    <label for="rolePrefs${i}">${role}</label>
                </div>
            `;
        });
        html += '</div></div>';
    }
    
    // Requirements section
    if (job.requirements?.length) {
        html += '<div style="font-weight:600;margin-bottom:0.5rem;color:var(--text-secondary)">Confirm Commitments</div>';
        html += '<div class="checkbox-group">';
        job.requirements.forEach((req, i) => {
            const isCompulsory = job.compulsoryReqs?.includes(req);
            html += `
                <div class="checkbox-item ${isCompulsory ? 'required' : ''}">
                    <input type="checkbox" id="signupReq${i}" ${isCompulsory ? 'data-required="true"' : ''}>
                    <label for="signupReq${i}">${req}${isCompulsory ? ' *' : ''}</label>
                </div>
            `;
        });
        html += '</div>';
        if (job.compulsoryReqs?.length) {
            html += '<div style="font-size:0.75rem;color:var(--text-muted);margin-top:0.5rem">* Required to sign up</div>';
        }
    } else {
        html += '<p style="color:var(--text-muted);text-align:center">No special requirements</p>';
    }
    
    $('signupRequirements').innerHTML = html;
    closeModal('jobModal');
    openModal('signupModal');
}

function confirmSignup() {
    const job = state.selectedJob;
    if (!job) return;
    
    // Check compulsory requirements are ticked
    const requiredCheckboxes = $$('#signupRequirements input[data-required="true"]');
    const allRequiredChecked = Array.from(requiredCheckboxes).every(cb => cb.checked);
    
    if (requiredCheckboxes.length && !allRequiredChecked) {
        showToast('Please confirm all required items (*)', true);
        return;
    }
    
    // Collect role preferences
    const rolePrefs = [];
    $$('#signupRequirements input[data-role]').forEach(cb => {
        if (cb.checked) rolePrefs.push(cb.dataset.role);
    });
    
    // Collect ticked requirements
    const tickedReqs = [];
    job.requirements?.forEach((req, i) => {
        if ($(`signupReq${i}`)?.checked) tickedReqs.push(req);
    });
    
    // Add user to crew
    const userName = `${state.currentUser.firstName} ${state.currentUser.lastName}`;
    if (!job.crew) job.crew = [];
    if (!job.crew.includes(userName)) {
        job.crew.push(userName);
    }
    
    // Store role preferences and ticked requirements
    if (!job.crewPrefs) job.crewPrefs = {};
    job.crewPrefs[userName] = { roles: rolePrefs, requirements: tickedReqs };
    
    // Award points
    addPoints(state.currentUser.id, 5, 'Event signup');
    
    // Check badges
    checkBadges();
    
    saveData();
    closeModal('signupModal');
    showToast('Signed up successfully! +5 points');
    renderAll();
}

function openAddJobModal() {
    state.editingJob = null;
    $('addJobModalTitle').textContent = 'Add Job';
    $('jobTitleInput').value = '';
    $('jobCategoryInput').value = 'setup';
    $('jobDateInput').value = '';
    $('jobTimeInput').value = '';
    $('jobLocationInput').value = '';
    $('jobDescInput').value = '';
    $$('#jobRequirements input').forEach(cb => cb.checked = false);
    
    // Reset all arrays
    customRequirements = [];
    customRoles = [];
    gearList = [];
    compulsoryReqs = [];
    
    // Re-render custom sections
    renderCustomReqs();
    renderCustomRoles();
    renderGearList();
    
    openModal('addJobModal');
}

function editJob(jobId) {
    const job = state.data.jobs.find(j => j.id === jobId);
    if (!job) return;
    
    state.editingJob = job;
    $('addJobModalTitle').textContent = 'Edit Job';
    $('jobTitleInput').value = job.title;
    $('jobCategoryInput').value = job.category;
    $('jobDateInput').value = job.date;
    $('jobTimeInput').value = job.time;
    $('jobLocationInput').value = job.location;
    $('jobDescInput').value = job.description || '';
    
    // Load saved requirements
    $$('#jobRequirements input').forEach(cb => {
        cb.checked = job.requirements?.includes(cb.value) || false;
    });
    
    // Load custom arrays from job
    customRequirements = job.customRequirements || [];
    customRoles = job.customRoles || [];
    gearList = job.gearList || [];
    compulsoryReqs = job.compulsoryReqs || [];
    
    // Re-render custom sections
    renderCustomReqs();
    renderCustomRoles();
    renderGearList();
    
    openModal('addJobModal');
}

let customRequirements = [];
let customRoles = [];
let gearList = [];
let compulsoryReqs = [];

function addCustomRequirement() {
    const input = $('customReqInput');
    const val = input.value.trim();
    if (val) {
        customRequirements.push(val);
        input.value = '';
        renderCustomReqs();
    }
}

function removeCustomReq(idx) {
    customRequirements.splice(idx, 1);
    renderCustomReqs();
}

function renderCustomReqs() {
    $('customReqsList').innerHTML = customRequirements.map((r, i) => 
        `<div class="req-row">
            <input type="checkbox" id="customReq${i}" checked>
            <label for="customReq${i}">${r}</label>
            <button class="req-toggle ${compulsoryReqs.includes('custom_'+i) ? 'compulsory' : ''}" onclick="toggleCustomCompulsory(${i})">${compulsoryReqs.includes('custom_'+i) ? '‚ö†Ô∏è' : '‚ö™'}</button>
            <button onclick="removeCustomReq(${i})" style="color:var(--primary);min-height:24px;min-width:24px">‚úï</button>
        </div>`
    ).join('');
}

function toggleCustomCompulsory(idx) {
    const key = 'custom_'+idx;
    if (compulsoryReqs.includes(key)) {
        compulsoryReqs = compulsoryReqs.filter(r => r !== key);
    } else {
        compulsoryReqs.push(key);
    }
    renderCustomReqs();
}

function addCustomRole() {
    const input = $('customRoleInput');
    const val = input.value.trim();
    if (val) {
        customRoles.push(val);
        input.value = '';
        renderCustomRoles();
    }
}

function renderCustomRoles() {
    $('customRolesList').innerHTML = customRoles.map((r, i) => 
        `<div class="gear-item">
            <span>${r}</span>
            <button onclick="customRoles.splice(${i},1);renderCustomRoles()" style="color:var(--primary);min-height:24px;min-width:24px">‚úï</button>
        </div>`
    ).join('');
}

function addGearItem() {
    const input = $('gearInput');
    const val = input.value.trim();
    if (val) {
        gearList.push(val);
        input.value = '';
        renderGearList();
    }
}

function renderGearList() {
    $('gearListItems').innerHTML = gearList.map((g, i) => 
        `<div class="gear-item">
            <span>‚Ä¢ ${g}</span>
            <button onclick="gearList.splice(${i},1);renderGearList()" style="color:var(--primary);min-height:24px;min-width:24px">‚úï</button>
        </div>`
    ).join('');
}

function toggleCompulsory(btn) {
    btn.classList.toggle('compulsory');
    btn.textContent = btn.classList.contains('compulsory') ? '‚ö†Ô∏è' : '‚ö™';
}

function saveJob() {
    const title = $('jobTitleInput').value.trim();
    const category = $('jobCategoryInput').value;
    const date = $('jobDateInput').value;
    const time = $('jobTimeInput').value;
    const location = $('jobLocationInput').value.trim();
    const description = $('jobDescInput').value.trim();
    
    if (!title || !date || !time || !location) {
        showToast('Please fill in all required fields', true);
        return;
    }
    
    // Role preferences
    const roles = [];
    if ($('roleLighting')?.checked) roles.push('Lighting');
    if ($('roleSound')?.checked) roles.push('Sound');
    if ($('roleStage')?.checked) roles.push('Stage');
    if ($('roleAV')?.checked) roles.push('AV');
    roles.push(...customRoles);
    
    // Requirements and compulsory tracking
    const requirements = [];
    const compulsory = [];
    
    const reqMap = {
        'reqSetup': 'I can setup before',
        'reqPackdown': 'I can packdown after',
        'reqBlack': 'Wear Blacks',
        'reqEarly15': 'Arrive 15 mins early',
        'reqEarly30': 'Arrive 30 mins early',
        'reqEarly60': 'Arrive 1 hour early'
    };
    
    Object.entries(reqMap).forEach(([id, label]) => {
        if ($(id)?.checked) {
            requirements.push(label);
            const toggle = document.querySelector(`.req-toggle[data-req="${id}"]`);
            if (toggle?.classList.contains('compulsory')) {
                compulsory.push(label);
            }
        }
    });
    
    customRequirements.forEach((r, i) => {
        requirements.push(r);
        if (compulsoryReqs.includes('custom_'+i)) {
            compulsory.push(r);
        }
    });
    
    if (state.editingJob) {
        Object.assign(state.editingJob, { title, category, date, time, location, description, requirements, roles, compulsoryReqs: compulsory, gearList: [...gearList] });
    } else {
        const job = {
            id: Date.now().toString(),
            title, category, date, time, location, description, requirements, roles,
            compulsoryReqs: compulsory,
            gearList: [...gearList],
            customRequirements: [...customRequirements],
            customRoles: [...customRoles],
            crew: [],
            crewRoles: {},
            crewPrefs: {},
            status: 'active',
            createdBy: state.currentUser.id
        };
        state.data.jobs.push(job);
    }
    
    // Also update custom arrays on edit
    if (state.editingJob) {
        state.editingJob.customRequirements = [...customRequirements];
        state.editingJob.customRoles = [...customRoles];
    }
    
    // Reset form state
    customRequirements = [];
    customRoles = [];
    gearList = [];
    compulsoryReqs = [];
    
    saveData();
    closeModal('addJobModal');
    showToast(state.editingJob ? 'Event updated!' : 'Event created!');
    renderAll();
}

function deleteJob(jobId) {
    if (!confirm('Delete this job?')) return;
    state.data.jobs = state.data.jobs.filter(j => j.id !== jobId);
    saveData();
    showToast('Job deleted');
    renderAll();
}

function openAddTaskModal() {
    $('taskTitleInput').value = '';
    $('taskLocationInput').value = 'Studio 1';
    $('taskDescInput').value = '';
    openModal('addTaskModal');
}

function saveTask() {
    const title = $('taskTitleInput').value.trim();
    const location = $('taskLocationInput').value;
    const description = $('taskDescInput').value.trim();
    
    if (!title) {
        showToast('Please enter a task title', true);
        return;
    }
    
    const task = {
        id: Date.now().toString(),
        title, location, description,
        status: 'pending',
        assignees: [],
        createdBy: state.currentUser.id,
        date: new Date().toISOString().split('T')[0]
    };
    
    state.data.tasks.push(task);
    saveData();
    closeModal('addTaskModal');
    showToast('Task added!');
    renderAll();
}

function openTaskDetails(taskId) {
    const task = state.data.tasks.find(t => t.id === taskId);
    if (!task) return;
    
    state.selectedTask = task;
    $('taskModalTitle').textContent = task.title;
    
    // Calculate urgency countdown (hidden from students)
    let urgencyDisplay = task.urgency || '';
    if ((state.isAdmin || state.isMaster) && task.urgencyCreatedAt && task.urgencyLevel) {
        const daysPassed = Math.floor((Date.now() - task.urgencyCreatedAt) / (1000 * 60 * 60 * 24));
        const urgencyDays = {1: 1, 2: 7, 3: 21, 4: 90, 5: 365}; // ASAP, Week, Few weeks, Term, Year
        const targetDays = urgencyDays[task.urgencyLevel] || 7;
        const daysRemaining = Math.max(0, targetDays - daysPassed);
        urgencyDisplay += ` <span style="color:${daysRemaining <= 2 ? 'var(--danger)' : 'var(--text-muted)'}">(${daysRemaining}d left)</span>`;
    }
    
    let html = `
        <div class="event-detail"><div class="event-detail-label">Location</div><div class="event-detail-value">${task.location}</div></div>
        <div class="event-detail"><div class="event-detail-label">Status</div><div class="event-detail-value">${task.status}</div></div>
        ${task.urgency ? `<div class="event-detail"><div class="event-detail-label">Urgency</div><div class="event-detail-value">${urgencyDisplay}</div></div>` : ''}
        <div class="event-detail"><div class="event-detail-label">Description</div><div class="event-detail-value">${task.description || 'No description'}</div></div>
    `;
    
    if (task.reporterName) {
        html += `<div class="event-detail"><div class="event-detail-label">Reported by</div><div class="event-detail-value">${task.reporterName}</div></div>`;
    }
    
    if (task.assignees?.length) {
        html += `<div class="event-detail"><div class="event-detail-label">Working on it</div><div class="crew-list">${task.assignees.map(a => `<span class="crew-chip">${a}</span>`).join('')}</div></div>`;
    }
    
    if (task.completionNote) {
        html += `<div class="event-detail"><div class="event-detail-label">Completion Note</div><div class="event-detail-value">${task.completionNote}</div></div>`;
    }
    
    $('taskModalContent').innerHTML = html;
    
    let btns = '<button class="modal-btn cancel" onclick="closeModal(\'taskModal\')">Close</button>';
    
    const userName = `${state.currentUser.firstName} ${state.currentUser.lastName}`;
    const isAssigned = task.assignees?.includes(userName);
    
    if (task.status !== 'complete') {
        // Anyone can sign up (multiple signups allowed)
        if (!isAssigned && !state.isAdmin && !state.isMaster) {
            btns += '<button class="modal-btn gold" onclick="assignToTask()">I\'ll Help</button>';
        }
        // Assignees can mark as ready for review
        if (isAssigned && task.status === 'in-progress') {
            btns += '<button class="modal-btn gold" onclick="markTaskReady()">‚úì Job Done</button>';
        }
        // Admin/Master can confirm complete or delete
        if ((state.isAdmin || state.isMaster) && (task.status === 'in-progress' || task.status === 'marked-done')) {
            btns += '<button class="modal-btn primary" onclick="openAdminConfirmMaint(\'' + task.id + '\')">‚úÖ Confirm Complete</button>';
        }
        // Admin/Master can always delete
        if (state.isAdmin || state.isMaster) {
            btns += '<button class="modal-btn" style="background:var(--danger);color:white" onclick="deleteTask(\'' + task.id + '\')">üóëÔ∏è Delete</button>';
        }
    }
    
    $('taskModalButtons').innerHTML = btns;
    openModal('taskModal');
}

function deleteTask(taskId) {
    if (!confirm('Delete this task? No points will be awarded.')) return;
    state.data.tasks = state.data.tasks.filter(t => t.id !== taskId);
    saveData();
    closeModal('taskModal');
    showToast('Task deleted');
    renderAll();
}

function assignToTask() {
    if (!state.selectedTask) return;
    
    // Find the actual task in state.data.tasks
    const task = state.data.tasks.find(t => t.id === state.selectedTask.id);
    if (!task) return;
    
    const userName = `${state.currentUser.firstName} ${state.currentUser.lastName}`;
    if (!task.assignees) task.assignees = [];
    if (!task.assignees.includes(userName)) {
        task.assignees.push(userName);
        task.status = 'in-progress';
    }
    
    saveData();
    closeModal('taskModal');
    showToast('You\'re assigned to this task!');
    renderAll();
}

function markTaskReady() {
    if (!state.selectedTask) return;
    
    // Find the actual task in state.data.tasks
    const task = state.data.tasks.find(t => t.id === state.selectedTask.id);
    if (!task) return;
    
    const note = prompt('Add a note about what was done (optional):');
    if (note !== null) {
        task.completionNote = note || '';
        task.status = 'marked-done';
        saveData();
        closeModal('taskModal');
        showToast('Marked as done - awaiting admin confirmation');
        renderAll();
    }
}

function completeTask() {
    const task = state.selectedTask;
    if (!task) return;
    
    task.status = 'complete';
    
    const users = state.data.users || [];
    task.assignees?.forEach(name => {
        const user = users.find(u => `${u.firstName} ${u.lastName}` === name);
        if (user) {
            addPoints(user.id, 10, 'Completed maintenance task');
        }
    });
    
    checkBadges();
    saveData();
    closeModal('taskModal');
    showToast('Task marked complete!');
    renderAll();
}

function openAddTipModal() {
    $('tipTitleInput').value = '';
    $('tipTagsInput').value = '';
    $('tipContentInput').value = '';
    openModal('addTipModal');
}

function saveTip() {
    const title = $('tipTitleInput').value.trim();
    const tags = $('tipTagsInput').value.split(',').map(t => t.trim()).filter(t => t);
    const content = $('tipContentInput').value.trim();
    
    if (!title || !content) {
        showToast('Please fill in title and content', true);
        return;
    }
    
    const tip = {
        id: Date.now(),
        title, tags: tags.length ? tags : ['General'], content
    };
    
    state.data.tips.push(tip);
    saveData();
    closeModal('addTipModal');
    showToast('Tip added!');
    renderAll();
}

function setTipFilter(filter) {
    state.tipFilter = filter;
    renderTips();
}

function openAddUserModal() {
    $('newUserIdInput').value = '';
    $('newUserFirstInput').value = '';
    $('newUserLastInput').value = '';
    $('newUserTypeInput').value = 'student';
    $('newUserYearInput').value = '10';
    openModal('addUserModal');
}

function saveUser() {
    const id = $('newUserIdInput').value.trim().toLowerCase();
    const firstName = $('newUserFirstInput').value.trim();
    const lastName = $('newUserLastInput').value.trim();
    const type = $('newUserTypeInput').value;
    const year = $('newUserYearInput').value;
    
    if (!id || !firstName || !lastName) {
        showToast('Please fill in all fields', true);
        return;
    }
    
    if (state.data.users.some(u => u.id.toLowerCase() === id)) {
        showToast('User ID already exists', true);
        return;
    }
    
    state.data.users.push({ id, type, firstName, lastName, year });
    saveData();
    closeModal('addUserModal');
    showToast('User added!');
    renderAll();
}

function deleteUser(userId) {
    if (!confirm('Delete this user?')) return;
    state.data.users = state.data.users.filter(u => u.id !== userId);
    saveData();
    showToast('User deleted');
    renderAll();
}

let editingUserId = null;

function openEditUserModal(userId) {
    const user = state.data.users.find(u => u.id === userId);
    if (!user) return;
    
    editingUserId = userId;
    $('editUserIdDisplay').value = user.id;
    $('editUserFirstInput').value = user.firstName;
    $('editUserLastInput').value = user.lastName;
    $('editUserTypeInput').value = user.type === 'master' ? 'admin' : user.type;
    $('editUserYearInput').value = user.year;
    $('editUserPointsInput').value = state.data.points?.[userId] || 0;
    $('editUserMaintInput').value = state.data.maintSlots?.[userId] || '';
    
    openModal('editUserModal');
}

async function saveEditUser() {
    if (!editingUserId) return;
    
    const user = state.data.users.find(u => u.id === editingUserId);
    if (!user) return;
    
    user.firstName = $('editUserFirstInput').value.trim() || user.firstName;
    user.lastName = $('editUserLastInput').value.trim() || user.lastName;
    if (user.type !== 'master') {
        user.type = $('editUserTypeInput').value;
    }
    user.year = $('editUserYearInput').value;
    
    const newPoints = parseInt($('editUserPointsInput').value) || 0;
    if (!state.data.points) state.data.points = {};
    state.data.points[editingUserId] = newPoints;
    
    const newMaint = $('editUserMaintInput').value;
    if (!state.data.maintSlots) state.data.maintSlots = {};
    if (newMaint) {
        state.data.maintSlots[editingUserId] = newMaint;
    } else {
        delete state.data.maintSlots[editingUserId];
    }
    
    editingUserId = null;
    const result = await saveData();
    closeModal('editUserModal');
    if (result.success) {
        showToast('User updated and synced!');
    } else {
        showToast('User saved locally. Sync: ' + (result.error || 'pending'), true);
    }
    renderAll();
}

function openRemovePointsModal() {
    const students = state.data.users.filter(u => u.type === 'student');
    $('removePointsStudent').innerHTML = '<option value="">Select student...</option>' +
        students.map(s => `<option value="${s.id}">${s.firstName} ${s.lastName} (${state.data.points?.[s.id] || 0} pts)</option>`).join('');
    $('removePointsAmount').value = 10;
    openModal('removePointsModal');
}

function confirmRemovePoints() {
    const studentId = $('removePointsStudent').value;
    const amount = parseInt($('removePointsAmount').value) || 0;
    
    if (!studentId || !amount) {
        showToast('Select student and amount', true);
        return;
    }
    
    if (!state.data.points) state.data.points = {};
    state.data.points[studentId] = Math.max(0, (state.data.points[studentId] || 0) - amount);
    
    saveData();
    closeModal('removePointsModal');
    showToast(`Removed ${amount} points`);
    renderAll();
}

function openRemoveBadgeModal() {
    const students = state.data.users.filter(u => u.type === 'student');
    $('removeBadgeStudent').innerHTML = '<option value="">Select student...</option>' +
        students.map(s => `<option value="${s.id}">${s.firstName} ${s.lastName}</option>`).join('');
    $('removeBadgeSelect').innerHTML = '<option value="">Select student first...</option>';
    openModal('removeBadgeModal');
}

function updateRemoveBadgeList() {
    const studentId = $('removeBadgeStudent').value;
    const userBadges = state.data.badges?.[studentId] || [];
    
    if (!userBadges.length) {
        $('removeBadgeSelect').innerHTML = '<option value="">No badges to remove</option>';
        return;
    }
    
    $('removeBadgeSelect').innerHTML = userBadges.map(bid => {
        const badge = BADGES.find(b => b.id === bid);
        return badge ? `<option value="${bid}">${badge.icon} ${badge.name}</option>` : '';
    }).join('');
}

function confirmRemoveBadge() {
    const studentId = $('removeBadgeStudent').value;
    const badgeId = parseInt($('removeBadgeSelect').value);
    
    if (!studentId || !badgeId) {
        showToast('Select student and badge', true);
        return;
    }
    
    if (!state.data.badges?.[studentId]) return;
    state.data.badges[studentId] = state.data.badges[studentId].filter(b => b !== badgeId);
    
    saveData();
    closeModal('removeBadgeModal');
    showToast('Badge removed');
    renderAll();
}

function openCalendarSettings() {
    const cal = state.data.calendar || {};
    $('termInput').value = cal.term || 1;
    $('weekNumInput').value = cal.weekNum || 1;
    $('weekTypeInput').value = cal.weekType || 'A';
    openModal('calendarSettingsModal');
}

function saveCalendarSettings() {
    state.data.calendar = {
        term: parseInt($('termInput').value),
        weekNum: parseInt($('weekNumInput').value),
        weekType: $('weekTypeInput').value,
        holidays: state.data.calendar?.holidays || []
    };
    saveData();
    closeModal('calendarSettingsModal');
    updateHeaderInfo();
    showToast('Calendar updated!');
}

function openMaintSlotModal() {
    const currentSlot = state.data.maintSlots?.[state.currentUser.id] || '';
    $('maintDayInput').value = currentSlot;
    openModal('maintSlotModal');
}

function saveMaintSlot() {
    const day = $('maintDayInput').value;
    if (!state.data.maintSlots) state.data.maintSlots = {};
    
    if (day) {
        state.data.maintSlots[state.currentUser.id] = day;
    } else {
        delete state.data.maintSlots[state.currentUser.id];
    }
    
    saveData();
    closeModal('maintSlotModal');
    showToast('Maintenance slot updated!');
    renderCalendar();
}

function openDayEvents(dateStr) {
    const jobs = state.data.jobs.filter(j => j.date === dateStr);
    const tasks = state.data.tasks.filter(t => t.date === dateStr);
    
    const date = new Date(dateStr);
    $('dayEventsTitle').textContent = date.toLocaleDateString('en-NZ', { weekday: 'long', day: 'numeric', month: 'long' });
    
    let html = '';
    
    if (jobs.length) {
        html += '<div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:0.5rem">Events</div>';
        jobs.forEach(job => {
            html += `
                <div class="job-item ${job.category}" style="cursor:pointer" onclick="closeModal('dayEventsModal');openJobDetails('${job.id}')">
                    <div class="job-header">
                        <span class="job-title">${job.title}</span>
                        <span class="job-category">${job.category}</span>
                    </div>
                    <div class="job-meta">üïê ${job.time} ¬∑ üìç ${job.location}</div>
                </div>
            `;
        });
    }
    
    if (tasks.length) {
        html += '<div style="font-size:0.8rem;color:var(--text-muted);margin:1rem 0 0.5rem">Maintenance</div>';
        tasks.forEach(task => {
            html += renderTaskItem(task);
        });
    }
    
    if (!jobs.length && !tasks.length) {
        html = '<div style="text-align:center;color:var(--text-muted);padding:2rem">No events this day</div>';
    }
    
    $('dayEventsList').innerHTML = html;
    openModal('dayEventsModal');
}

// ============ ACTIONS ============
function openActionSheet() {
    $('actionSheet').classList.add('active');
}

function closeActionSheet() {
    $('actionSheet').classList.remove('active');
}

function openReportProblem() {
    closeActionSheet();
    $('reportLocation').value = '';
    $('reportTitle').value = '';
    $('reportDesc').value = '';
    $('reportUrgency').value = '2';
    $('urgencyLabel').textContent = 'This week';
    $('customLocationInput').value = '';
    $('customLocationInput').classList.add('hidden');
    
    // Add listener for custom location toggle
    $('reportLocation').onchange = function() {
        if (this.value === 'custom') {
            $('customLocationInput').classList.remove('hidden');
        } else {
            $('customLocationInput').classList.add('hidden');
        }
    };
    
    openModal('reportModal');
}

const URGENCY_LABELS = ['', 'ASAP', 'This week', 'In the next few weeks', 'By the end of term', 'By the end of year'];

function updateUrgencyLabel() {
    const val = parseInt($('reportUrgency').value);
    $('urgencyLabel').textContent = URGENCY_LABELS[val];
}

let reportSubmitting = false;

function submitReport() {
    // Prevent double submission
    if (reportSubmitting) return;
    reportSubmitting = true;
    
    let location = $('reportLocation').value;
    const customLocation = $('customLocationInput')?.value?.trim();
    const title = $('reportTitle').value.trim();
    const desc = $('reportDesc').value.trim();
    const urgency = parseInt($('reportUrgency').value);
    
    if (location === 'custom' && customLocation) {
        location = customLocation;
    }
    
    if (!location || !title) {
        showToast('Please fill in location and title', true);
        reportSubmitting = false;
        return;
    }
    
    const reporterName = `${state.currentUser.firstName} ${state.currentUser.lastName}`;
    
    const task = {
        id: Date.now().toString(),
        title: title,
        location,
        description: desc,
        urgency: URGENCY_LABELS[urgency],
        urgencyLevel: urgency,
        urgencyCreatedAt: Date.now(),
        status: 'pending',
        assignees: [],
        createdBy: state.currentUser.id,
        reporterName: reporterName,
        date: new Date().toISOString().split('T')[0],
        isReport: true
    };
    
    if (!state.data.tasks) state.data.tasks = [];
    state.data.tasks.push(task);
    
    // Award badge for first report
    const userId = state.currentUser.id;
    const reportCount = state.data.tasks.filter(t => t.createdBy === userId && t.isReport).length;
    if (reportCount === 1) awardBadge(userId, 18); // Problem Spotter
    if (reportCount === 10) awardBadge(userId, 19); // Eagle Eye
    if (reportCount === 25) awardBadge(userId, 20); // Quality Control
    
    saveData();
    closeModal('reportModal');
    showToast('Problem reported!');
    renderAll();
    
    // Reset flag after a delay
    setTimeout(() => { reportSubmitting = false; }, 1000);
}

function openConfirmMaintenance() {
    closeActionSheet();
    $('maintDetailsInput').value = '';
    openModal('confirmMaintModal');
}

function submitMaintConfirmation() {
    const details = $('maintDetailsInput').value.trim();
    if (!details) {
        showToast('Please describe what you did', true);
        return;
    }
    
    // For admin/master, auto-confirm
    if (state.isAdmin || state.isMaster) {
        if (!state.data.maintConfirmations) state.data.maintConfirmations = [];
        state.data.maintConfirmations.push({
            id: Date.now().toString(),
            userId: state.currentUser.id,
            week: getCurrentWeekId(),
            details,
            confirmed: true,
            timestamp: new Date().toISOString()
        });
        saveData();
        closeModal('confirmMaintModal');
        showToast('Maintenance logged!');
        renderAll();
        return;
    }
    
    // For students, add to pending confirmations
    if (!state.data.pendingConfirmations) state.data.pendingConfirmations = [];
    
    const userName = `${state.currentUser.firstName} ${state.currentUser.lastName}`;
    state.data.pendingConfirmations.push({
        id: Date.now().toString(),
        type: 'Weekly Maintenance',
        detail: details,
        userId: state.currentUser.id,
        userName: userName,
        week: getCurrentWeekId(),
        points: 5,
        timestamp: new Date().toISOString()
    });
    
    saveData();
    closeModal('confirmMaintModal');
    showToast('Submitted for approval!');
    renderAll();
}

function approveConfirmation(confirmId) {
    const pending = state.data.pendingConfirmations || [];
    const conf = pending.find(p => p.id === confirmId);
    
    if (conf) {
        addPoints(conf.userId, conf.points || 10, conf.type);
        
        // If it's a weekly maintenance confirmation, add to maintConfirmations
        if (conf.type === 'Weekly Maintenance' && conf.week) {
            if (!state.data.maintConfirmations) state.data.maintConfirmations = [];
            state.data.maintConfirmations.push({
                id: conf.id,
                userId: conf.userId,
                week: conf.week,
                details: conf.detail,
                confirmed: true,
                confirmedBy: state.currentUser.id,
                timestamp: new Date().toISOString()
            });
        }
        
        state.data.pendingConfirmations = pending.filter(p => p.id !== confirmId);
        checkBadges();
        saveData();
        showToast('Confirmed! Points awarded.');
        renderAll();
    }
}

// ============ POINTS & BADGES ============
function addPoints(userId, points, reason) {
    if (!state.data.points) state.data.points = {};
    state.data.points[userId] = (state.data.points[userId] || 0) + points;
}

function checkBadges() {
    const userId = state.currentUser.id;
    if (!state.data.badges) state.data.badges = {};
    if (!state.data.badges[userId]) state.data.badges[userId] = [];
    
    const userBadges = state.data.badges[userId];
    const points = state.data.points?.[userId] || 0;
    const userName = `${state.currentUser.firstName} ${state.currentUser.lastName}`;
    
    const jobCount = state.data.jobs.filter(j => j.crew?.includes(userName)).length;
    const taskCount = state.data.tasks.filter(t => t.status === 'complete' && t.assignees?.includes(userName)).length;
    
    if (jobCount >= 1 && !userBadges.includes(1)) userBadges.push(1);
    if (jobCount >= 5 && !userBadges.includes(2)) userBadges.push(2);
    if (jobCount >= 10 && !userBadges.includes(3)) userBadges.push(3);
    if (jobCount >= 20 && !userBadges.includes(4)) userBadges.push(4);
    if (jobCount >= 50 && !userBadges.includes(5)) userBadges.push(5);
    if (taskCount >= 1 && !userBadges.includes(6)) userBadges.push(6);
    if (taskCount >= 10 && !userBadges.includes(7)) userBadges.push(7);
    if (points >= 100 && !userBadges.includes(10)) userBadges.push(10);
}

function showBadgeDetails(badgeId) {
    const badge = BADGES.find(b => b.id === badgeId);
    if (!badge) return;
    
    state.selectedBadgeId = badgeId;
    
    const userId = state.currentUser.id;
    const earned = state.data.badges?.[userId]?.includes(badgeId);
    
    const earnedBy = [];
    Object.entries(state.data.badges || {}).forEach(([uid, badges]) => {
        if (badges.includes(badgeId)) {
            const user = state.data.users.find(u => u.id === uid);
            if (user) earnedBy.push(`${user.firstName} ${user.lastName}`);
        }
    });
    
    // For master, don't show "haven't earned" message
    let earnedHtml = '';
    if (!state.isMaster) {
        earnedHtml = `<div style="font-size:0.85rem;color:${earned ? 'var(--gold)' : 'var(--text-muted)'};margin-bottom:1rem">
            ${earned ? '‚úì You have earned this badge!' : 'You haven\'t earned this yet'}
        </div>`;
    }
    
    // Show if badge is manual (master-awarded)
    const manualIndicator = badge.master ? '<div style="font-size:0.75rem;color:var(--gold);margin-bottom:0.5rem">‚≠ê Master Award Badge</div>' : '';
    
    $('badgeModalTitle').textContent = `${badge.icon} ${badge.name}`;
    $('badgeModalContent').innerHTML = `
        ${manualIndicator}
        <p style="color:var(--text-secondary);margin-bottom:1rem">${badge.desc}</p>
        ${earnedHtml}
        ${earnedBy.length ? `<div style="font-size:0.8rem;color:var(--text-muted)">Earned by: ${earnedBy.join(', ')}</div>` : ''}
    `;
    
    // Master can award this badge
    let buttons = '<button class="modal-btn gold" onclick="closeModal(\'badgeModal\')">Close</button>';
    if (state.isMaster) {
        buttons = '<button class="modal-btn primary" onclick="openAwardBadgeToStudent()">Award to Student</button>' + buttons;
    }
    $('badgeModalButtons').innerHTML = buttons;
    
    openModal('badgeModal');
}

function openAwardBadgeToStudent() {
    const badge = BADGES.find(b => b.id === state.selectedBadgeId);
    if (!badge) return;
    
    closeModal('badgeModal');
    
    $('awardBadgeToStudentTitle').textContent = `Award: ${badge.icon} ${badge.name}`;
    
    const students = state.data.users.filter(u => u.type === 'student');
    $('awardBadgeToStudent').innerHTML = '<option value="">Select student...</option>' +
        students.map(s => `<option value="${s.id}">${s.firstName} ${s.lastName}</option>`).join('');
    
    openModal('awardBadgeToStudentModal');
}

function confirmAwardBadgeToStudent() {
    const studentId = $('awardBadgeToStudent').value;
    if (!studentId || !state.selectedBadgeId) {
        showToast('Select a student', true);
        return;
    }
    
    awardBadge(studentId, state.selectedBadgeId);
    saveData();
    closeModal('awardBadgeToStudentModal');
    
    const badge = BADGES.find(b => b.id === state.selectedBadgeId);
    const student = state.data.users.find(u => u.id === studentId);
    showToast(`Awarded ${badge?.name} to ${student?.firstName}!`);
    renderAll();
}

function openManagePointsModal() {
    const students = state.data.users.filter(u => u.type === 'student');
    $('managePointsStudent').innerHTML = '<option value="">Select student...</option>' +
        students.map(s => `<option value="${s.id}">${s.firstName} ${s.lastName}</option>`).join('');
    $('managePointsAmount').value = 0;
    $('currentPointsDisplay').textContent = '0';
    openModal('managePointsModal');
}

function updateManagePointsDisplay() {
    const studentId = $('managePointsStudent').value;
    const pts = state.data.points?.[studentId] || 0;
    $('currentPointsDisplay').textContent = pts;
    $('managePointsAmount').value = 0;
}

function adjustPointsBy(amount) {
    const current = parseInt($('managePointsAmount').value) || 0;
    $('managePointsAmount').value = current + amount;
}

function confirmManagePoints() {
    const studentId = $('managePointsStudent').value;
    const amount = parseInt($('managePointsAmount').value) || 0;
    
    if (!studentId) {
        showToast('Select a student', true);
        return;
    }
    
    if (!state.data.points) state.data.points = {};
    const current = state.data.points[studentId] || 0;
    state.data.points[studentId] = Math.max(0, current + amount);
    
    saveData();
    closeModal('managePointsModal');
    showToast(`Points updated: ${current} ‚Üí ${state.data.points[studentId]}`);
    renderAll();
}

function openSpecialAwardModal() {
    const students = state.data.users.filter(u => u.type === 'student');
    $('specialAwardStudent').innerHTML = '<option value="">Select student...</option>' +
        students.map(s => `<option value="${s.id}">${s.firstName} ${s.lastName}</option>`).join('');
    $('specialAwardTitle').value = '';
    $('specialAwardDesc').value = '';
    openModal('specialAwardModal');
}

function confirmSpecialAward() {
    const studentId = $('specialAwardStudent').value;
    const title = $('specialAwardTitle').value.trim();
    const desc = $('specialAwardDesc').value.trim();
    
    if (!studentId || !title) {
        showToast('Select student and enter title', true);
        return;
    }
    
    // Create special award
    if (!state.data.specialAwards) state.data.specialAwards = [];
    const award = {
        id: Date.now(),
        title,
        desc,
        awardedTo: studentId,
        awardedBy: state.currentUser.id,
        date: new Date().toISOString().split('T')[0]
    };
    state.data.specialAwards.push(award);
    
    saveData();
    closeModal('specialAwardModal');
    
    const student = state.data.users.find(u => u.id === studentId);
    showToast(`Special award given to ${student?.firstName}!`);
    renderAll();
}

function savePointsSystem() {
    if (!state.data.pointsSystem) state.data.pointsSystem = {};
    state.data.pointsSystem.signup = parseInt($('ptsSignup').value) || 5;
    state.data.pointsSystem.attendance = parseInt($('ptsAttendance').value) || 10;
    state.data.pointsSystem.maintenance = parseInt($('ptsMaintenance').value) || 5;
    state.data.pointsSystem.task = parseInt($('ptsTask').value) || 10;
    
    saveData();
    showToast('Points system saved!');
}

function loadPointsSystemUI() {
    const pts = state.data?.pointsSystem || { signup: 5, attendance: 10, maintenance: 5, task: 10 };
    if ($('ptsSignup')) $('ptsSignup').value = pts.signup;
    if ($('ptsAttendance')) $('ptsAttendance').value = pts.attendance;
    if ($('ptsMaintenance')) $('ptsMaintenance').value = pts.maintenance;
    if ($('ptsTask')) $('ptsTask').value = pts.task;
}

function openWipeDataModal() {
    $('wipeConfirmPin').value = '';
    openModal('wipeDataModal');
}

async function confirmWipeData() {
    const pin = $('wipeConfirmPin').value.trim();
    
    if (pin !== '9743') {
        showToast('Incorrect Master PIN', true);
        return;
    }
    
    // Preserve users and their basic info
    const users = state.data.users;
    const pointsSystem = state.data.pointsSystem;
    const calendar = state.data.calendar;
    const githubPatEncoded = state.data.githubPatEncoded;
    const tips = state.data.tips;
    
    // Wipe all logged data
    state.data.jobs = [];
    state.data.tasks = [];
    state.data.points = {};
    state.data.badges = {};
    state.data.maintSlots = {};
    state.data.maintConfirmations = [];
    state.data.pendingConfirmations = [];
    state.data.specialAwards = [];
    
    // Restore preserved data
    state.data.users = users;
    state.data.pointsSystem = pointsSystem;
    state.data.calendar = calendar;
    state.data.githubPatEncoded = githubPatEncoded;
    state.data.tips = tips;
    
    const result = await saveData();
    closeModal('wipeDataModal');
    
    if (result.success) {
        showToast('All data wiped successfully!');
    } else {
        showToast('Data wiped locally. Sync: ' + (result.error || 'pending'), true);
    }
    
    renderAll();
}

// ============ UTILITIES ============
function getCurrentWeekId() {
    const now = new Date();
    const start = new Date(now.getFullYear(), 0, 1);
    const week = Math.ceil(((now - start) / 86400000 + start.getDay() + 1) / 7);
    return `${now.getFullYear()}-W${week}`;
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    const day = date.getDate();
    const suffix = day === 1 || day === 21 || day === 31 ? 'st' : day === 2 || day === 22 ? 'nd' : day === 3 || day === 23 ? 'rd' : 'th';
    return `${day}${suffix} ${date.toLocaleDateString('en-NZ', {month:'long', year:'numeric'})}`;
}

function formatTime(timeStr) {
    const [hours, mins] = timeStr.split(':');
    const h = parseInt(hours);
    const ampm = h >= 12 ? 'pm' : 'am';
    const hour12 = h % 12 || 12;
    return mins === '00' ? `${hour12}${ampm}` : `${hour12}:${mins}${ampm}`;
}

function getTermWeekForDate(dateStr) {
    const date = new Date(dateStr);
    const year = date.getFullYear();
    
    // 2026 term dates
    const terms = [
        { term: 1, start: new Date(2026, 0, 26), end: new Date(2026, 3, 3), startWeek: 'B' },
        { term: 2, start: new Date(2026, 3, 20), end: new Date(2026, 6, 3), startWeek: 'B' },
        { term: 3, start: new Date(2026, 6, 20), end: new Date(2026, 8, 25), startWeek: 'A' },
        { term: 4, start: new Date(2026, 9, 12), end: new Date(2026, 11, 11), startWeek: 'A' }
    ];
    
    for (const t of terms) {
        if (date >= t.start && date <= t.end) {
            const weekNum = Math.floor((date - t.start) / (7 * 24 * 60 * 60 * 1000)) + 1;
            const weekType = (weekNum % 2 === 1) === (t.startWeek === 'A') ? 'A' : 'B';
            return `Term ${t.term} Week ${weekNum}(${weekType})`;
        }
    }
    return 'Holiday';
}

function goToPage(pageId) {
    $$('.page').forEach(p => p.classList.remove('active'));
    $(pageId)?.classList.add('active');
    $$('.nav-item').forEach(n => n.classList.remove('active'));
    
    // Update profile if going to profile page
    if (pageId === 'pageProfile') renderProfile();
    if (pageId === 'pageArchive') renderArchive();
}

function renderProfile() {
    if (!state.currentUser) return;
    
    const user = state.currentUser;
    const initials = (user.firstName[0] + user.lastName[0]).toUpperCase();
    const isStudent = user.type === 'student';
    
    $('profileAvatar').textContent = initials;
    $('profileName').textContent = `${user.firstName} ${user.lastName}`;
    $('profileType').textContent = user.type === 'master' ? 'Master Admin' : user.type === 'admin' ? 'Admin' : `Year ${user.year} Student`;
    
    // Hide stats and badges for master and admin
    if (state.isMaster || state.isAdmin) {
        $('profileStatsCard').classList.add('hidden');
        $('profileBadgesCard').classList.add('hidden');
        $('profileHistoryCard')?.classList.add('hidden');
    } else {
        // Student: show stats and ONLY earned badges
        $('profileStatsCard').classList.remove('hidden');
        $('profileBadgesCard').classList.remove('hidden');
        $('profileHistoryCard')?.classList.remove('hidden');
        
        const points = state.data?.points?.[user.id] || 0;
        const badges = state.data?.badges?.[user.id] || [];
        const userName = `${user.firstName} ${user.lastName}`;
        const eventsCompleted = (state.data?.jobs || []).filter(j => j.status === 'completed' && j.attendees?.includes(userName)).length;
        const tasksCompleted = (state.data?.tasks || []).filter(t => t.status === 'complete' && t.assignees?.includes(userName)).length;
        const maintSlot = state.data?.maintSlots?.[user.id] || 'Not set';
        
        // Calculate weekly streak
        const weeklyStreak = calculateWeeklyStreak(user.id);
        
        $('profilePoints').textContent = points;
        $('profileBadges').textContent = badges.length;
        $('profileEvents').textContent = eventsCompleted;
        $('profileTasks').textContent = tasksCompleted;
        $('profileStreak').textContent = weeklyStreak + ' week' + (weeklyStreak !== 1 ? 's' : '');
        $('profileMaintSlot').textContent = maintSlot;
        
        // Student: only show earned badges + special awards
        let badgeHtml = '';
        
        // Regular badges
        if (badges.length) {
            badges.forEach(badgeId => {
                const badge = BADGES.find(b => b.id === badgeId);
                if (badge) {
                    badgeHtml += `
                        <div class="badge-item earned" onclick="showBadgeDetails(${badge.id})">
                            <div class="badge-icon">${badge.icon}</div>
                            <div class="badge-name">${badge.name}</div>
                        </div>
                    `;
                }
            });
        }
        
        // Special awards
        const specialAwards = (state.data?.specialAwards || []).filter(a => a.awardedTo === user.id);
        specialAwards.forEach(award => {
            badgeHtml += `
                <div class="badge-item earned special-award" onclick="showSpecialAwardDetails('${award.id}')">
                    <div class="badge-icon"><img src="masteraward.png" style="width:32px;height:32px" onerror="this.textContent='‚≠ê'"></div>
                    <div class="badge-name">${award.title}</div>
                </div>
            `;
        });
        
        if (!badges.length && !specialAwards.length) {
            badgeHtml = '<div style="color:var(--text-muted);text-align:center;padding:1rem">No badges earned yet</div>';
        }
        $('profileBadgeGrid').innerHTML = badgeHtml;
    }
}

function calculateWeeklyStreak(userId) {
    const confirmations = state.data?.maintConfirmations || [];
    const userConfirms = confirmations.filter(c => c.userId === userId).map(c => c.weekId).sort().reverse();
    
    if (!userConfirms.length) return 0;
    
    // Get current week ID
    const now = new Date();
    const start = new Date(now.getFullYear(), 0, 1);
    const currentWeek = Math.ceil(((now - start) / 86400000 + start.getDay() + 1) / 7);
    const currentYear = now.getFullYear();
    
    let streak = 0;
    let checkWeek = currentWeek;
    let checkYear = currentYear;
    
    for (let i = 0; i < 52; i++) {
        const weekId = `${checkYear}-W${checkWeek}`;
        if (userConfirms.includes(weekId)) {
            streak++;
            checkWeek--;
            if (checkWeek <= 0) {
                checkYear--;
                checkWeek = 52;
            }
        } else {
            break;
        }
    }
    
    return streak;
}

function openMyHistory() {
    const user = state.currentUser;
    const userName = `${user.firstName} ${user.lastName}`;
    
    let html = '';
    
    // Completed events
    const completedEvents = (state.data?.jobs || []).filter(j => j.status === 'completed' && j.attendees?.includes(userName));
    html += '<div style="font-weight:700;color:var(--gold);margin-bottom:0.5rem">üé™ Completed Events (' + completedEvents.length + ')</div>';
    if (completedEvents.length) {
        completedEvents.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(job => {
            const role = job.crewRoles?.[userName] || 'Crew';
            html += `<div style="padding:0.5rem;background:var(--bg-input);border-radius:8px;margin-bottom:0.5rem">
                <div style="font-weight:600">${job.title}</div>
                <div style="font-size:0.8rem;color:var(--text-muted)">${formatDate(job.date)} ¬∑ ${role}</div>
            </div>`;
        });
    } else {
        html += '<div style="color:var(--text-muted);padding:0.5rem">No completed events yet</div>';
    }
    
    // Completed tasks
    const completedTasks = (state.data?.tasks || []).filter(t => t.status === 'complete' && t.assignees?.includes(userName));
    html += '<div style="font-weight:700;color:var(--gold);margin:1rem 0 0.5rem">üîß Completed Tasks (' + completedTasks.length + ')</div>';
    if (completedTasks.length) {
        completedTasks.forEach(task => {
            html += `<div style="padding:0.5rem;background:var(--bg-input);border-radius:8px;margin-bottom:0.5rem">
                <div style="font-weight:600">${task.title}</div>
                <div style="font-size:0.8rem;color:var(--text-muted)">üìç ${task.location}</div>
            </div>`;
        });
    } else {
        html += '<div style="color:var(--text-muted);padding:0.5rem">No completed tasks yet</div>';
    }
    
    // Weekly maintenance logs
    const maintLogs = (state.data?.maintConfirmations || []).filter(c => c.userId === user.id);
    html += '<div style="font-weight:700;color:var(--gold);margin:1rem 0 0.5rem">üìÖ Weekly Maintenance Logs (' + maintLogs.length + ')</div>';
    if (maintLogs.length) {
        maintLogs.sort((a,b) => b.weekId.localeCompare(a.weekId)).forEach(log => {
            html += `<div style="padding:0.5rem;background:var(--bg-input);border-radius:8px;margin-bottom:0.5rem">
                <div style="font-weight:600">${log.weekId}</div>
                <div style="font-size:0.8rem;color:var(--text-muted)">${log.details || 'Confirmed'}</div>
            </div>`;
        });
    } else {
        html += '<div style="color:var(--text-muted);padding:0.5rem">No maintenance logs yet</div>';
    }
    
    $('myHistoryContent').innerHTML = html;
    openModal('myHistoryModal');
}

function showSpecialAwardDetails(awardId) {
    const award = state.data.specialAwards?.find(a => a.id == awardId);
    if (!award) return;
    
    const awardedBy = state.data.users.find(u => u.id === award.awardedBy);
    
    $('badgeModalTitle').textContent = `‚≠ê ${award.title}`;
    $('badgeModalContent').innerHTML = `
        <div style="margin-bottom:1rem"><img src="masteraward.png" style="width:64px;height:64px" onerror="this.textContent='‚≠ê'"></div>
        <p style="color:var(--text-secondary);margin-bottom:1rem">${award.desc || 'Special recognition award'}</p>
        <div style="font-size:0.8rem;color:var(--text-muted)">Awarded by ${awardedBy ? awardedBy.firstName + ' ' + awardedBy.lastName : 'Admin'} on ${formatDate(award.date)}</div>
    `;
    $('badgeModalButtons').innerHTML = '<button class="modal-btn gold" onclick="closeModal(\'badgeModal\')">Close</button>';
    openModal('badgeModal');
}

function renderArchive() {
    // Completed events
    const completedJobs = (state.data?.jobs || []).filter(j => j.status === 'completed').sort((a,b) => new Date(b.date) - new Date(a.date));
    
    if (completedJobs.length) {
        $('archivedEventsList').innerHTML = completedJobs.map(job => `
            <div class="job-item ${job.category}" onclick="openArchivedJobDetails('${job.id}')">
                <div class="job-header">
                    <span class="job-title">${job.title}</span>
                    <span class="job-category">‚úì ${job.category}</span>
                </div>
                <div class="job-meta">üìÖ ${formatDate(job.date)} ¬∑ ${job.attendees?.length || 0} attended</div>
            </div>
        `).join('');
    } else {
        $('archivedEventsList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÅ</div><div class="empty-state-text">No archived events</div></div>';
    }
    
    // Completed tasks
    const completedTasks = (state.data?.tasks || []).filter(t => t.status === 'complete').sort((a,b) => new Date(b.date || 0) - new Date(a.date || 0));
    
    if (completedTasks.length) {
        $('archivedTasksList').innerHTML = completedTasks.map(task => `
            <div class="task-item" style="opacity:0.8" onclick="openArchivedTaskDetails('${task.id}')">
                <div class="task-header">
                    <span class="task-title">${task.title}</span>
                    <span class="task-status complete">Complete</span>
                </div>
                <div class="task-meta">üìç ${task.location}${task.assignees?.length ? ' ¬∑ üë• ' + task.assignees.join(', ') : ''}</div>
            </div>
        `).join('');
    } else {
        $('archivedTasksList').innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:1rem">No completed tasks</div>';
    }
}

function openArchivedJobDetails(jobId) {
    const job = state.data.jobs.find(j => j.id === jobId);
    if (!job) return;
    
    state.selectedJob = job;
    $('jobModalTitle').textContent = job.title + ' (Archived)';
    
    let html = `
        <div class="event-detail"><div class="event-detail-label">Category</div><div class="event-detail-value">${job.category}</div></div>
        <div class="event-detail"><div class="event-detail-label">Date & Time</div><div class="event-detail-value">${formatDate(job.date)} at ${formatTime(job.time)}</div></div>
        <div class="event-detail"><div class="event-detail-label">Location</div><div class="event-detail-value">${job.location}</div></div>
    `;
    
    if (job.description) {
        html += `<div class="event-detail"><div class="event-detail-label">Description</div><div class="event-detail-value">${job.description}</div></div>`;
    }
    
    if (job.gearList?.length) {
        html += `<div class="event-detail"><div class="event-detail-label">Gear</div><div class="event-detail-value">${job.gearList.map(g => '‚Ä¢ '+g).join('<br>')}</div></div>`;
    }
    
    if (job.requirements?.length) {
        html += `<div class="event-detail"><div class="event-detail-label">Requirements</div><div class="event-detail-value">${job.requirements.join(', ')}</div></div>`;
    }
    
    if (job.attendees?.length) {
        html += `<div class="event-detail"><div class="event-detail-label">Attendees</div><div class="crew-list">`;
        job.attendees.forEach(name => {
            const role = job.crewRoles?.[name] || '';
            html += `<span class="crew-chip">${name}${role ? ' (' + role + ')' : ''}</span>`;
        });
        html += `</div></div>`;
    }
    
    $('jobModalContent').innerHTML = html;
    $('jobSignupBtn').classList.add('hidden');
    openModal('jobModal');
}

function openArchivedTaskDetails(taskId) {
    const task = state.data.tasks.find(t => t.id === taskId);
    if (!task) return;
    
    let html = `
        <div class="event-detail"><div class="event-detail-label">Location</div><div class="event-detail-value">${task.location}</div></div>
        <div class="event-detail"><div class="event-detail-label">Status</div><div class="event-detail-value">Complete</div></div>
    `;
    
    if (task.description) {
        html += `<div class="event-detail"><div class="event-detail-label">Description</div><div class="event-detail-value">${task.description}</div></div>`;
    }
    
    if (task.reporterName) {
        html += `<div class="event-detail"><div class="event-detail-label">Reported by</div><div class="event-detail-value">${task.reporterName}</div></div>`;
    }
    
    if (task.urgency) {
        html += `<div class="event-detail"><div class="event-detail-label">Urgency</div><div class="event-detail-value">${task.urgency}</div></div>`;
    }
    
    if (task.assignees?.length) {
        html += `<div class="event-detail"><div class="event-detail-label">Completed by</div><div class="event-detail-value">${task.assignees.join(', ')}</div></div>`;
    }
    
    if (task.completionNote) {
        html += `<div class="event-detail"><div class="event-detail-label">Completion Note</div><div class="event-detail-value">${task.completionNote}</div></div>`;
    }
    
    $('taskModalTitle').textContent = task.title + ' (Archived)';
    $('taskModalContent').innerHTML = html;
    $('taskModalButtons').innerHTML = '<button class="modal-btn gold" onclick="closeModal(\'taskModal\')">Close</button>';
    openModal('taskModal');
}

function showToast(message, isError = false) {
    const toast = $('toast');
    toast.textContent = message;
    toast.className = 'toast' + (isError ? ' error' : '');
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
}

// ============ GITHUB PAT ============
async function saveGitHubPat() {
    const pat = $('patInput').value.trim();
    if (!pat) {
        showToast('Please enter a token', true);
        return;
    }
    
    // Store locally (plain text for actual use)
    localStorage.setItem('github_pat', pat);
    
    // Encode for storage in data.json (bypasses GitHub secret scanning)
    const encodedPat = encodePat(pat);
    
    // Also save to data so it syncs to all devices
    if (state.data) {
        state.data.githubPatEncoded = encodedPat;
        delete state.data.githubPat; // Remove old plain text version if exists
        
        // Wait for save to complete
        const result = await saveData();
        
        if (result.success) {
            showToast('‚úÖ Token saved and synced! All devices will now work.');
            $('patInput').value = '';
        } else {
            showToast('‚ùå Sync failed: ' + result.error, true);
            console.error('PAT save failed:', result.error);
        }
    } else {
        showToast('Token saved locally only.');
    }
    
    updateSyncStatus();
}

async function updateSyncStatus() {
    const pat = CONFIG.PAT;
    if (!pat) {
        $('syncStatusText').textContent = 'No token set';
        $('syncStatusText').style.color = 'var(--text-muted)';
        return;
    }
    try {
        const res = await fetch(`https://api.github.com/repos/${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}`, {
            headers: { 'Authorization': `token ${pat}` }
        });
        if (res.ok) {
            $('syncStatusText').textContent = 'Connected ‚úì';
            $('syncStatusText').style.color = 'var(--gold)';
        } else {
            $('syncStatusText').textContent = 'Invalid token';
            $('syncStatusText').style.color = 'var(--danger)';
        }
    } catch (e) {
        $('syncStatusText').textContent = 'Connection error';
        $('syncStatusText').style.color = 'var(--danger)';
    }
}

// ============ AWARD POINTS/BADGES (Master) ============
function openAwardPointsModal() {
    const students = state.data.users.filter(u => u.type === 'student');
    $('awardPointsStudent').innerHTML = students.map(s => 
        `<option value="${s.id}">${s.firstName} ${s.lastName}</option>`
    ).join('');
    $('awardPointsAmount').value = 10;
    $('awardPointsReason').value = '';
    openModal('awardPointsModal');
}

function confirmAwardPoints() {
    const studentId = $('awardPointsStudent').value;
    const amount = parseInt($('awardPointsAmount').value) || 0;
    const reason = $('awardPointsReason').value.trim();
    
    if (!studentId || amount < 1) {
        showToast('Please select student and amount', true);
        return;
    }
    
    addPoints(studentId, amount, reason || 'Manual award');
    checkBadges();
    saveData();
    closeModal('awardPointsModal');
    showToast(`Awarded ${amount} points!`);
    renderAll();
}

function openAwardBadgeModal() {
    const students = state.data.users.filter(u => u.type === 'student');
    $('awardBadgeStudent').innerHTML = students.map(s => 
        `<option value="${s.id}">${s.firstName} ${s.lastName}</option>`
    ).join('');
    $('awardBadgeSelect').innerHTML = BADGES.map(b => 
        `<option value="${b.id}">${b.icon} ${b.name}</option>`
    ).join('');
    openModal('awardBadgeModal');
}

function confirmAwardBadge() {
    const studentId = $('awardBadgeStudent').value;
    const badgeId = parseInt($('awardBadgeSelect').value);
    
    if (!studentId || !badgeId) {
        showToast('Please select student and badge', true);
        return;
    }
    
    if (!state.data.badges) state.data.badges = {};
    if (!state.data.badges[studentId]) state.data.badges[studentId] = [];
    
    if (!state.data.badges[studentId].includes(badgeId)) {
        state.data.badges[studentId].push(badgeId);
        saveData();
        closeModal('awardBadgeModal');
        const badge = BADGES.find(b => b.id === badgeId);
        showToast(`Awarded ${badge.name} badge!`);
        renderAll();
    } else {
        showToast('Student already has this badge', true);
    }
}

// ============ MANAGE CREW (Admin) ============
function openManageCrewModal(jobId) {
    const job = state.data.jobs.find(j => j.id === jobId);
    if (!job) return;
    
    state.selectedJob = job;
    renderCurrentCrew();
    
    // Populate add student dropdown (exclude already in crew)
    const students = state.data.users.filter(u => u.type === 'student');
    const crewNames = job.crew || [];
    const available = students.filter(s => !crewNames.includes(`${s.firstName} ${s.lastName}`));
    
    $('addCrewStudent').innerHTML = available.length 
        ? available.map(s => `<option value="${s.id}">${s.firstName} ${s.lastName}</option>`).join('')
        : '<option value="">All students already in crew</option>';
    
    openModal('manageCrewModal');
}

function renderCurrentCrew() {
    const job = state.selectedJob;
    if (!job || !job.crew?.length) {
        $('currentCrewList').innerHTML = '<div style="color:var(--text-muted);padding:0.5rem">No crew members yet</div>';
        return;
    }
    
    // Build role options from job.roles plus any custom roles
    const allRoles = job.roles || ['Lighting', 'Sound', 'Stage', 'AV'];
    
    $('currentCrewList').innerHTML = job.crew.map((name, i) => {
        const prefs = job.crewPrefs?.[name]?.roles || [];
        const currentRole = job.crewRoles?.[name] || '';
        const prefsText = prefs.length ? `<div style="font-size:0.7rem;color:var(--text-muted)">Prefers: ${prefs.join(', ')}</div>` : '';
        
        return `
        <div style="padding:0.75rem;background:var(--bg-input);border-radius:8px;margin-bottom:0.5rem">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem">
                <span style="font-weight:600">${name}</span>
                <button onclick="removeFromCrew('${name}')" style="color:var(--danger);min-height:28px;min-width:28px;font-size:0.9rem">‚úï</button>
            </div>
            ${prefsText}
            <div style="display:flex;align-items:center;gap:0.5rem;margin-top:0.5rem">
                <label style="font-size:0.8rem;color:var(--text-secondary)">Role:</label>
                <select class="modal-input modal-select" style="flex:1;min-height:36px" id="crewRole${i}" data-name="${name}">
                    <option value="">Not assigned</option>
                    ${allRoles.map(r => `<option value="${r}" ${currentRole === r ? 'selected' : ''}>${r}</option>`).join('')}
                    <option value="custom">Custom...</option>
                </select>
            </div>
        </div>
        `;
    }).join('');
}

function saveCrewRoles() {
    const job = state.selectedJob;
    if (!job) return;
    
    if (!job.crewRoles) job.crewRoles = {};
    
    job.crew.forEach((name, i) => {
        const select = $(`crewRole${i}`);
        if (select) {
            const value = select.value;
            if (value === 'custom') {
                const customRole = prompt('Enter custom role:');
                if (customRole) job.crewRoles[name] = customRole;
            } else if (value) {
                job.crewRoles[name] = value;
            } else {
                delete job.crewRoles[name];
            }
        }
    });
    
    saveData();
    showToast('Roles saved!');
    renderAll();
}

function addStudentToCrew() {
    const studentId = $('addCrewStudent').value;
    if (!studentId) return;
    
    const student = state.data.users.find(u => u.id === studentId);
    if (!student) return;
    
    const name = `${student.firstName} ${student.lastName}`;
    if (!state.selectedJob.crew) state.selectedJob.crew = [];
    if (!state.selectedJob.crew.includes(name)) {
        state.selectedJob.crew.push(name);
        saveData();
        showToast(`Added ${student.firstName} to crew`);
        openManageCrewModal(state.selectedJob.id); // Refresh
        renderAll();
    }
}

function removeFromCrew(name) {
    if (!state.selectedJob) return;
    state.selectedJob.crew = state.selectedJob.crew.filter(n => n !== name);
    saveData();
    showToast('Removed from crew');
    renderCurrentCrew();
    renderAll();
}

// ============ COMPLETE EVENT (Admin) ============
function openCompleteEventModal(jobId) {
    const job = state.data.jobs.find(j => j.id === jobId);
    if (!job) return;
    
    state.selectedJob = job;
    $('completeEventName').textContent = job.title;
    
    // Attendance checkboxes
    const crew = job.crew || [];
    $('attendanceList').innerHTML = crew.length ? crew.map((name, i) => `
        <div class="checkbox-item">
            <input type="checkbox" id="attend${i}" checked data-name="${name}">
            <label for="attend${i}">${name}</label>
        </div>
    `).join('') : '<div style="color:var(--text-muted)">No crew signed up</div>';
    
    // Role assignments
    const roles = job.roles || [];
    if (roles.length && crew.length) {
        $('roleAssignmentList').innerHTML = crew.map((name, i) => `
            <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem">
                <span style="flex:1">${name}</span>
                <select class="modal-input modal-select" style="flex:1" id="role${i}" data-name="${name}">
                    <option value="">No role</option>
                    ${roles.map(r => `<option value="${r}">${r}</option>`).join('')}
                </select>
            </div>
        `).join('');
    } else {
        $('roleAssignmentList').innerHTML = '<div style="color:var(--text-muted)">No roles defined for this event</div>';
    }
    
    openModal('completeEventModal');
}

function confirmCompleteEvent() {
    const job = state.selectedJob;
    if (!job) return;
    
    // Get attended students
    const attendees = [];
    const roleAssignments = {};
    
    $$('#attendanceList input[type="checkbox"]').forEach(cb => {
        if (cb.checked) {
            attendees.push(cb.dataset.name);
        }
    });
    
    $$('#roleAssignmentList select').forEach(sel => {
        if (sel.value) {
            roleAssignments[sel.dataset.name] = sel.value;
        }
    });
    
    // Award points to attendees
    const users = state.data.users;
    attendees.forEach(name => {
        const user = users.find(u => `${u.firstName} ${u.lastName}` === name);
        if (user) {
            addPoints(user.id, 10, `Attended: ${job.title}`);
            
            // Check for role-specific badges
            const role = roleAssignments[name];
            if (role) {
                if (!state.data.badges) state.data.badges = {};
                if (!state.data.badges[user.id]) state.data.badges[user.id] = [];
                
                if (role === 'Lighting' && !state.data.badges[user.id].includes(12)) state.data.badges[user.id].push(12);
                if (role === 'Sound' && !state.data.badges[user.id].includes(13)) state.data.badges[user.id].push(13);
                if (role === 'AV' && !state.data.badges[user.id].includes(14)) state.data.badges[user.id].push(14);
                if (role === 'Stage' && !state.data.badges[user.id].includes(15)) state.data.badges[user.id].push(15);
            }
        }
    });
    
    // Mark job as completed
    job.status = 'completed';
    job.attendees = attendees;
    job.crewRoles = roleAssignments;
    
    checkBadges();
    saveData();
    closeModal('completeEventModal');
    showToast(`Event completed! ${attendees.length} students awarded points.`);
    renderAll();
}

// ============ MAINTENANCE CONFIRMATION (Admin) ============
function openAdminConfirmMaint(taskId) {
    const task = state.data.tasks.find(t => t.id === taskId);
    if (!task) return;
    
    state.selectedTask = task;
    $('confirmMaintTaskName').textContent = task.title;
    
    const assignees = task.assignees || [];
    $('maintAttendanceList').innerHTML = assignees.length ? assignees.map((name, i) => `
        <div class="checkbox-item">
            <input type="checkbox" id="maintAttend${i}" checked data-name="${name}">
            <label for="maintAttend${i}">${name}</label>
        </div>
    `).join('') : '<div style="color:var(--text-muted)">No students assigned</div>';
    
    openModal('adminConfirmMaintModal');
}

function confirmMaintComplete() {
    const task = state.selectedTask;
    if (!task) return;
    
    const attendees = [];
    $$('#maintAttendanceList input[type="checkbox"]').forEach(cb => {
        if (cb.checked) attendees.push(cb.dataset.name);
    });
    
    // Award points
    const users = state.data.users;
    attendees.forEach(name => {
        const user = users.find(u => `${u.firstName} ${u.lastName}` === name);
        if (user) {
            addPoints(user.id, 10, `Maintenance: ${task.title}`);
        }
    });
    
    task.status = 'complete';
    task.confirmedBy = state.currentUser.id;
    
    checkBadges();
    saveData();
    closeModal('adminConfirmMaintModal');
    showToast(`Task completed! ${attendees.length} students awarded points.`);
    renderAll();
}

// ============ EVENT LISTENERS ============

// PIN keypad
$$('.pin-key').forEach(key => {
    key.addEventListener('click', () => {
        const k = key.dataset.key;
        if (k) handlePinKey(k);
    });
});

// Navigation
$$('.nav-item').forEach(btn => {
    btn.addEventListener('click', () => {
        const page = btn.dataset.page;
        if (!page) return;
        
        $$('.nav-item').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        $$('.page').forEach(p => p.classList.remove('active'));
        $(page).classList.add('active');
    });
});

// Calendar navigation
$('prevMonth').addEventListener('click', () => {
    state.calendarMonth.setMonth(state.calendarMonth.getMonth() - 1);
    renderCalendar();
});

$('nextMonth').addEventListener('click', () => {
    state.calendarMonth.setMonth(state.calendarMonth.getMonth() + 1);
    renderCalendar();
});

// Calendar view toggle
$$('.calendar-toggle button').forEach(btn => {
    btn.addEventListener('click', () => {
        $$('.calendar-toggle button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.calendarView = btn.dataset.view;
        
        if (state.calendarView === 'events') {
            $('calendarEvents').classList.remove('hidden');
            $('calendarMaintenance').classList.add('hidden');
        } else {
            $('calendarEvents').classList.add('hidden');
            $('calendarMaintenance').classList.remove('hidden');
        }
    });
});

// Action sheet backdrop
$('actionSheet')?.addEventListener('click', e => {
    if (e.target === $('actionSheet')) closeActionSheet();
});

// Modal backdrops
$$('.modal-overlay').forEach(modal => {
    modal.addEventListener('click', e => {
        if (e.target === modal) closeModal(modal.id);
    });
});

// ============ INIT ============
// Register Service Worker for PWA
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(err => console.log('SW registration failed'));
}

async function init() {
    // Always try to load fresh data from GitHub first
    try {
        const res = await fetch(`https://api.github.com/repos/${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}/contents/${CONFIG.DATA_FILE}`, {
            cache: 'no-store'
        });
        if (res.ok) {
            const file = await res.json();
            state.sha = file.sha;
            state.data = JSON.parse(atob(file.content));
            // Decode and store PAT locally
            if (state.data.githubPatEncoded) {
                const decodedPat = decodePat(state.data.githubPatEncoded);
                if (decodedPat) {
                    localStorage.setItem('github_pat', decodedPat);
                }
            }
            localStorage.setItem('techcrew_data', JSON.stringify(state.data));
            console.log('Loaded fresh data from GitHub');
        } else {
            // Fallback to localStorage
            const savedData = localStorage.getItem('techcrew_data');
            state.data = savedData ? JSON.parse(savedData) : JSON.parse(JSON.stringify(DEFAULT_DATA));
            console.log('Using localStorage data (GitHub fetch failed)');
        }
    } catch (e) {
        console.error('Init load error:', e);
        const savedData = localStorage.getItem('techcrew_data');
        state.data = savedData ? JSON.parse(savedData) : JSON.parse(JSON.stringify(DEFAULT_DATA));
    }
    
    // Check for saved login
    const savedUser = localStorage.getItem('techcrew_user');
    const savedAdmin = localStorage.getItem('techcrew_admin');
    const savedMaster = localStorage.getItem('techcrew_master');
    
    if (savedUser) {
        state.currentUser = JSON.parse(savedUser);
        state.isAdmin = savedAdmin === 'true';
        state.isMaster = savedMaster === 'true';
        
        const userExists = state.data.users.some(u => u.id === state.currentUser.id);
        if (userExists) {
            enterApp();
            return;
        }
    }
    
    $('loginScreen').classList.remove('hidden');
}

init();
</script>
</body>
</html>